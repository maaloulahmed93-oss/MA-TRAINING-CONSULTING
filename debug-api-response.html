<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug API Response - MATC</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 5px; margin: 10px 0; }
        button { padding: 12px 20px; margin: 10px 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; font-size: 11px; overflow-x: auto; max-height: 400px; }
        .critical { background: #ff6b6b; color: white; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug API Response - MATC</h1>
        
        <div class="error">
            <h3>‚ùå Probl√®me identifi√© dans Console</h3>
            <p><strong>Log:</strong> "‚ÑπÔ∏è No notifications found for participant"</p>
            <p><strong>Cause:</strong> API retourne participant data mais sans notifications</p>
        </div>

        <div class="info">
            <h4>üéØ Objectif:</h4>
            <p>Analyser exactement ce que retourne l'API pour comprendre pourquoi les notifications sont vides</p>
        </div>

        <button onclick="debugAPIResponse()" class="critical">üö® DEBUG API RESPONSE</button>
        <button onclick="testBothAPIs()">üîç Test Both APIs</button>
        <button onclick="checkBackendLogs()">üìã Check Backend Logic</button>

        <div id="results"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            results.appendChild(div);
            console.log(message);
        }

        async function debugAPIResponse() {
            log('üö® DEBUG API RESPONSE D√âTAILL√â...', 'error');
            
            try {
                log('üìã Test GET /api/participants/PART-550776', 'info');
                const response = await fetch('http://localhost:3001/api/participants/PART-550776');
                
                log(`üìä Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`üìä Response Headers: ${response.headers.get('content-type')}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    log('üìã Response Structure Analysis:', 'info');
                    log(`- success: ${data.success}`, 'info');
                    log(`- data exists: ${!!data.data}`, 'info');
                    
                    if (data.data) {
                        const participant = data.data;
                        log('üìä Participant Data Analysis:', 'info');
                        log(`- fullName: ${participant.fullName}`, 'info');
                        log(`- email: ${participant.email}`, 'info');
                        log(`- formations: ${participant.formations?.length || 0}`, 'info');
                        log(`- projects: ${participant.projects?.length || 0}`, 'info');
                        log(`- coachingResources: ${participant.coachingResources?.length || 0}`, 'info');
                        log(`- notifications: ${participant.notifications?.length || 0}`, 
                            participant.notifications?.length > 0 ? 'success' : 'error');
                        
                        log('üîç Notifications Field Analysis:', 'warning');
                        log(`- notifications field exists: ${participant.hasOwnProperty('notifications')}`, 'info');
                        log(`- notifications type: ${typeof participant.notifications}`, 'info');
                        log(`- notifications is array: ${Array.isArray(participant.notifications)}`, 'info');
                        
                        if (participant.notifications) {
                            if (Array.isArray(participant.notifications)) {
                                if (participant.notifications.length === 0) {
                                    log('‚ùå PROBL√àME: notifications array is EMPTY!', 'error');
                                    log('üí° Cela explique pourquoi "No notifications found"', 'warning');
                                } else {
                                    log(`‚úÖ ${participant.notifications.length} notifications found!`, 'success');
                                    log(`<pre>Notifications:
${JSON.stringify(participant.notifications, null, 2)}</pre>`, 'success');
                                }
                            } else {
                                log('‚ùå PROBL√àME: notifications is not an array!', 'error');
                                log(`Value: ${JSON.stringify(participant.notifications)}`, 'error');
                            }
                        } else {
                            log('‚ùå PROBL√àME: notifications field is null/undefined!', 'error');
                        }
                        
                        log(`<pre>Complete Participant Data:
${JSON.stringify(participant, null, 2)}</pre>`, 'info');
                    } else {
                        log('‚ùå No participant data in response!', 'error');
                    }
                } else {
                    log(`‚ùå API Error: ${response.status}`, 'error');
                    const errorText = await response.text();
                    log(`Error details: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Request Error: ${error.message}`, 'error');
            }
        }

        async function testBothAPIs() {
            log('üîç Test des deux APIs...', 'info');
            
            // Test 1: Participant API
            log('üìã Test 1: GET /api/participants/PART-550776', 'info');
            try {
                const response1 = await fetch('http://localhost:3001/api/participants/PART-550776');
                if (response1.ok) {
                    const data1 = await response1.json();
                    const notifications1 = data1.data?.notifications;
                    log(`‚úÖ Participant API: ${notifications1?.length || 0} notifications`, 
                        notifications1?.length > 0 ? 'success' : 'error');
                } else {
                    log(`‚ùå Participant API error: ${response1.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Participant API error: ${error.message}`, 'error');
            }
            
            // Test 2: Notifications API
            log('üìã Test 2: GET /api/participants/PART-550776/notifications', 'info');
            try {
                const response2 = await fetch('http://localhost:3001/api/participants/PART-550776/notifications');
                if (response2.ok) {
                    const data2 = await response2.json();
                    const notifications2 = data2.data;
                    log(`‚úÖ Notifications API: ${notifications2?.length || 0} notifications`, 
                        notifications2?.length > 0 ? 'success' : 'error');
                    
                    if (notifications2?.length > 0) {
                        log(`<pre>Notifications API Data:
${JSON.stringify(notifications2, null, 2)}</pre>`, 'success');
                    }
                } else {
                    log(`‚ùå Notifications API error: ${response2.status}`, 'error');
                    const errorText = await response2.text();
                    log(`Error details: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Notifications API error: ${error.message}`, 'error');
            }
            
            log('üìä Comparison Analysis:', 'warning');
            log('Si Participant API retourne 0 notifications ET Notifications API retourne 0:', 'info');
            log('  ‚Üí Le probl√®me est dans le backend (donn√©es pas sauvegard√©es)', 'info');
            log('Si Participant API retourne 0 notifications MAIS Notifications API retourne >0:', 'info');
            log('  ‚Üí Le probl√®me est dans GET participant endpoint', 'info');
            log('Si les deux retournent >0 notifications:', 'info');
            log('  ‚Üí Le probl√®me est dans le frontend component', 'info');
        }

        async function checkBackendLogs() {
            log('üìã V√©rification de la logique Backend...', 'info');
            
            log('üîç Points √† v√©rifier dans le backend:', 'warning');
            log('1. Le serveur backend a-t-il √©t√© red√©marr√© apr√®s les modifications?', 'info');
            log('2. Les logs backend montrent-ils "Found X notifications for PART-550776"?', 'info');
            log('3. MongoDB contient-il des documents ParticipantNotification?', 'info');
            log('4. Le code GET participant charge-t-il vraiment les notifications?', 'info');
            
            log('üìã Code √† v√©rifier dans participants.js:', 'warning');
            log('Ligne ~222: const [formations, projects, resources, notifications] = await Promise.all([', 'info');
            log('Ligne ~226: ParticipantNotification.find({ participantId: id, isActive: true })', 'info');
            log('Ligne ~179: notifications, (pas notifications: [])', 'info');
            
            log('üß™ Test pour d√©clencher les logs backend:', 'info');
            await debugAPIResponse();
        }

        // Auto-run debug
        window.onload = function() {
            setTimeout(() => {
                log('üîÑ Chargement...', 'info');
                log('üéØ Console logs montrent: "No notifications found for participant"', 'error');
                log('üìã Cela signifie que l\'API retourne participant sans notifications', 'warning');
                log('üö® Lancement du debug API...', 'info');
                debugAPIResponse();
            }, 1000);
        };
    </script>
</body>
</html>
