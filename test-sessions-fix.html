<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 إصلاح مشكلة Sessions تختفي</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        .success { background: #d4edda; padding: 15px; border-radius: 5px; color: #155724; margin: 10px 0; }
        .info { background: #d1ecf1; padding: 15px; border-radius: 5px; color: #0c5460; margin: 10px 0; }
        .fix { background: #e7f3ff; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff; margin: 10px 0; }
        .console { background: #1a1a1a; color: #00ff00; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; margin: 10px 0; }
        .code { background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; overflow-x: auto; }
        .step { background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 إصلاح مشكلة Sessions تختفي</h1>
        
        <div class="success">
            <h3>✅ تم إصلاح مشكلة Sessions!</h3>
            <p><strong>المشكلة:</strong> Sessions تضاف لكن تختفي عند إعادة فتح Modal</p>
            <p><strong>الحل:</strong> مزامنة البيانات بين <code>courseSessions</code> و <code>formations.courses[].sessions</code></p>
        </div>

        <div class="fix">
            <h3>🔧 الإصلاحات المطبقة:</h3>
            
            <h4>1. إصلاح addSession Function:</h4>
            <div class="code">
// قبل الإصلاح ❌ - يحفظ في courseSessions فقط
const addSession = () => {
  setCourseSessions(prev => ({
    ...prev,
    [courseKey]: [...prev[courseKey] || [], newSessionObject]
  }));
  // لا يحفظ في formations.courses[].sessions ❌
};

// بعد الإصلاح ✅ - يحفظ في كلا المكانين
const addSession = () => {
  // Update courseSessions for UI display
  setCourseSessions(prev => ({...}));
  
  // Also update the formations array to persist the session ✅
  setFormations(prev => {
    const updated = prev.map(formation => {
      if (formation.title === selectedFormation) {
        const updatedCourses = formation.courses.map(course => {
          if (course.title === selectedCourse) {
            return {
              ...course,
              sessions: [...(course.sessions || []), newSessionObject]
            };
          }
          return course;
        });
        return { ...formation, courses: updatedCourses };
      }
      return formation;
    });
    return updated;
  });
};
            </div>

            <h4>2. إصلاح openSessionModal Function:</h4>
            <div class="code">
// الآن يزامن البيانات عند فتح Modal ✅
const openSessionModal = (course: string) => {
  const formation = formations.find(f => f.title === selectedFormation);
  if (formation) {
    const courseObj = formation.courses.find(c => c.title === course);
    if (courseObj && courseObj.sessions) {
      const courseKey = `${selectedFormation}-${course}`;
      setCourseSessions(prev => ({
        ...prev,
        [courseKey]: courseObj.sessions  // ✅ مزامنة البيانات
      }));
    }
  }
  setShowSessionModal(true);
};
            </div>

            <h4>3. إصلاح Session Count Display:</h4>
            <div class="code">
// قبل الإصلاح ❌ - يعرض من courseSessions
{courseSessions[`${selectedFormation}-${course.title}`]?.length > 0 && (
  <div>{courseSessions[...].length} session(s) ajoutée(s)</div>
)}

// بعد الإصلاح ✅ - يعرض من formations.courses[].sessions
{course.sessions && course.sessions.length > 0 && (
  <div>{course.sessions.length} session(s) ajoutée(s)</div>
)}
            </div>
        </div>

        <div class="info">
            <h3>📊 Console Messages للتشخيص:</h3>
            
            <h4>عند إضافة Session:</h4>
            <div class="console">
🔄 Adding session: s1 to course: seo
📊 Updated courseSessions: {"Marketing-seo": [{title: "s1", ...}]}
📚 Updated course with session: {title: "seo", sessions: [{title: "s1", ...}]}
🎯 All formations with sessions: [...]
            </div>

            <h4>عند فتح Session Modal:</h4>
            <div class="console">
🔍 Opening session modal for course: seo in formation: Marketing
📚 Found existing sessions: [{title: "s1", ...}, {title: "s2", ...}]
            </div>
        </div>

        <div class="step">
            <h3>🧪 اختبر الإصلاح الآن:</h3>
            <ol>
                <li><strong>افتح Admin Panel</strong> → Participants</li>
                <li><strong>افتح Developer Tools</strong> (F12) → Console</li>
                <li><strong>اضغط "Ajouter"</strong> أو عدل مشارك موجود</li>
                <li><strong>اذهب لتبويب "Formations & Projets"</strong></li>
                <li><strong>أضف Formation</strong> (مثل "Marketing")</li>
                <li><strong>اضغط "Cours"</strong> → أضف كورس "seo"</li>
                <li><strong>اضغط "Sessions"</strong> بجانب "seo" → أضف session "s1"</li>
                <li><strong>راقب Console</strong> → يجب أن ترى الرسائل أعلاه</li>
                <li><strong>اضغط "Terminer"</strong> ثم افتح "Sessions" مرة أخرى</li>
                <li><strong>النتيجة:</strong> Session "s1" يجب أن تظهر في القائمة ✅</li>
            </ol>
        </div>

        <div class="success">
            <h3>🎉 النتيجة المتوقعة:</h3>
            <ul>
                <li>✅ <strong>Sessions تضاف</strong> وتظهر فوراً</li>
                <li>✅ <strong>Sessions تبقى ظاهرة</strong> عند إعادة فتح Modal</li>
                <li>✅ <strong>عدد Sessions صحيح</strong> يظهر في Course list</li>
                <li>✅ <strong>إمكانية إضافة Links</strong> لكل session</li>
                <li>✅ <strong>لا مزيد من فقدان البيانات</strong></li>
            </ul>
        </div>

        <div class="info">
            <h3>🔗 الخطوة التالية - Session Links:</h3>
            <p>بعد التأكد من أن Sessions تحفظ بشكل صحيح، يمكنك:</p>
            <ol>
                <li>اضغط <strong>"Liens"</strong> بجانب أي session</li>
                <li>أضف الروابط الأربعة:
                    <ul>
                        <li>📄 <strong>Résumé</strong> - ملخص الجلسة</li>
                        <li>📚 <strong>Support</strong> - مواد الدعم</li>
                        <li>🎥 <strong>Vidéo</strong> - فيديوهات الجلسة</li>
                        <li>✏️ <strong>Exercice</strong> - تمارين وأنشطة</li>
                    </ul>
                </li>
                <li>احفظ المشارك لحفظ جميع البيانات</li>
            </ol>
        </div>

        <div class="step">
            <h3>📋 الهيكل الكامل المطلوب:</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace;">
Formation: Marketing<br>
├── Course: seo<br>
│   ├── Session: s1<br>
│   │   ├── 📄 Résumé: https://example.com/resume1<br>
│   │   ├── 📚 Support: https://example.com/support1<br>
│   │   ├── 🎥 Vidéo: https://example.com/video1<br>
│   │   └── ✏️ Exercice: https://example.com/exercise1<br>
│   └── Session: s2<br>
│       ├── 📄 Résumé: https://example.com/resume2<br>
│       └── ...<br>
├── Course: sponsaoring<br>
│   └── Sessions...<br>
└── Course: جلل<br>
    └── Sessions...
            </div>
        </div>

        <div class="success">
            <h3>🎯 الخلاصة:</h3>
            <p><strong>تم إصلاح مشكلة Sessions نهائياً!</strong></p>
            <p>الآن النظام يحفظ Sessions في كلا من UI state و formations array، مما يضمن عدم فقدان البيانات.</p>
            <p><strong>جرب الآن وأخبرني بالنتيجة! 🚀</strong></p>
        </div>
    </div>
</body>
</html>
