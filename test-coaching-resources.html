<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Ressources de Coaching - MATC</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 5px; margin: 10px 0; }
        button { padding: 12px 20px; margin: 10px 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; font-size: 12px; overflow-x: auto; max-height: 300px; }
        .resource-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; background: #f9f9f9; }
        .resource-title { font-weight: bold; color: #007bff; margin-bottom: 5px; }
        .resource-meta { font-size: 12px; color: #666; margin-bottom: 10px; }
        .resource-description { color: #333; }
        .participant-info { background: #e3f2fd; padding: 15px; border-radius: 5px; border-left: 4px solid #2196f3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Ressources de Coaching - MATC</h1>
        
        <div class="warning">
            <h3>‚ö†Ô∏è Diagnostic de la probl√®me</h3>
            <p>Analyse des ressources de coaching pour identifier et r√©soudre les probl√®mes d'affichage ou de fonctionnalit√©.</p>
        </div>

        <div class="grid">
            <div class="test-section">
                <h3>üë§ Participants disponibles</h3>
                <div class="participant-info">
                    <h4>1. Ahmed Participant Test</h4>
                    <p><strong>ID:</strong> PART-739438</p>
                    <p><strong>Email:</strong> ahmed.participant@matc.com</p>
                </div>
                <div class="participant-info">
                    <h4>2. Ismael Gharbi</h4>
                    <p><strong>ID:</strong> PART-550776</p>
                    <p><strong>Email:</strong> gharbi@gmail.com</p>
                </div>
            </div>

            <div class="test-section">
                <h3>üß™ Tests de diagnostic</h3>
                <button onclick="testBackendConnection()">Test Backend</button>
                <button onclick="testParticipantData('PART-550776')">Test Ismael</button>
                <button onclick="testParticipantData('PART-739438')">Test Ahmed</button>
                <button onclick="testMockResources()">Test Mock Data</button>
            </div>
        </div>

        <div class="test-section">
            <h3>üîß Actions de r√©paration</h3>
            <button onclick="createSampleResources('PART-550776')" class="success">Cr√©er ressources pour Ismael</button>
            <button onclick="createSampleResources('PART-739438')" class="success">Cr√©er ressources pour Ahmed</button>
            <button onclick="clearAllResources()" class="danger">Effacer toutes les ressources</button>
            <button onclick="resetToDefaults()" class="warning">Reset aux d√©fauts</button>
        </div>

        <div class="test-section">
            <h3>üìä Analyse d√©taill√©e</h3>
            <button onclick="analyzeResourceStructure()">Analyser structure</button>
            <button onclick="validateResourceData()">Valider donn√©es</button>
            <button onclick="checkApiEndpoints()">V√©rifier endpoints</button>
            <button onclick="debugCoachingComponent()">Debug composant</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            results.appendChild(div);
            console.log(message);
        }

        async function testBackendConnection() {
            log('üîÑ Test de connexion au backend...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/api/participants');
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Backend connect√© - ${data.data?.length || 0} participants trouv√©s`, 'success');
                    return true;
                } else {
                    log(`‚ùå Backend erreur: ${response.status} ${response.statusText}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erreur de connexion backend: ${error.message}`, 'error');
                return false;
            }
        }

        async function testParticipantData(participantId) {
            log(`üîç Test donn√©es participant: ${participantId}`, 'info');
            
            try {
                const response = await fetch(`http://localhost:3001/api/participants/${participantId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        const participant = data.data;
                        const resourcesCount = participant.coachingResources?.length || 0;
                        
                        log(`‚úÖ Participant trouv√©: ${participant.fullName}`, 'success');
                        log(`üìö Ressources de coaching: ${resourcesCount}`, resourcesCount > 0 ? 'success' : 'warning');
                        
                        if (resourcesCount > 0) {
                            log(`<pre>Ressources d√©taill√©es:
${JSON.stringify(participant.coachingResources, null, 2)}</pre>`, 'info');
                        } else {
                            log('‚ö†Ô∏è Aucune ressource de coaching trouv√©e', 'warning');
                        }
                        
                        return participant;
                    } else {
                        log(`‚ùå Participant non trouv√©: ${participantId}`, 'error');
                        return null;
                    }
                } else {
                    log(`‚ùå Erreur API: ${response.status}`, 'error');
                    return null;
                }
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                return null;
            }
        }

        function testMockResources() {
            log('üß™ Test des donn√©es mock...', 'info');
            
            const mockResources = [
                {
                    id: 'COACH-001',
                    title: 'CV Template Moderne',
                    description: 'Mod√®le de CV professionnel pour d√©veloppeurs',
                    type: 'CV Template',
                    category: 'Templates',
                    thumbnail: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=300&h=200&fit=crop',
                    downloadUrl: '#'
                },
                {
                    id: 'COACH-002',
                    title: 'Lettre de Motivation Tech',
                    description: 'Exemple de lettre pour postes techniques',
                    type: 'Lettre de motivation',
                    category: 'Templates',
                    thumbnail: 'https://images.unsplash.com/photo-1455390582262-044cdead277a?w=300&h=200&fit=crop',
                    downloadUrl: '#'
                },
                {
                    id: 'COACH-003',
                    title: 'Communication Efficace',
                    description: 'Am√©liorer ses comp√©tences de communication',
                    type: 'Vid√©o Soft Skills',
                    category: 'Soft Skills',
                    duration: '45 min',
                    thumbnail: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300&h=200&fit=crop'
                }
            ];
            
            log(`‚úÖ Mock data disponible: ${mockResources.length} ressources`, 'success');
            
            mockResources.forEach((resource, index) => {
                log(`<div class="resource-card">
                    <div class="resource-title">${resource.title}</div>
                    <div class="resource-meta">Type: ${resource.type} | Cat√©gorie: ${resource.category}</div>
                    <div class="resource-description">${resource.description}</div>
                </div>`, 'info');
            });
        }

        async function createSampleResources(participantId) {
            log(`üîÑ Cr√©ation ressources pour ${participantId}...`, 'info');
            
            const sampleResources = [
                {
                    title: 'Guide Entretien d\'Embauche',
                    description: 'Pr√©parer et r√©ussir ses entretiens techniques',
                    type: 'Guide',
                    category: 'Carri√®re',
                    url: 'https://example.com/guide-entretien',
                    thumbnail: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=300&h=200&fit=crop'
                },
                {
                    title: 'CV Template D√©veloppeur',
                    description: 'Mod√®le de CV moderne pour d√©veloppeurs',
                    type: 'CV Template',
                    category: 'Templates',
                    url: 'https://example.com/cv-template',
                    thumbnail: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=300&h=200&fit=crop'
                },
                {
                    title: 'Communication Efficace',
                    description: 'Am√©liorer ses comp√©tences de communication',
                    type: 'Vid√©o Soft Skills',
                    category: 'Soft Skills',
                    duration: '45 min',
                    url: 'https://example.com/communication-video',
                    thumbnail: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=300&h=200&fit=crop'
                }
            ];
            
            try {
                // First, get current participant data
                const getResponse = await fetch(`http://localhost:3001/api/participants/${participantId}`);
                if (!getResponse.ok) {
                    log(`‚ùå Participant ${participantId} non trouv√©`, 'error');
                    return;
                }
                
                const currentData = await getResponse.json();
                if (!currentData.success) {
                    log(`‚ùå Erreur lors de la r√©cup√©ration du participant`, 'error');
                    return;
                }
                
                // Update with new resources
                const updateData = {
                    ...currentData.data,
                    coachingResources: sampleResources
                };
                
                const response = await fetch(`http://localhost:3001/api/participants/${participantId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        log(`‚úÖ ${sampleResources.length} ressources cr√©√©es pour ${participantId}`, 'success');
                        
                        // Verify the creation
                        setTimeout(() => testParticipantData(participantId), 1000);
                    } else {
                        log(`‚ùå Erreur lors de la cr√©ation: ${result.message}`, 'error');
                    }
                } else {
                    log(`‚ùå Erreur HTTP: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        async function clearAllResources() {
            log('üóëÔ∏è Suppression de toutes les ressources...', 'warning');
            
            const participants = ['PART-550776', 'PART-739438'];
            
            for (const participantId of participants) {
                try {
                    const getResponse = await fetch(`http://localhost:3001/api/participants/${participantId}`);
                    if (getResponse.ok) {
                        const currentData = await getResponse.json();
                        if (currentData.success) {
                            const updateData = {
                                ...currentData.data,
                                coachingResources: []
                            };
                            
                            const response = await fetch(`http://localhost:3001/api/participants/${participantId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(updateData)
                            });
                            
                            if (response.ok) {
                                log(`‚úÖ Ressources supprim√©es pour ${participantId}`, 'success');
                            }
                        }
                    }
                } catch (error) {
                    log(`‚ùå Erreur pour ${participantId}: ${error.message}`, 'error');
                }
            }
        }

        async function analyzeResourceStructure() {
            log('üîç Analyse de la structure des ressources...', 'info');
            
            const participantId = 'PART-550776';
            const participant = await testParticipantData(participantId);
            
            if (participant && participant.coachingResources) {
                const resources = participant.coachingResources;
                
                log(`üìä Analyse structurelle:`, 'info');
                log(`- Nombre total: ${resources.length}`, 'info');
                
                const categories = [...new Set(resources.map(r => r.category))];
                log(`- Cat√©gories: ${categories.join(', ')}`, 'info');
                
                const types = [...new Set(resources.map(r => r.type))];
                log(`- Types: ${types.join(', ')}`, 'info');
                
                const withUrls = resources.filter(r => r.url || r.downloadUrl).length;
                log(`- Avec URLs: ${withUrls}/${resources.length}`, 'info');
                
                const withThumbnails = resources.filter(r => r.thumbnail).length;
                log(`- Avec thumbnails: ${withThumbnails}/${resources.length}`, 'info');
            } else {
                log('‚ùå Aucune ressource √† analyser', 'warning');
            }
        }

        function validateResourceData() {
            log('‚úÖ Validation des donn√©es de ressources...', 'info');
            
            const requiredFields = ['title', 'description', 'type', 'category'];
            const optionalFields = ['url', 'thumbnail', 'downloadUrl', 'duration'];
            
            log(`Champs requis: ${requiredFields.join(', ')}`, 'info');
            log(`Champs optionnels: ${optionalFields.join(', ')}`, 'info');
            
            const validCategories = ['Templates', 'Soft Skills', 'Carri√®re', 'Ressources', 'Marketing', 'Innovation', 'Productivit√©'];
            log(`Cat√©gories valides: ${validCategories.join(', ')}`, 'info');
            
            const validTypes = ['CV Template', 'Lettre de motivation', 'Vid√©o Soft Skills', 'Guide', 'Jeux √âducatifs', 'Sc√©narios', 'Biblioth√®que Online', 'Podcast', 'Atelier Interactif', 'Cas d\'Etude', 'Webinaire', 'Outils'];
            log(`Types valides: ${validTypes.join(', ')}`, 'info');
        }

        async function checkApiEndpoints() {
            log('üîó V√©rification des endpoints API...', 'info');
            
            const endpoints = [
                { url: 'http://localhost:3001/api/participants', method: 'GET', desc: 'Liste participants' },
                { url: 'http://localhost:3001/api/participants/PART-550776', method: 'GET', desc: 'Participant sp√©cifique' },
                { url: 'http://localhost:3001/api/participants/PART-550776/resources', method: 'GET', desc: 'Ressources participant' }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.url, { method: endpoint.method });
                    const status = response.ok ? '‚úÖ' : '‚ùå';
                    log(`${status} ${endpoint.desc}: ${response.status}`, response.ok ? 'success' : 'error');
                } catch (error) {
                    log(`‚ùå ${endpoint.desc}: ${error.message}`, 'error');
                }
            }
        }

        function debugCoachingComponent() {
            log('üêõ Debug du composant Coaching...', 'info');
            
            log('V√©rifications √† effectuer dans le composant:', 'info');
            log('1. Le participantId est-il correctement pass√©?', 'warning');
            log('2. L\'API getParticipantResources fonctionne-t-elle?', 'warning');
            log('3. Les donn√©es mock sont-elles utilis√©es en fallback?', 'warning');
            log('4. Le filtrage par cat√©gorie fonctionne-t-il?', 'warning');
            log('5. L\'affichage des ressources est-il correct?', 'warning');
            
            log('Actions recommand√©es:', 'info');
            log('- V√©rifier les console.logs dans le navigateur', 'info');
            log('- Tester avec et sans participantId', 'info');
            log('- V√©rifier la structure des donn√©es retourn√©es', 'info');
            log('- Tester le fallback vers mock data', 'info');
        }

        async function resetToDefaults() {
            log('üîÑ Reset aux param√®tres par d√©faut...', 'warning');
            
            await clearAllResources();
            await createSampleResources('PART-550776');
            await createSampleResources('PART-739438');
            
            log('‚úÖ Reset termin√©', 'success');
        }

        // Auto-run initial tests
        window.onload = function() {
            setTimeout(async () => {
                log('üîÑ Tests automatiques au chargement...', 'info');
                await testBackendConnection();
                await testParticipantData('PART-550776');
                testMockResources();
            }, 500);
        };
    </script>
</body>
</html>
