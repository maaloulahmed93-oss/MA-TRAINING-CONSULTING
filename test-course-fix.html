<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 إصلاح مشكلة Course لا يحفظ</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        .success { background: #d4edda; padding: 15px; border-radius: 5px; color: #155724; margin: 10px 0; }
        .info { background: #d1ecf1; padding: 15px; border-radius: 5px; color: #0c5460; margin: 10px 0; }
        .warning { background: #fff3cd; padding: 15px; border-radius: 5px; color: #856404; margin: 10px 0; }
        .fix { background: #e7f3ff; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff; margin: 10px 0; }
        .code { background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; overflow-x: auto; }
        .step { background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 إصلاح مشكلة Course لا يحفظ</h1>
        
        <div class="warning">
            <h3>❌ المشكلة المكتشفة:</h3>
            <p>الكورس "جلل" يضاف لكن يختفي عند إعادة فتح النافذة أو الحفظ</p>
            <p><strong>السبب:</strong> عدم تزامن بين <code>formationCourses</code> و <code>formations.courses</code></p>
        </div>

        <div class="fix">
            <h3>🔧 الإصلاحات المطبقة:</h3>
            
            <h4>1. إصلاح addCourse Function:</h4>
            <div class="code">
// قبل الإصلاح ❌
const addCourse = () => {
  setFormationCourses(prev => ({
    ...prev,
    [selectedFormation]: [...prev[selectedFormation] || [], newCourse.trim()]
  }));
  // لا يحفظ في formations array ❌
};

// بعد الإصلاح ✅
const addCourse = () => {
  // Update formationCourses for UI display
  setFormationCourses(prev => ({...}));
  
  // Also update the formations array to persist the course ✅
  setFormations(prev => {
    const updated = prev.map(formation => {
      if (formation.title === selectedFormation) {
        const newCourseObj = {
          id: `course-${Date.now()}`,
          title: newCourse.trim(),
          description: "",
          progress: 0,
          isCompleted: false,
          duration: "0",
          modules: [],
          sessions: []
        };
        return {
          ...formation,
          courses: [...(formation.courses || []), newCourseObj]
        };
      }
      return formation;
    });
    return updated;
  });
};
            </div>

            <h4>2. إصلاح removeCourse Function:</h4>
            <div class="code">
// الآن يحذف من كلا المكانين ✅
const removeCourse = (courseIndex: number) => {
  // Update formationCourses for UI display
  setFormationCourses(prev => ({...}));
  
  // Also update the formations array to persist the removal
  setFormations(prev => {
    const updated = prev.map(formation => {
      if (formation.title === selectedFormation) {
        return {
          ...formation,
          courses: (formation.courses || []).filter((_, i) => i !== courseIndex)
        };
      }
      return formation;
    });
    return updated;
  });
};
            </div>

            <h4>3. إصلاح handleSubmit Function:</h4>
            <div class="code">
// قبل الإصلاح ❌ - يعيد إنشاء courses من formationCourses
const mergedFormations = formations.map(f => {
  const courseTitles = formationCourses[f.title] || [];
  // يفقد البيانات المحفوظة في f.courses ❌
});

// بعد الإصلاح ✅ - يستخدم courses الموجودة
const mergedFormations = formations.map(f => {
  const updatedCourses = (f.courses || []).map(course => {
    const courseKey = `${f.title}-${course.title}`;
    const sessionsForCourse = courseSessions[courseKey] || course.sessions || [];
    return { ...course, sessions: sessionsForCourse };
  });
  return { ...f, courses: updatedCourses };
});
            </div>
        </div>

        <div class="success">
            <h3>✅ النتيجة المتوقعة:</h3>
            <ul>
                <li>الكورس "جلل" سيحفظ ولن يختفي</li>
                <li>جميع الكورسات ستظهر في القائمة</li>
                <li>البيانات ستحفظ بشكل صحيح عند الـ Submit</li>
                <li>لا مزيد من فقدان البيانات</li>
            </ul>
        </div>

        <div class="step">
            <h3>🧪 اختبر الإصلاح الآن:</h3>
            <ol>
                <li>افتح Admin Panel → Participants</li>
                <li>اضغط "Ajouter" أو عدل مشارك موجود</li>
                <li>اذهب لتبويب "Formations & Projets"</li>
                <li>أضف Formation جديد</li>
                <li>اضغط "Cours" → أضف كورس "جلل"</li>
                <li>اضغط "Fermer" ثم افتح "Cours" مرة أخرى</li>
                <li><strong>النتيجة:</strong> الكورس "جلل" يجب أن يظهر في القائمة ✅</li>
            </ol>
        </div>

        <div class="info">
            <h3>📊 ملخص التحسينات:</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="background: #f8f9fa;">
                    <th style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">الوظيفة</th>
                    <th style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">قبل الإصلاح</th>
                    <th style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">بعد الإصلاح</th>
                </tr>
                <tr>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">addCourse</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">يحفظ في formationCourses فقط</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">يحفظ في كلا المكانين ✅</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">removeCourse</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">يحذف من formationCourses فقط</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">يحذف من كلا المكانين ✅</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">handleSubmit</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">يعيد إنشاء courses</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">يستخدم courses الموجودة ✅</td>
                </tr>
            </table>
        </div>

        <div class="warning">
            <h3>⚠️ إذا استمرت المشكلة:</h3>
            <ul>
                <li>تأكد من عدم وجود أخطاء في Console</li>
                <li>تحقق من أن الـ Formation تم إنشاؤه بنجاح</li>
                <li>تأكد من أن selectedFormation يحتوي على القيمة الصحيحة</li>
                <li>أرسل screenshot للمشكلة</li>
            </ul>
        </div>

        <div class="success">
            <h3>🎯 الخلاصة:</h3>
            <p><strong>تم إصلاح مشكلة Course لا يحفظ!</strong></p>
            <p>الآن الكورسات ستحفظ في كلا من UI state و formations array، مما يضمن عدم فقدان البيانات.</p>
        </div>
    </div>
</body>
</html>
