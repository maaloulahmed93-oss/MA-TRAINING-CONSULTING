<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 تتبع مسار البيانات - Debug Progress Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">🔍 تتبع مسار البيانات</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Test API Directly -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-blue-600">🌐 اختبار API مباشرة</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Participant ID</label>
                        <input type="text" id="participantId" value="PART-834809" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">التقدم</label>
                            <input type="number" id="testProgress" min="0" max="100" value="75" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الدورات</label>
                            <input type="number" id="testCourses" min="0" max="50" value="10" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الساعات</label>
                            <input type="number" id="testHours" min="0" max="500" value="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الأهداف</label>
                            <input type="number" id="testGoals" min="0" max="50" value="8" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <button onclick="testDirectAPI()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        🚀 اختبار PUT API مباشرة
                    </button>
                    
                    <button onclick="testGetAPI()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        📥 اختبار GET API
                    </button>
                    
                    <div id="apiResult" class="mt-4 p-4 rounded-lg text-sm"></div>
                </div>
            </div>

            <!-- Test Frontend Service -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-purple-600">⚛️ اختبار Frontend Service</h2>
                
                <div class="space-y-4">
                    <button onclick="testFrontendService()" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                        🔧 اختبار participantsService
                    </button>
                    
                    <button onclick="checkLocalStorage()" class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">
                        💾 فحص localStorage
                    </button>
                    
                    <div id="serviceResult" class="mt-4 p-4 rounded-lg text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Network Monitor -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4 text-red-600">📡 مراقب الشبكة</h2>
            <div id="networkLog" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm h-64 overflow-y-auto"></div>
            <button onclick="clearNetworkLog()" class="mt-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                🗑️ مسح السجل
            </button>
        </div>

        <!-- Instructions -->
        <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-yellow-800 mb-3">📋 خطوات التشخيص</h3>
            <ol class="list-decimal list-inside space-y-2 text-yellow-700">
                <li><strong>اختبار API مباشرة:</strong> تأكد من أن الـ Backend يحفظ البيانات</li>
                <li><strong>اختبار Frontend Service:</strong> تأكد من أن الـ Service يرسل البيانات صحيحة</li>
                <li><strong>فحص localStorage:</strong> تأكد من حفظ البيانات محلياً</li>
                <li><strong>مراقبة الشبكة:</strong> تتبع جميع الطلبات والاستجابات</li>
                <li><strong>فحص Console:</strong> ابحث عن أخطاء JavaScript</li>
            </ol>
        </div>
    </div>

    <script>
        let networkLog = [];

        function logNetwork(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            networkLog.push(logEntry);
            updateNetworkDisplay();
            console.log(logEntry);
        }

        function updateNetworkDisplay() {
            const logDiv = document.getElementById('networkLog');
            logDiv.innerHTML = networkLog.slice(-50).join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearNetworkLog() {
            networkLog = [];
            updateNetworkDisplay();
        }

        async function testDirectAPI() {
            const participantId = document.getElementById('participantId').value;
            const progress = parseInt(document.getElementById('testProgress').value);
            const courses = parseInt(document.getElementById('testCourses').value);
            const hours = parseInt(document.getElementById('testHours').value);
            const goals = parseInt(document.getElementById('testGoals').value);
            
            const resultDiv = document.getElementById('apiResult');
            
            try {
                logNetwork(`Starting direct API test for ${participantId}`, 'info');
                
                const updateData = {
                    totalProgress: progress,
                    completedCourses: courses,
                    studyTime: hours,
                    achievedGoals: goals,
                    totalGoals: 12,
                    fullName: 'aziz ben ameur',
                    email: 'ameur@gmail.com'
                };
                
                logNetwork(`Sending PUT request with data: ${JSON.stringify(updateData)}`, 'request');
                
                const response = await fetch(`http://localhost:3001/api/participants/${participantId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });
                
                logNetwork(`PUT response status: ${response.status}`, 'response');
                
                if (response.ok) {
                    const result = await response.json();
                    logNetwork(`PUT response data: ${JSON.stringify(result)}`, 'success');
                    
                    resultDiv.innerHTML = `
                        <h3 class="font-semibold text-green-600 mb-2">✅ PUT Request نجح</h3>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Success:</strong> ${result.success}</p>
                        <p><strong>Message:</strong> ${result.message}</p>
                        <div class="mt-2 max-h-40 overflow-y-auto">
                            <pre class="text-xs">${JSON.stringify(result.data, null, 2)}</pre>
                        </div>
                    `;
                    resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-green-50 border border-green-200';
                    
                    // Now test GET to verify the data was saved
                    setTimeout(() => testGetAPI(), 1000);
                    
                } else {
                    const errorText = await response.text();
                    logNetwork(`PUT request failed: ${errorText}`, 'error');
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
            } catch (error) {
                logNetwork(`API test failed: ${error.message}`, 'error');
                resultDiv.innerHTML = `
                    <h3 class="font-semibold text-red-600 mb-2">❌ API Test فشل</h3>
                    <p>${error.message}</p>
                `;
                resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-red-50 border border-red-200';
            }
        }

        async function testGetAPI() {
            const participantId = document.getElementById('participantId').value;
            const resultDiv = document.getElementById('apiResult');
            
            try {
                logNetwork(`Testing GET API for ${participantId}`, 'info');
                
                const response = await fetch(`http://localhost:3001/api/participants/${participantId}`);
                logNetwork(`GET response status: ${response.status}`, 'response');
                
                if (response.ok) {
                    const result = await response.json();
                    logNetwork(`GET response received`, 'success');
                    
                    const data = result.data;
                    const currentContent = resultDiv.innerHTML;
                    
                    resultDiv.innerHTML = currentContent + `
                        <div class="mt-4 pt-4 border-t border-green-300">
                            <h4 class="font-semibold text-green-700 mb-2">📥 GET Response Data:</h4>
                            <p><strong>Total Progress:</strong> ${data.totalProgress || 'غير محدد'}</p>
                            <p><strong>Completed Courses:</strong> ${data.completedCourses || 'غير محدد'}</p>
                            <p><strong>Study Time:</strong> ${data.studyTime || 'غير محدد'}h</p>
                            <p><strong>Achieved Goals:</strong> ${data.achievedGoals || 'غير محدد'}</p>
                            <p><strong>Total Goals:</strong> ${data.totalGoals || 'غير محدد'}</p>
                        </div>
                    `;
                } else {
                    throw new Error(`GET failed: ${response.status}`);
                }
                
            } catch (error) {
                logNetwork(`GET test failed: ${error.message}`, 'error');
            }
        }

        async function testFrontendService() {
            const resultDiv = document.getElementById('serviceResult');
            
            try {
                logNetwork('Testing Frontend Service simulation', 'info');
                
                // Simulate the frontend service call
                const participantData = {
                    id: 'PART-834809',
                    fullName: 'aziz ben ameur',
                    email: 'ameur@gmail.com',
                    totalProgress: 85,
                    completedCourses: 12,
                    studyTime: 60,
                    achievedGoals: 15,
                    totalGoals: 18
                };
                
                logNetwork(`Simulating upsertParticipant call`, 'info');
                
                // Test the actual API call that the frontend would make
                const response = await fetch('http://localhost:3001/api/participants/PART-834809', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...participantData,
                        partnerId: participantData.id
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    logNetwork('Frontend service simulation successful', 'success');
                    
                    resultDiv.innerHTML = `
                        <h3 class="font-semibold text-green-600 mb-2">✅ Frontend Service يعمل</h3>
                        <p><strong>API Response:</strong> ${result.success ? 'نجح' : 'فشل'}</p>
                        <p><strong>Data Updated:</strong> ${result.message}</p>
                    `;
                    resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-green-50 border border-green-200';
                } else {
                    throw new Error(`Service test failed: ${response.status}`);
                }
                
            } catch (error) {
                logNetwork(`Frontend service test failed: ${error.message}`, 'error');
                resultDiv.innerHTML = `
                    <h3 class="font-semibold text-red-600 mb-2">❌ Frontend Service فشل</h3>
                    <p>${error.message}</p>
                `;
                resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-red-50 border border-red-200';
            }
        }

        function checkLocalStorage() {
            const resultDiv = document.getElementById('serviceResult');
            
            try {
                logNetwork('Checking localStorage', 'info');
                
                const participants = localStorage.getItem('matc_participants');
                
                if (participants) {
                    const parsed = JSON.parse(participants);
                    const targetParticipant = parsed.find(p => p.id === 'PART-834809');
                    
                    logNetwork(`Found ${parsed.length} participants in localStorage`, 'success');
                    
                    if (targetParticipant) {
                        resultDiv.innerHTML = `
                            <h3 class="font-semibold text-blue-600 mb-2">💾 localStorage Data Found</h3>
                            <p><strong>Total Progress:</strong> ${targetParticipant.totalProgress || 'غير محدد'}</p>
                            <p><strong>Completed Courses:</strong> ${targetParticipant.completedCourses || 'غير محدد'}</p>
                            <p><strong>Study Time:</strong> ${targetParticipant.studyTime || 'غير محدد'}h</p>
                            <p><strong>Achieved Goals:</strong> ${targetParticipant.achievedGoals || 'غير محدد'}</p>
                            <p><strong>Total Goals:</strong> ${targetParticipant.totalGoals || 'غير محدد'}</p>
                            <p><strong>Last Updated:</strong> ${targetParticipant.updatedAt || 'غير محدد'}</p>
                        `;
                        resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-blue-50 border border-blue-200';
                    } else {
                        resultDiv.innerHTML = `
                            <h3 class="font-semibold text-yellow-600 mb-2">⚠️ Participant Not Found</h3>
                            <p>PART-834809 غير موجود في localStorage</p>
                            <p>عدد المشاركين الموجودين: ${parsed.length}</p>
                        `;
                        resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-yellow-50 border border-yellow-200';
                    }
                } else {
                    logNetwork('No participants found in localStorage', 'warning');
                    resultDiv.innerHTML = `
                        <h3 class="font-semibold text-red-600 mb-2">❌ No localStorage Data</h3>
                        <p>لا توجد بيانات في localStorage</p>
                    `;
                    resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-red-50 border border-red-200';
                }
                
            } catch (error) {
                logNetwork(`localStorage check failed: ${error.message}`, 'error');
                resultDiv.innerHTML = `
                    <h3 class="font-semibold text-red-600 mb-2">❌ localStorage Error</h3>
                    <p>${error.message}</p>
                `;
                resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-red-50 border border-red-200';
            }
        }

        // Initialize
        logNetwork('Debug tool initialized', 'info');
    </script>
</body>
</html>
