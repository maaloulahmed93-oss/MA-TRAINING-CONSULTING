<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” ØªØªØ¨Ø¹ Ù…Ø³Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Debug Progress Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">ğŸ” ØªØªØ¨Ø¹ Ù…Ø³Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Test API Directly -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-blue-600">ğŸŒ Ø§Ø®ØªØ¨Ø§Ø± API Ù…Ø¨Ø§Ø´Ø±Ø©</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Participant ID</label>
                        <input type="text" id="participantId" value="PART-834809" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ØªÙ‚Ø¯Ù…</label>
                            <input type="number" id="testProgress" min="0" max="100" value="75" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¯ÙˆØ±Ø§Øª</label>
                            <input type="number" id="testCourses" min="0" max="50" value="10" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø³Ø§Ø¹Ø§Øª</label>
                            <input type="number" id="testHours" min="0" max="500" value="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</label>
                            <input type="number" id="testGoals" min="0" max="50" value="8" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <button onclick="testDirectAPI()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        ğŸš€ Ø§Ø®ØªØ¨Ø§Ø± PUT API Ù…Ø¨Ø§Ø´Ø±Ø©
                    </button>
                    
                    <button onclick="testGetAPI()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        ğŸ“¥ Ø§Ø®ØªØ¨Ø§Ø± GET API
                    </button>
                    
                    <div id="apiResult" class="mt-4 p-4 rounded-lg text-sm"></div>
                </div>
            </div>

            <!-- Test Frontend Service -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-purple-600">âš›ï¸ Ø§Ø®ØªØ¨Ø§Ø± Frontend Service</h2>
                
                <div class="space-y-4">
                    <button onclick="testFrontendService()" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                        ğŸ”§ Ø§Ø®ØªØ¨Ø§Ø± participantsService
                    </button>
                    
                    <button onclick="checkLocalStorage()" class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">
                        ğŸ’¾ ÙØ­Øµ localStorage
                    </button>
                    
                    <div id="serviceResult" class="mt-4 p-4 rounded-lg text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Network Monitor -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4 text-red-600">ğŸ“¡ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø´Ø¨ÙƒØ©</h2>
            <div id="networkLog" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm h-64 overflow-y-auto"></div>
            <button onclick="clearNetworkLog()" class="mt-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
            </button>
        </div>

        <!-- Instructions -->
        <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-yellow-800 mb-3">ğŸ“‹ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ</h3>
            <ol class="list-decimal list-inside space-y-2 text-yellow-700">
                <li><strong>Ø§Ø®ØªØ¨Ø§Ø± API Ù…Ø¨Ø§Ø´Ø±Ø©:</strong> ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù€ Backend ÙŠØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
                <li><strong>Ø§Ø®ØªØ¨Ø§Ø± Frontend Service:</strong> ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù€ Service ÙŠØ±Ø³Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©</li>
                <li><strong>ÙØ­Øµ localStorage:</strong> ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹</li>
                <li><strong>Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø´Ø¨ÙƒØ©:</strong> ØªØªØ¨Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø§Øª</li>
                <li><strong>ÙØ­Øµ Console:</strong> Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ø®Ø·Ø§Ø¡ JavaScript</li>
            </ol>
        </div>
    </div>

    <script>
        let networkLog = [];

        function logNetwork(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            networkLog.push(logEntry);
            updateNetworkDisplay();
            console.log(logEntry);
        }

        function updateNetworkDisplay() {
            const logDiv = document.getElementById('networkLog');
            logDiv.innerHTML = networkLog.slice(-50).join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearNetworkLog() {
            networkLog = [];
            updateNetworkDisplay();
        }

        async function testDirectAPI() {
            const participantId = document.getElementById('participantId').value;
            const progress = parseInt(document.getElementById('testProgress').value);
            const courses = parseInt(document.getElementById('testCourses').value);
            const hours = parseInt(document.getElementById('testHours').value);
            const goals = parseInt(document.getElementById('testGoals').value);
            
            const resultDiv = document.getElementById('apiResult');
            
            try {
                logNetwork(`Starting direct API test for ${participantId}`, 'info');
                
                const updateData = {
                    totalProgress: progress,
                    completedCourses: courses,
                    studyTime: hours,
                    achievedGoals: goals,
                    totalGoals: 12,
                    fullName: 'aziz ben ameur',
                    email: 'ameur@gmail.com'
                };
                
                logNetwork(`Sending PUT request with data: ${JSON.stringify(updateData)}`, 'request');
                
                const response = await fetch(`http://localhost:3001/api/participants/${participantId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });
                
                logNetwork(`PUT response status: ${response.status}`, 'response');
                
                if (response.ok) {
                    const result = await response.json();
                    logNetwork(`PUT response data: ${JSON.stringify(result)}`, 'success');
                    
                    resultDiv.innerHTML = `
                        <h3 class="font-semibold text-green-600 mb-2">âœ… PUT Request Ù†Ø¬Ø­</h3>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Success:</strong> ${result.success}</p>
                        <p><strong>Message:</strong> ${result.message}</p>
                        <div class="mt-2 max-h-40 overflow-y-auto">
                            <pre class="text-xs">${JSON.stringify(result.data, null, 2)}</pre>
                        </div>
                    `;
                    resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-green-50 border border-green-200';
                    
                    // Now test GET to verify the data was saved
                    setTimeout(() => testGetAPI(), 1000);
                    
                } else {
                    const errorText = await response.text();
                    logNetwork(`PUT request failed: ${errorText}`, 'error');
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
            } catch (error) {
                logNetwork(`API test failed: ${error.message}`, 'error');
                resultDiv.innerHTML = `
                    <h3 class="font-semibold text-red-600 mb-2">âŒ API Test ÙØ´Ù„</h3>
                    <p>${error.message}</p>
                `;
                resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-red-50 border border-red-200';
            }
        }

        async function testGetAPI() {
            const participantId = document.getElementById('participantId').value;
            const resultDiv = document.getElementById('apiResult');
            
            try {
                logNetwork(`Testing GET API for ${participantId}`, 'info');
                
                const response = await fetch(`http://localhost:3001/api/participants/${participantId}`);
                logNetwork(`GET response status: ${response.status}`, 'response');
                
                if (response.ok) {
                    const result = await response.json();
                    logNetwork(`GET response received`, 'success');
                    
                    const data = result.data;
                    const currentContent = resultDiv.innerHTML;
                    
                    resultDiv.innerHTML = currentContent + `
                        <div class="mt-4 pt-4 border-t border-green-300">
                            <h4 class="font-semibold text-green-700 mb-2">ğŸ“¥ GET Response Data:</h4>
                            <p><strong>Total Progress:</strong> ${data.totalProgress || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            <p><strong>Completed Courses:</strong> ${data.completedCourses || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            <p><strong>Study Time:</strong> ${data.studyTime || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}h</p>
                            <p><strong>Achieved Goals:</strong> ${data.achievedGoals || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            <p><strong>Total Goals:</strong> ${data.totalGoals || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        </div>
                    `;
                } else {
                    throw new Error(`GET failed: ${response.status}`);
                }
                
            } catch (error) {
                logNetwork(`GET test failed: ${error.message}`, 'error');
            }
        }

        async function testFrontendService() {
            const resultDiv = document.getElementById('serviceResult');
            
            try {
                logNetwork('Testing Frontend Service simulation', 'info');
                
                // Simulate the frontend service call
                const participantData = {
                    id: 'PART-834809',
                    fullName: 'aziz ben ameur',
                    email: 'ameur@gmail.com',
                    totalProgress: 85,
                    completedCourses: 12,
                    studyTime: 60,
                    achievedGoals: 15,
                    totalGoals: 18
                };
                
                logNetwork(`Simulating upsertParticipant call`, 'info');
                
                // Test the actual API call that the frontend would make
                const response = await fetch('http://localhost:3001/api/participants/PART-834809', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...participantData,
                        partnerId: participantData.id
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    logNetwork('Frontend service simulation successful', 'success');
                    
                    resultDiv.innerHTML = `
                        <h3 class="font-semibold text-green-600 mb-2">âœ… Frontend Service ÙŠØ¹Ù…Ù„</h3>
                        <p><strong>API Response:</strong> ${result.success ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„'}</p>
                        <p><strong>Data Updated:</strong> ${result.message}</p>
                    `;
                    resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-green-50 border border-green-200';
                } else {
                    throw new Error(`Service test failed: ${response.status}`);
                }
                
            } catch (error) {
                logNetwork(`Frontend service test failed: ${error.message}`, 'error');
                resultDiv.innerHTML = `
                    <h3 class="font-semibold text-red-600 mb-2">âŒ Frontend Service ÙØ´Ù„</h3>
                    <p>${error.message}</p>
                `;
                resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-red-50 border border-red-200';
            }
        }

        function checkLocalStorage() {
            const resultDiv = document.getElementById('serviceResult');
            
            try {
                logNetwork('Checking localStorage', 'info');
                
                const participants = localStorage.getItem('matc_participants');
                
                if (participants) {
                    const parsed = JSON.parse(participants);
                    const targetParticipant = parsed.find(p => p.id === 'PART-834809');
                    
                    logNetwork(`Found ${parsed.length} participants in localStorage`, 'success');
                    
                    if (targetParticipant) {
                        resultDiv.innerHTML = `
                            <h3 class="font-semibold text-blue-600 mb-2">ğŸ’¾ localStorage Data Found</h3>
                            <p><strong>Total Progress:</strong> ${targetParticipant.totalProgress || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            <p><strong>Completed Courses:</strong> ${targetParticipant.completedCourses || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            <p><strong>Study Time:</strong> ${targetParticipant.studyTime || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}h</p>
                            <p><strong>Achieved Goals:</strong> ${targetParticipant.achievedGoals || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            <p><strong>Total Goals:</strong> ${targetParticipant.totalGoals || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            <p><strong>Last Updated:</strong> ${targetParticipant.updatedAt || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        `;
                        resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-blue-50 border border-blue-200';
                    } else {
                        resultDiv.innerHTML = `
                            <h3 class="font-semibold text-yellow-600 mb-2">âš ï¸ Participant Not Found</h3>
                            <p>PART-834809 ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ localStorage</p>
                            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†: ${parsed.length}</p>
                        `;
                        resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-yellow-50 border border-yellow-200';
                    }
                } else {
                    logNetwork('No participants found in localStorage', 'warning');
                    resultDiv.innerHTML = `
                        <h3 class="font-semibold text-red-600 mb-2">âŒ No localStorage Data</h3>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage</p>
                    `;
                    resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-red-50 border border-red-200';
                }
                
            } catch (error) {
                logNetwork(`localStorage check failed: ${error.message}`, 'error');
                resultDiv.innerHTML = `
                    <h3 class="font-semibold text-red-600 mb-2">âŒ localStorage Error</h3>
                    <p>${error.message}</p>
                `;
                resultDiv.className = 'mt-4 p-4 rounded-lg text-sm bg-red-50 border border-red-200';
            }
        }

        // Initialize
        logNetwork('Debug tool initialized', 'info');
    </script>
</body>
</html>
