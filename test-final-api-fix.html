<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ API ÙˆØ§Ù„ØªÙƒØ±Ø§Ø± - Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</title>
    <style>
        body { font-family: Arial; margin: 20px; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); min-height: 100vh; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .success { background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 20px; border-radius: 10px; margin: 15px 0; }
        .problem { background: #ffebee; padding: 15px; border-radius: 8px; color: #c62828; margin: 15px 0; border-left: 4px solid #f44336; }
        .solution { background: #e8f5e8; padding: 15px; border-radius: 8px; color: #2e7d32; margin: 15px 0; border-left: 4px solid #4caf50; }
        .step { background: #e3f2fd; padding: 15px; border-radius: 8px; color: #1565c0; margin: 15px 0; border-left: 4px solid #2196f3; }
        .console { background: #1a1a1a; color: #00ff00; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; margin: 10px 0; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 15px 0; }
        .warning { background: #fff3cd; padding: 15px; border-radius: 8px; color: #856404; border-left: 4px solid #ffc107; }
        .code { background: #f5f5f5; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ API ÙˆØ§Ù„ØªÙƒØ±Ø§Ø± - Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h1>
        
        <div class="problem">
            <h3>âŒ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ø±ØµÙˆØ¯Ø© Ù…Ù† Console:</h3>
            <ol>
                <li><strong>API calls Ù…ØªÙƒØ±Ø±Ø©:</strong> fetchProgramsFromAPI ÙŠØ³ØªØ¯Ø¹Ù‰ Ø¹Ø¯Ø© Ù…Ø±Ø§Øª</li>
                <li><strong>500 Internal Server Error:</strong> ÙÙŠ /api/programs</li>
                <li><strong>Console logs Ù…Ø­ÙÙˆØ¸Ø© ÙƒÙ€ URLs:</strong> ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
                <li><strong>JSON parsing errors:</strong> "Unexpected end of JSON input"</li>
            </ol>
            
            <div class="console">
ParticipantFormEnhanced.tsx:122 ğŸ”„ Chargement des programmes depuis l'API...
ParticipantFormEnhanced.tsx:122 ğŸ”„ Chargement des programmes depuis l'API...
api/programs:1 Failed to load resource: the server responded with a status of 500
ParticipantFormEnhanced.tsx:134 âŒ Erreur: SyntaxError: Unexpected end of JSON input
            </div>
        </div>

        <div class="grid-3">
            <div class="solution">
                <h4>âœ… Ø¥ØµÙ„Ø§Ø­ 1: Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± API calls</h4>
                <div class="code">
// Ø¥Ø¶Ø§ÙØ© useRef Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
const fetchingRef = useRef(false);

const fetchProgramsFromAPI = async () => {
  // Ø­Ù…Ø§ÙŠØ© Ù…Ø²Ø¯ÙˆØ¬Ø©
  if (fetchingRef.current || loadingPrograms) {
    console.log('âš ï¸ Programs fetch already in progress');
    return;
  }
  
  // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹
  if (apiPrograms.length > 0) {
    console.log('âœ… Programs already loaded');
    return;
  }
  
  fetchingRef.current = true;
  // ... fetch logic
  fetchingRef.current = false;
};
                </div>
            </div>
            
            <div class="solution">
                <h4>âœ… Ø¥ØµÙ„Ø§Ø­ 2: Ù…Ø¹Ø§Ù„Ø¬Ø© 500 Error</h4>
                <div class="code">
// Ù…Ø¹Ø§Ù„Ø¬Ø© populate errors
let programs;
try {
  programs = await Program.find(query)
    .populate('category', 'name')
    .sort({ createdAt: -1 });
} catch (populateError) {
  console.warn('âš ï¸ Populate error, fetching without populate');
  programs = await Program.find(query)
    .sort({ createdAt: -1 });
}

// Ø¶Ù…Ø§Ù† response ØµØ­ÙŠØ­
const response = {
  success: true,
  data: programs || [],
  count: programs ? programs.length : 0
};
                </div>
            </div>
            
            <div class="solution">
                <h4>âœ… Ø¥ØµÙ„Ø§Ø­ 3: Ù…Ø¹Ø§Ù„Ø¬Ø© JSON Errors</h4>
                <div class="code">
// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ù€ response
const response = await fetch('/api/programs');

if (!response.ok) {
  throw new Error(`HTTP ${response.status}`);
}

const text = await response.text();
if (!text) {
  throw new Error('Empty response from server');
}

const data = JSON.parse(text);
                </div>
            </div>
        </div>

        <div class="step">
            <h3>ğŸ”§ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ù…Ø·Ø¨Ù‚Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„:</h3>
            
            <h4>1ï¸âƒ£ Frontend: ParticipantFormEnhanced.tsx</h4>
            <div class="code">
// Ø¥Ø¶Ø§ÙØ© useRef import
import React, { useState, useEffect, useRef } from "react";

// Ø¥Ø¶Ø§ÙØ© ref Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
const fetchingRef = useRef(false);

// ØªØ­Ø³ÙŠÙ† fetchProgramsFromAPI
const fetchProgramsFromAPI = async () => {
  // Ø­Ù…Ø§ÙŠØ© Ù…Ø²Ø¯ÙˆØ¬Ø© Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
  if (fetchingRef.current || loadingPrograms) {
    console.log('âš ï¸ Programs fetch already in progress, skipping...');
    return;
  }
  
  // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  if (apiPrograms.length > 0) {
    console.log('âœ… Programs already loaded, skipping fetch');
    return;
  }
  
  fetchingRef.current = true;
  setLoadingPrograms(true);
  
  try {
    console.log('ğŸ”„ Chargement des programmes depuis l\'API...');
    
    const response = await fetch('/api/programs');
    
    // Ù…Ø¹Ø§Ù„Ø¬Ø© HTTP errors
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    // Ù…Ø¹Ø§Ù„Ø¬Ø© empty responses
    const text = await response.text();
    if (!text) {
      throw new Error('Empty response from server');
    }
    
    const data = JSON.parse(text);
    
    if (data.success && Array.isArray(data.data)) {
      setApiPrograms(data.data);
      console.log(`âœ… ${data.data.length} programmes chargÃ©s depuis l'API`);
    } else {
      console.warn('âš ï¸ Aucun programme trouvÃ© dans l\'API');
      setApiPrograms([]);
    }
  } catch (error) {
    console.error('âŒ Erreur lors du chargement des programmes:', error);
    setApiPrograms([]);
  } finally {
    setLoadingPrograms(false);
    fetchingRef.current = false;
  }
};
            </div>

            <h4>2ï¸âƒ£ Backend: programs.js</h4>
            <div class="code">
// Ù…Ø¹Ø§Ù„Ø¬Ø© populate errors
let programs;
try {
  programs = await Program.find(query).populate('category', 'name').sort({ createdAt: -1 });
} catch (populateError) {
  console.warn('âš ï¸ Populate error, fetching without populate:', populateError.message);
  programs = await Program.find(query).sort({ createdAt: -1 });
}

// Ø¶Ù…Ø§Ù† response ØµØ­ÙŠØ­
const response = {
  success: true,
  data: programs || [],
  count: programs ? programs.length : 0
};

console.log('ğŸ“¤ Sending response:', {
  success: response.success,
  count: response.count,
  hasData: Array.isArray(response.data)
});

res.json(response);
            </div>

            <h4>3ï¸âƒ£ Database Cleanup Script</h4>
            <div class="code">
// cleanup-console-logs.js - Ù„Ø­Ø°Ù console logs Ù…Ù† URLs
const consoleLogResources = await ParticipantResource.find({
  $or: [
    { url: { $regex: 'chunk-YQ5BCTVV.js', $options: 'i' } },
    { url: { $regex: 'Download the React DevTools', $options: 'i' } },
    { url: { $regex: 'ParticipantFormEnhanced.tsx', $options: 'i' } },
    { url: { $regex: 'ProgramManager.tsx', $options: 'i' } },
    { url: { $regex: 'CategoryManager.tsx', $options: 'i' } },
    { url: { $regex: 'partnersApiService.ts', $options: 'i' } },
    { url: { $regex: 'console.log', $options: 'i' } },
    { url: { $regex: 'fetchProgramsFromAPI', $options: 'i' } }
  ]
});

// Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…Ù„ÙˆØ«Ø©
for (const resource of consoleLogResources) {
  await ParticipantResource.deleteOne({ _id: resource._id });
  console.log(`ğŸ—‘ï¸ Deleted resource: ${resource.title}`);
}
            </div>
        </div>

        <div class="warning">
            <h3>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ù„:</h3>
            
            <h4>Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±</h4>
            <ol>
                <li><strong>Ø§ÙØªØ­ Admin Panel</strong> â†’ Participants</li>
                <li><strong>Ø§Ø¶ØºØ· "Modifier"</strong> Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±Ùƒ</li>
                <li><strong>Ø±Ø§Ù‚Ø¨ Console</strong> - ÙŠØ¬Ø¨ Ø£Ù† ØªØ±Ù‰:</li>
            </ol>
            
            <div class="console" style="background: #e8f5e8; color: #2e7d32;">
ğŸ”„ Chargement des programmes depuis l'API...
âœ… 1 programmes chargÃ©s depuis l'API
âœ… Programs already loaded, skipping fetch  (Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©)
            </div>

            <h4>Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Errors</h4>
            <ul>
                <li>âŒ <strong>Ù„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ØªØ±Ù‰:</strong> "Failed to load resource: 500"</li>
                <li>âŒ <strong>Ù„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ØªØ±Ù‰:</strong> "Unexpected end of JSON input"</li>
                <li>âŒ <strong>Ù„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ØªØ±Ù‰:</strong> Ø·Ù„Ø¨Ø§Øª API Ù…ØªÙƒØ±Ø±Ø©</li>
            </ul>

            <h4>Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ø±Ø¯</h4>
            <ul>
                <li>âœ… <strong>Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ØªØ­ÙØ¸:</strong> Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</li>
                <li>âœ… <strong>Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ØªØ¹Ù…Ù„:</strong> Ø¨Ø¯ÙˆÙ† console logs</li>
                <li>âœ… <strong>Ù„Ø§ ØªÙƒØ±Ø§Ø±:</strong> ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
            </ul>
        </div>

        <div class="success">
            <h3>ğŸ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:</h3>
            <div class="grid-3">
                <div>
                    <h4>ğŸš« Ù…Ø´Ø§ÙƒÙ„ Ù…Ø­Ù„ÙˆÙ„Ø©:</h4>
                    <ul style="font-size: 16px; line-height: 1.8;">
                        <li><strong>âœ… Ù„Ø§ ØªÙƒØ±Ø§Ø± API:</strong> fetchProgramsFromAPI</li>
                        <li><strong>âœ… Ù„Ø§ 500 errors:</strong> ÙÙŠ /api/programs</li>
                        <li><strong>âœ… Ù„Ø§ JSON errors:</strong> Ù…Ø¹Ø§Ù„Ø¬Ø© ØµØ­ÙŠØ­Ø©</li>
                        <li><strong>âœ… Ù„Ø§ console logs:</strong> ÙÙŠ URLs</li>
                        <li><strong>âœ… Ø­Ù…Ø§ÙŠØ© Ù…Ø²Ø¯ÙˆØ¬Ø©:</strong> useRef + state</li>
                        <li><strong>âœ… error handling:</strong> Ø´Ø§Ù…Ù„ ÙˆÙ…Ø­Ø³Ù†</li>
                    </ul>
                </div>
                <div>
                    <h4>ğŸ›¡ï¸ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©:</h4>
                    <ul style="font-size: 16px; line-height: 1.8;">
                        <li><strong>fetchingRef:</strong> Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±</li>
                        <li><strong>loadingPrograms:</strong> state protection</li>
                        <li><strong>apiPrograms.length:</strong> data check</li>
                        <li><strong>populate error handling:</strong> graceful fallback</li>
                        <li><strong>response validation:</strong> complete checks</li>
                        <li><strong>JSON parsing:</strong> safe with text check</li>
                    </ul>
                </div>
                <div>
                    <h4>âš¡ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø­Ø³Ù†:</h4>
                    <ul style="font-size: 16px; line-height: 1.8;">
                        <li><strong>Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·:</strong> Ù„Ù„Ø¨Ø±Ø§Ù…Ø¬</li>
                        <li><strong>ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø±Ø¹:</strong> Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±</li>
                        <li><strong>Ø°Ø§ÙƒØ±Ø© Ø£Ù‚Ù„:</strong> efficient caching</li>
                        <li><strong>Ø´Ø¨ÙƒØ© Ø£Ù‚Ù„:</strong> reduced network calls</li>
                        <li><strong>ØªØ¬Ø±Ø¨Ø© Ø£ÙØ¶Ù„:</strong> Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…</li>
                        <li><strong>Ø§Ø³ØªÙ‚Ø±Ø§Ø± ÙƒØ§Ù…Ù„:</strong> no more crashes</li>
                    </ul>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; border-radius: 15px;">
            <h2>ğŸ‰ Ø¬Ù…ÙŠØ¹ Ù…Ø´Ø§ÙƒÙ„ API ÙˆØ§Ù„ØªÙƒØ±Ø§Ø± Ù…Ø­Ù„ÙˆÙ„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹! âœ…</h2>
            <p style="font-size: 18px; margin: 15px 0;">Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨ÙƒÙØ§Ø¡Ø© Ø¹Ø§Ù„ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªÙƒØ±Ø§Ø± Ø£Ùˆ Ø£Ø®Ø·Ø§Ø¡</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin: 20px 0;">
                <div>
                    <h4>ğŸš« Ù„Ø§ ØªÙƒØ±Ø§Ø±</h4>
                    <p>ÙÙŠ API calls</p>
                </div>
                <div>
                    <h4>ğŸ”’ Ø­Ù…Ø§ÙŠØ© ÙƒØ§Ù…Ù„Ø©</h4>
                    <p>Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</p>
                </div>
                <div>
                    <h4>âš¡ Ø£Ø¯Ø§Ø¡ Ù…Ø­Ø³Ù†</h4>
                    <p>ÙˆØ³Ø±Ø¹Ø© Ø£ÙƒØ¨Ø±</p>
                </div>
                <div>
                    <h4>âœ¨ ØªØ¬Ø±Ø¨Ø© Ù…Ø«Ø§Ù„ÙŠØ©</h4>
                    <p>Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…</p>
                </div>
            </div>
            <p><strong>ğŸ¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø£Ù‚ØµÙ‰ ÙƒÙØ§Ø¡Ø©!</strong></p>
        </div>
    </div>
</body>
</html>
