<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار حفظ التقدم</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">🧪 اختبار حفظ التقدم</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-blue-600">خطوات الاختبار</h2>
            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                <li>افتح لوحة الإدارة: <code class="bg-gray-100 px-2 py-1 rounded">http://localhost:8080/participants</code></li>
                <li>اضغط على أيقونة الرسم البياني الخضراء 📊 لأي مشارك</li>
                <li>عدّل أي قيمة (التقدم، الدورات، الساعات، الأهداف)</li>
                <li>اضغط "Mettre à jour"</li>
                <li>تحقق من Console للرسائل</li>
                <li>تحقق من أن الجدول تحدث</li>
            </ol>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-green-600">رسائل Console المتوقعة</h2>
            <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm">
                <div>🔄 Updating participant: PART-814809</div>
                <div>❌ API failed, falling back to localStorage: [error details]</div>
                <div>✅ Updated using localStorage</div>
                <div>✅ Progress update completed</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-orange-600">اختبار localStorage</h2>
            <button onclick="checkLocalStorage()" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors mb-4">
                🔍 فحص localStorage
            </button>
            <div id="localStorageResult" class="bg-gray-50 p-4 rounded-lg text-sm"></div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4 text-purple-600">محاكاة التحديث</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ID المشارك</label>
                    <input type="text" id="participantId" value="PART-814809" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">التقدم الجديد</label>
                    <input type="number" id="newProgress" min="0" max="100" value="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <button onclick="simulateUpdate()" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                    🚀 محاكاة التحديث
                </button>
                <div id="simulationResult" class="mt-4 p-4 rounded-lg text-sm"></div>
            </div>
        </div>
    </div>

    <script>
        function checkLocalStorage() {
            const participants = localStorage.getItem('matc_participants');
            const resultDiv = document.getElementById('localStorageResult');
            
            if (participants) {
                try {
                    const parsed = JSON.parse(participants);
                    resultDiv.innerHTML = `
                        <h3 class="font-semibold text-green-600 mb-2">✅ البيانات موجودة في localStorage</h3>
                        <p class="mb-2"><strong>عدد المشاركين:</strong> ${parsed.length}</p>
                        <div class="max-h-40 overflow-y-auto">
                            <pre class="text-xs">${JSON.stringify(parsed, null, 2)}</pre>
                        </div>
                    `;
                    resultDiv.className = 'bg-green-50 border border-green-200 p-4 rounded-lg text-sm';
                } catch (error) {
                    resultDiv.innerHTML = `
                        <h3 class="font-semibold text-red-600 mb-2">❌ خطأ في تحليل البيانات</h3>
                        <p>${error.message}</p>
                    `;
                    resultDiv.className = 'bg-red-50 border border-red-200 p-4 rounded-lg text-sm';
                }
            } else {
                resultDiv.innerHTML = `
                    <h3 class="font-semibold text-yellow-600 mb-2">⚠️ لا توجد بيانات في localStorage</h3>
                    <p>قم بتشغيل لوحة الإدارة أولاً لإنشاء البيانات</p>
                `;
                resultDiv.className = 'bg-yellow-50 border border-yellow-200 p-4 rounded-lg text-sm';
            }
        }

        function simulateUpdate() {
            const participantId = document.getElementById('participantId').value;
            const newProgress = parseInt(document.getElementById('newProgress').value);
            const resultDiv = document.getElementById('simulationResult');
            
            try {
                // Get current participants
                const participants = localStorage.getItem('matc_participants');
                if (!participants) {
                    throw new Error('لا توجد بيانات في localStorage');
                }
                
                const parsed = JSON.parse(participants);
                const participantIndex = parsed.findIndex(p => p.id === participantId);
                
                if (participantIndex === -1) {
                    throw new Error(`المشارك ${participantId} غير موجود`);
                }
                
                // Update participant
                parsed[participantIndex] = {
                    ...parsed[participantIndex],
                    totalProgress: newProgress,
                    completedCourses: Math.floor(newProgress / 10),
                    studyTime: Math.floor(newProgress / 2),
                    achievedGoals: Math.floor(newProgress / 15),
                    updatedAt: new Date().toISOString()
                };
                
                // Save back to localStorage
                localStorage.setItem('matc_participants', JSON.stringify(parsed));
                
                resultDiv.innerHTML = `
                    <h3 class="font-semibold text-green-600 mb-2">✅ تم التحديث بنجاح</h3>
                    <p><strong>المشارك:</strong> ${participantId}</p>
                    <p><strong>التقدم الجديد:</strong> ${newProgress}%</p>
                    <p><strong>الدورات المكتملة:</strong> ${Math.floor(newProgress / 10)}</p>
                    <p><strong>ساعات الدراسة:</strong> ${Math.floor(newProgress / 2)}h</p>
                    <p><strong>الأهداف المحققة:</strong> ${Math.floor(newProgress / 15)}</p>
                `;
                resultDiv.className = 'bg-green-50 border border-green-200 p-4 rounded-lg text-sm';
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <h3 class="font-semibold text-red-600 mb-2">❌ فشل التحديث</h3>
                    <p>${error.message}</p>
                `;
                resultDiv.className = 'bg-red-50 border border-red-200 p-4 rounded-lg text-sm';
            }
        }

        // Auto-check localStorage on page load
        window.addEventListener('load', () => {
            setTimeout(checkLocalStorage, 500);
        });
    </script>
</body>
</html>
