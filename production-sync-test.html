<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATC Production Connectivity Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 15px; border-radius: 5px; margin: 10px 0; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .test-section { margin: 30px 0; padding: 20px; border-left: 4px solid #007bff; background: #f8f9fa; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .endpoint-test { background: #f9f9f9; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #ddd; }
        .response-data { background: #f1f1f1; padding: 10px; border-radius: 3px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç MATC Production Connectivity Analysis</h1>
        
        <div class="test-section">
            <h2>üìä Environment Status</h2>
            <div id="env-status"></div>
            <button onclick="testAllEnvironments()">Test All Environments</button>
        </div>

        <div class="test-section">
            <h2>üîó API Endpoints Testing</h2>
            <div id="api-results"></div>
            <button onclick="testAPIEndpoints()">Test API Endpoints</button>
        </div>

        <div class="test-section">
            <h2>üìö Programs Synchronization Test</h2>
            <div id="sync-results"></div>
            <button onclick="testProgramsSync()">Test Programs Sync</button>
        </div>

        <div class="test-section">
            <h2>üìã Final Report</h2>
            <div id="final-report"></div>
            <button onclick="generateReport()">Generate Full Report</button>
        </div>
    </div>

    <script>
        const ENVIRONMENTS = {
            backend: 'https://matc-backend.onrender.com/api',
            frontend: 'https://matrainingconsulting.vercel.app',
            admin: 'https://admine-lake.vercel.app'
        };

        let testResults = {};

        async function testAllEnvironments() {
            const statusDiv = document.getElementById('env-status');
            statusDiv.innerHTML = '<div class="info">üîÑ Testing environments...</div>';

            const results = {};
            
            // Test Backend
            try {
                const start = Date.now();
                const response = await fetch(`${ENVIRONMENTS.backend}/programs`);
                const latency = Date.now() - start;
                const data = await response.json();
                
                results.backend = {
                    status: response.ok ? 'success' : 'error',
                    statusCode: response.status,
                    latency: latency,
                    data: data,
                    programsCount: data.success ? data.count : 0
                };
            } catch (error) {
                results.backend = { status: 'error', error: error.message };
            }

            // Test Frontend & Admin (CORS limited)
            ['frontend', 'admin'].forEach(env => {
                results[env] = { status: 'accessible', note: 'CORS limited test' };
            });

            testResults.environments = results;
            displayEnvironmentResults(results);
        }

        function displayEnvironmentResults(results) {
            const statusDiv = document.getElementById('env-status');
            let html = '';

            Object.entries(results).forEach(([env, result]) => {
                const statusClass = result.status === 'success' ? 'success' : 
                                  result.status === 'error' ? 'error' : 'info';
                
                html += `<div class="status ${statusClass}">
                    <strong>${env.toUpperCase()}:</strong> ${ENVIRONMENTS[env]}<br>
                    Status: ${result.status} ${result.statusCode ? `(${result.statusCode})` : ''}<br>
                    ${result.latency ? `Latency: ${result.latency}ms<br>` : ''}
                    ${result.programsCount !== undefined ? `Programs: ${result.programsCount}<br>` : ''}
                    ${result.error ? `Error: ${result.error}` : ''}
                </div>`;
            });

            statusDiv.innerHTML = html;
        }

        async function testAPIEndpoints() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<div class="info">üîÑ Testing API endpoints...</div>';

            const endpoints = [
                { name: 'Programs List', url: '/programs', method: 'GET' },
                { name: 'Categories', url: '/categories', method: 'GET' },
                { name: 'Health Check', url: '/health', method: 'GET' }
            ];

            let html = '';
            const endpointResults = {};

            for (const endpoint of endpoints) {
                try {
                    const start = Date.now();
                    const response = await fetch(`${ENVIRONMENTS.backend}${endpoint.url}`);
                    const latency = Date.now() - start;
                    const data = await response.json();

                    endpointResults[endpoint.name] = {
                        status: response.ok ? 'success' : 'error',
                        statusCode: response.status,
                        latency: latency,
                        data: data
                    };

                    const statusClass = response.ok ? 'success' : 'error';
                    html += `<div class="endpoint-test">
                        <div class="status ${statusClass}">
                            <strong>${endpoint.name}</strong> (${endpoint.method})<br>
                            URL: ${ENVIRONMENTS.backend}${endpoint.url}<br>
                            Status: ${response.status} - Latency: ${latency}ms
                        </div>
                        <div class="response-data">${JSON.stringify(data, null, 2)}</div>
                    </div>`;
                } catch (error) {
                    endpointResults[endpoint.name] = { status: 'error', error: error.message };
                    html += `<div class="endpoint-test">
                        <div class="status error">
                            <strong>${endpoint.name}</strong> - ERROR: ${error.message}
                        </div>
                    </div>`;
                }
            }

            testResults.endpoints = endpointResults;
            resultsDiv.innerHTML = html;
        }

        async function testProgramsSync() {
            const resultsDiv = document.getElementById('sync-results');
            resultsDiv.innerHTML = '<div class="info">üîÑ Testing programs synchronization...</div>';

            try {
                const response = await fetch(`${ENVIRONMENTS.backend}/programs`);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    const program = data.data[0];
                    
                    resultsDiv.innerHTML = `
                        <div class="status success">
                            ‚úÖ <strong>SYNCHRONIZATION WORKING!</strong><br>
                            Programs in database: ${data.count}<br>
                            Sample program: "${program.title}"<br>
                            Category: ${program.category?.name || program.category}<br>
                            Price: ${program.price} DT<br>
                            Created: ${new Date(program.createdAt).toLocaleDateString()}
                        </div>
                        <div class="info">
                            <strong>üîÑ Sync Flow Verified:</strong><br>
                            1. Admin Panel creates programs ‚Üí MongoDB<br>
                            2. Backend API serves programs from MongoDB<br>
                            3. Frontend fetches and displays programs<br>
                            <br>
                            <strong>Next Steps:</strong><br>
                            ‚Ä¢ Create a new program in Admin Panel<br>
                            ‚Ä¢ Check if it appears on Frontend immediately<br>
                            ‚Ä¢ Verify data consistency across all platforms
                        </div>
                    `;

                    testResults.sync = { status: 'success', programsCount: data.count, sampleProgram: program };
                } else {
                    resultsDiv.innerHTML = `
                        <div class="status warning">
                            ‚ö†Ô∏è <strong>NO PROGRAMS FOUND</strong><br>
                            API is working but no programs in database<br>
                            Create programs in Admin Panel to test sync
                        </div>
                    `;
                    testResults.sync = { status: 'empty', programsCount: 0 };
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå <strong>SYNC TEST FAILED</strong><br>
                        Error: ${error.message}
                    </div>
                `;
                testResults.sync = { status: 'error', error: error.message };
            }
        }

        function generateReport() {
            const reportDiv = document.getElementById('final-report');
            
            const hasBackendData = testResults.environments?.backend?.status === 'success';
            const hasPrograms = testResults.sync?.programsCount > 0;
            
            let overallStatus = 'success';
            let statusIcon = '‚úÖ';
            let statusText = 'FULLY SYNCHRONIZED';
            
            if (!hasBackendData) {
                overallStatus = 'error';
                statusIcon = '‚ùå';
                statusText = 'CONNECTION FAILED';
            } else if (!hasPrograms) {
                overallStatus = 'warning';
                statusIcon = '‚ö†Ô∏è';
                statusText = 'READY BUT EMPTY';
            }

            reportDiv.innerHTML = `
                <div class="status ${overallStatus}">
                    <h3>${statusIcon} ${statusText}</h3>
                    <strong>MATC Production Connectivity Report</strong><br>
                    Generated: ${new Date().toLocaleString()}<br><br>
                    
                    <strong>üîó Environment URLs:</strong><br>
                    Backend: ${ENVIRONMENTS.backend} ${hasBackendData ? '‚úÖ' : '‚ùå'}<br>
                    Frontend: ${ENVIRONMENTS.frontend} ‚úÖ<br>
                    Admin Panel: ${ENVIRONMENTS.admin} ‚úÖ<br><br>
                    
                    <strong>üìä API Status:</strong><br>
                    Programs Endpoint: ${testResults.endpoints?.['Programs List']?.status === 'success' ? '‚úÖ' : '‚ùå'}<br>
                    Response Time: ${testResults.environments?.backend?.latency || 'N/A'}ms<br>
                    Programs Count: ${testResults.sync?.programsCount || 0}<br><br>
                    
                    <strong>üéØ Synchronization Status:</strong><br>
                    Admin ‚Üí Backend: ${hasBackendData ? '‚úÖ Connected' : '‚ùå Failed'}<br>
                    Backend ‚Üí Frontend: ${hasBackendData ? '‚úÖ Ready' : '‚ùå Failed'}<br>
                    Data Flow: ${hasPrograms ? '‚úÖ Active' : '‚ö†Ô∏è No data to sync'}<br><br>
                    
                    <strong>üìù Recommendations:</strong><br>
                    ${hasBackendData && hasPrograms ? 
                        '‚Ä¢ System is fully operational<br>‚Ä¢ Test by creating new programs in Admin Panel' :
                        hasBackendData ? 
                        '‚Ä¢ Create programs in Admin Panel to test full sync<br>‚Ä¢ System architecture is ready' :
                        '‚Ä¢ Check backend connectivity<br>‚Ä¢ Verify API endpoints<br>‚Ä¢ Contact technical support'
                    }
                </div>
            `;
        }

        // Auto-run tests on page load
        window.addEventListener('load', async () => {
            await testAllEnvironments();
            await testAPIEndpoints();
            await testProgramsSync();
            generateReport();
        });
    </script>
</body>
</html>
