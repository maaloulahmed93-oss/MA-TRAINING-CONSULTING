<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagnostic Complet - Services Commerciaux</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }
        .header {
            text-align: center;
            color: #dc2626;
            border-bottom: 4px solid #fecaca;
            padding-bottom: 30px;
            margin-bottom: 40px;
        }
        .section {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }
        .critical {
            background: linear-gradient(135deg, #fef2f2 0%, #fde8e8 100%);
            border: 3px solid #ef4444;
        }
        .success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 3px solid #22c55e;
        }
        .warning {
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
            border: 3px solid #f59e0b;
        }
        .code-block {
            background: #1f2937;
            color: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            overflow-x: auto;
            margin: 15px 0;
        }
        .fix-block {
            background: #065f46;
            color: #d1fae5;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            margin: 15px 0;
        }
        button {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3);
        }
        .result {
            background: #1f2937;
            color: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Diagnostic Complet</h1>
            <h2>Services Commerciaux - Frontend + Backend</h2>
            <p>Analyse d√©taill√©e et corrections pr√©cises</p>
        </div>

        <!-- Probl√®mes Identifi√©s -->
        <div class="section critical">
            <h2>üö® PROBL√àMES IDENTIFI√âS</h2>
            
            <h3>1Ô∏è‚É£ PROBL√àME MAJEUR: Over-Engineering Frontend</h3>
            <div class="code-block">
‚ùå PROBL√àME D√âTECT√â dans loadServices():
- setTimeout() inutile qui cause des race conditions
- √âtats redondants: refreshKey, forceUpdate, rawApiData
- Deep cloning inutile: JSON.parse(JSON.stringify())
- "Nuclear options" qui cassent React lifecycle
- setServices([]) puis setTimeout(() => setServices(data)) = BUG!

üîç CAUSE RACINE:
Le setTimeout(10ms) cr√©e une race condition o√π:
1. setServices([]) vide la liste
2. 10ms plus tard, setServices(newServices) devrait remplir
3. Mais React peut re-render entre les deux = liste vide!
            </div>

            <h3>2Ô∏è‚É£ PROBL√àME: API Response Structure</h3>
            <div class="code-block">
‚ùå BACKEND RESPONSE INCONSISTENCY:
- Backend logs: "11 services actifs trouv√©s"
- Frontend re√ßoit: result.success && result.data
- Mais le rendu ne fonctionne pas

üîç CAUSE POSSIBLE:
- Structure de response incorrecte
- Propri√©t√©s manquantes dans service objects
- Type mismatch entre backend et frontend
            </div>

            <h3>3Ô∏è‚É£ PROBL√àME: Delete Button Logic</h3>
            <div class="code-block">
‚ùå DELETE BUTTON STATUS:
- handleDeleteService() existe ‚úÖ
- onClick handler pr√©sent ‚úÖ
- disabled={loading} peut bloquer ‚úÖ
- DELETE route backend existe ‚úÖ

üîç CAUSE PROBABLE:
- Button disabled par loading state
- Confirmation dialog ne s'affiche pas
- Error handling silencieux
            </div>
        </div>

        <!-- Solutions Pr√©cises -->
        <div class="section success">
            <h2>‚úÖ SOLUTIONS PR√âCISES</h2>
            
            <h3>üîß FIX 1: Simplifier loadServices()</h3>
            <div class="fix-block">
// ‚úÖ VERSION CORRIG√âE - Remplacer dans CommercialServicesPage.tsx
const loadServices = async () => {
  console.log('üîÑ loadServices() appel√©e');
  setLoading(true);
  
  try {
    const response = await fetch('http://localhost:3001/api/commercial-services');
    const result = await response.json();
    console.log('üì° Response:', result);
    
    if (result.success && Array.isArray(result.data)) {
      console.log(`‚úÖ ${result.data.length} services charg√©s`);
      setServices(result.data);
      setError(null);
    } else {
      console.error('‚ùå Format de r√©ponse invalide:', result);
      setError('Format de r√©ponse invalide');
      setServices([]);
    }
  } catch (error) {
    console.error('‚ùå Erreur chargement:', error);
    setError('Erreur de connexion au serveur');
    setServices([]);
  } finally {
    setLoading(false);
  }
};

// ‚úÖ SUPPRIMER CES √âTATS INUTILES:
// const [refreshKey, setRefreshKey] = useState(0);
// const [forceUpdate, setForceUpdate] = useState(0);
// const [rawApiData, setRawApiData] = useState<any>(null);
            </div>

            <h3>üîß FIX 2: Am√©liorer handleDeleteService()</h3>
            <div class="fix-block">
// ‚úÖ VERSION CORRIG√âE - Ajouter debug et error handling
const handleDeleteService = async (serviceId: string, serviceTitle: string) => {
  console.log('üóëÔ∏è handleDeleteService appel√©e:', { serviceId, serviceTitle });
  
  const confirmed = confirm(
    `√ätes-vous s√ªr de vouloir supprimer le service "${serviceTitle}" ?\n\n` +
    `Cette action est irr√©versible.`
  );
  
  if (!confirmed) {
    console.log('‚ùå Suppression annul√©e par utilisateur');
    return;
  }

  setLoading(true);
  setError(null);

  try {
    console.log(`üì° DELETE request: /api/commercial-services/${serviceId}`);
    
    const response = await fetch(`http://localhost:3001/api/commercial-services/${serviceId}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    });

    const result = await response.json();
    console.log('üì° DELETE response:', result);
    
    if (response.ok && result.success) {
      console.log(`‚úÖ Service "${serviceTitle}" supprim√©`);
      setSuccess(`Service "${serviceTitle}" supprim√© avec succ√®s!`);
      
      // Recharger la liste imm√©diatement
      await loadServices();
    } else {
      const errorMsg = result.message || `Erreur ${response.status}`;
      console.error('‚ùå DELETE failed:', errorMsg);
      setError(`Erreur lors de la suppression: ${errorMsg}`);
    }
  } catch (error) {
    console.error('‚ùå DELETE error:', error);
    setError('Erreur de connexion au serveur');
  } finally {
    setLoading(false);
  }
};
            </div>

            <h3>üîß FIX 3: Am√©liorer Backend Response</h3>
            <div class="fix-block">
// ‚úÖ BACKEND FIX - commercialServices.js
router.get('/', async (req, res) => {
  try {
    console.log('üîç GET /api/commercial-services');
    
    const services = await CommercialService.find({ isActive: true })
      .sort({ dateCreation: -1 });
    
    console.log(`üìä ${services.length} services trouv√©s`);
    
    // Ensure all required fields are present
    const servicesWithDefaults = services.map(service => ({
      _id: service._id,
      titre: service.titre || 'Sans titre',
      description: service.description || '',
      categorie: service.categorie || 'G√©n√©ral',
      prixPublic: service.prixPublic || 0,
      prixCommercial: service.prixCommercial || 0,
      commission: service.commission || 0,
      duree: service.duree || '',
      commerciauxAutorises: service.commerciauxAutorises || [],
      statistiques: service.statistiques || {
        totalVentes: 0,
        chiffreAffaireGenere: 0,
        commissionTotalePayee: 0
      },
      isActive: service.isActive,
      dateCreation: service.dateCreation
    }));
    
    res.json({
      success: true,
      data: servicesWithDefaults,
      count: servicesWithDefaults.length,
      message: `${servicesWithDefaults.length} services r√©cup√©r√©s`
    });
    
  } catch (error) {
    console.error('‚ùå GET services error:', error);
    res.status(500).json({
      success: false,
      message: 'Erreur serveur',
      error: error.message,
      data: []
    });
  }
});
            </div>
        </div>

        <!-- Tests de Validation -->
        <div class="section">
            <h2>üß™ Tests de Validation</h2>
            <button onclick="testBackendAPI()">üîç Test Backend API</button>
            <button onclick="testFrontendState()">‚öõÔ∏è Test Frontend State</button>
            <button onclick="testDeleteFlow()">üóëÔ∏è Test Delete Flow</button>
            <button onclick="runCompleteTest()">üöÄ Test Complet</button>
            <div id="test-results" class="result"></div>
        </div>

        <!-- Workflow Corrig√© -->
        <div class="section success">
            <h2>üéØ WORKFLOW CORRIG√â</h2>
            <div class="code-block">
‚úÖ FLUX ATTENDU APR√àS CORRECTIONS:

1. CREATE SERVICE:
   Admin Panel ‚Üí POST /api/commercial-services
   ‚Üí Service cr√©√© en DB avec isActive: true
   ‚Üí loadServices() appel√©e automatiquement
   ‚Üí Services apparaissent imm√©diatement dans la liste

2. DELETE SERVICE:
   Click "Supprimer" ‚Üí Confirmation dialog
   ‚Üí DELETE /api/commercial-services/:id
   ‚Üí Service supprim√© de DB
   ‚Üí loadServices() appel√©e automatiquement
   ‚Üí Service dispara√Æt de la liste

3. ASSIGN SERVICE:
   Select Service + Commercial ‚Üí POST assign-service
   ‚Üí commerciauxAutorises array updated
   ‚Üí Dropdown mis √† jour automatiquement

üéâ R√âSULTAT: Interface r√©active et fonctionnelle!
            </div>
        </div>

        <!-- Checklist Finale -->
        <div class="section warning">
            <h2>üìã CHECKLIST DE CORRECTION</h2>
            <div style="font-size: 16px; line-height: 1.8;">
                <h3>Frontend (CommercialServicesPage.tsx):</h3>
                <ul>
                    <li>‚òê Supprimer setTimeout() dans loadServices()</li>
                    <li>‚òê Supprimer refreshKey, forceUpdate, rawApiData</li>
                    <li>‚òê Simplifier loadServices() avec setLoading()</li>
                    <li>‚òê Am√©liorer handleDeleteService() avec debug</li>
                    <li>‚òê Ajouter error handling robuste</li>
                </ul>

                <h3>Backend (commercialServices.js):</h3>
                <ul>
                    <li>‚òê Assurer structure response consistante</li>
                    <li>‚òê Ajouter defaults pour champs manquants</li>
                    <li>‚òê Am√©liorer error handling</li>
                    <li>‚òê V√©rifier DELETE route fonctionne</li>
                </ul>

                <h3>Tests:</h3>
                <ul>
                    <li>‚òê Create service ‚Üí appara√Æt imm√©diatement</li>
                    <li>‚òê Delete service ‚Üí dispara√Æt imm√©diatement</li>
                    <li>‚òê Assign service ‚Üí dropdown mis √† jour</li>
                    <li>‚òê Error handling ‚Üí messages clairs</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';

        async function testBackendAPI() {
            const resultDiv = document.getElementById('test-results');
            resultDiv.textContent = 'üîç Test Backend API...\n\n';

            try {
                // Test GET services
                resultDiv.textContent += 'TEST 1: GET /api/commercial-services\n';
                const response = await fetch(`${API_BASE}/api/commercial-services`);
                const result = await response.json();
                
                resultDiv.textContent += `Status: ${response.status}\n`;
                resultDiv.textContent += `Success: ${result.success}\n`;
                resultDiv.textContent += `Data type: ${Array.isArray(result.data) ? 'Array' : typeof result.data}\n`;
                resultDiv.textContent += `Count: ${result.data?.length || 0}\n\n`;

                if (result.data && result.data.length > 0) {
                    const sample = result.data[0];
                    resultDiv.textContent += 'SAMPLE SERVICE STRUCTURE:\n';
                    resultDiv.textContent += `_id: ${!!sample._id}\n`;
                    resultDiv.textContent += `titre: ${!!sample.titre}\n`;
                    resultDiv.textContent += `commission: ${!!sample.commission}\n`;
                    resultDiv.textContent += `commerciauxAutorises: ${Array.isArray(sample.commerciauxAutorises)}\n`;
                    resultDiv.textContent += `statistiques: ${!!sample.statistiques}\n\n`;
                }

                // Test DELETE route
                resultDiv.textContent += 'TEST 2: DELETE route availability\n';
                const deleteTest = await fetch(`${API_BASE}/api/commercial-services/fake-id`, {
                    method: 'DELETE'
                });
                resultDiv.textContent += `DELETE Status: ${deleteTest.status}\n`;
                resultDiv.textContent += `DELETE Available: ${deleteTest.status !== 404 ? 'YES' : 'NO'}\n\n`;

                if (result.success && Array.isArray(result.data)) {
                    resultDiv.textContent += '‚úÖ Backend API fonctionne correctement';
                } else {
                    resultDiv.textContent += '‚ùå Backend API a des probl√®mes de structure';
                }

            } catch (error) {
                resultDiv.textContent += `‚ùå Erreur: ${error.message}`;
            }
        }

        async function testFrontendState() {
            const resultDiv = document.getElementById('test-results');
            resultDiv.textContent = '‚öõÔ∏è Test Frontend State Management...\n\n';

            // Simulate the problematic loadServices logic
            resultDiv.textContent += 'SIMULATION DU PROBL√àME ACTUEL:\n';
            resultDiv.textContent += '1. setServices([]) ‚Üí Liste vide\n';
            resultDiv.textContent += '2. setTimeout(10ms) ‚Üí D√©lai artificiel\n';
            resultDiv.textContent += '3. setServices(data) ‚Üí Donn√©es (peut √©chouer)\n\n';

            resultDiv.textContent += 'PROBL√àMES IDENTIFI√âS:\n';
            resultDiv.textContent += '‚ùå Race condition avec setTimeout\n';
            resultDiv.textContent += '‚ùå √âtats redondants (refreshKey, forceUpdate)\n';
            resultDiv.textContent += '‚ùå Deep cloning inutile\n';
            resultDiv.textContent += '‚ùå Nuclear options anti-pattern\n\n';

            resultDiv.textContent += 'SOLUTION RECOMMAND√âE:\n';
            resultDiv.textContent += '‚úÖ loadServices() simple et direct\n';
            resultDiv.textContent += '‚úÖ setLoading() pour UX\n';
            resultDiv.textContent += '‚úÖ Error handling robuste\n';
            resultDiv.textContent += '‚úÖ Pas de setTimeout artificiel\n\n';

            resultDiv.textContent += 'üéØ R√âSULTAT: State management simplifi√© et fiable';
        }

        async function testDeleteFlow() {
            const resultDiv = document.getElementById('test-results');
            resultDiv.textContent = 'üóëÔ∏è Test Delete Flow...\n\n';

            try {
                // Get services first
                const servicesResponse = await fetch(`${API_BASE}/api/commercial-services`);
                const servicesResult = await servicesResponse.json();

                if (!servicesResult.data || servicesResult.data.length === 0) {
                    resultDiv.textContent += '‚ö†Ô∏è Aucun service disponible pour test de suppression\n';
                    return;
                }

                const testService = servicesResult.data[0];
                resultDiv.textContent += `SERVICE DE TEST: ${testService.titre}\n`;
                resultDiv.textContent += `ID: ${testService._id}\n\n`;

                resultDiv.textContent += 'SIMULATION DELETE FLOW:\n';
                resultDiv.textContent += '1. User clicks "Supprimer" button\n';
                resultDiv.textContent += '2. Confirmation dialog appears\n';
                resultDiv.textContent += '3. User confirms deletion\n';
                resultDiv.textContent += '4. DELETE request sent to backend\n';
                resultDiv.textContent += '5. Backend removes from database\n';
                resultDiv.textContent += '6. Frontend reloads services list\n';
                resultDiv.textContent += '7. Service disappears from UI\n\n';

                // Test actual DELETE endpoint
                resultDiv.textContent += 'TEST DELETE ENDPOINT:\n';
                const deleteResponse = await fetch(`${API_BASE}/api/commercial-services/fake-test-id`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                const deleteResult = await deleteResponse.json();
                resultDiv.textContent += `Status: ${deleteResponse.status}\n`;
                resultDiv.textContent += `Response: ${JSON.stringify(deleteResult, null, 2)}\n\n`;

                if (deleteResponse.status === 404) {
                    resultDiv.textContent += '‚úÖ DELETE endpoint fonctionne (404 pour ID inexistant)';
                } else if (deleteResponse.status === 200) {
                    resultDiv.textContent += '‚úÖ DELETE endpoint fonctionne parfaitement';
                } else {
                    resultDiv.textContent += '‚ùå DELETE endpoint a des probl√®mes';
                }

            } catch (error) {
                resultDiv.textContent += `‚ùå Erreur: ${error.message}`;
            }
        }

        async function runCompleteTest() {
            const resultDiv = document.getElementById('test-results');
            resultDiv.textContent = 'üöÄ Test Complet du Syst√®me...\n\n';

            try {
                resultDiv.textContent += '='.repeat(50) + '\n';
                resultDiv.textContent += 'DIAGNOSTIC COMPLET - SERVICES COMMERCIAUX\n';
                resultDiv.textContent += '='.repeat(50) + '\n\n';

                // 1. Backend Health
                resultDiv.textContent += '1Ô∏è‚É£ SANT√â BACKEND:\n';
                const healthResponse = await fetch(`${API_BASE}/api/health`);
                resultDiv.textContent += `Backend: ${healthResponse.ok ? '‚úÖ Op√©rationnel' : '‚ùå Hors service'}\n\n`;

                // 2. Services API
                resultDiv.textContent += '2Ô∏è‚É£ API SERVICES:\n';
                const servicesResponse = await fetch(`${API_BASE}/api/commercial-services`);
                const servicesResult = await servicesResponse.json();
                resultDiv.textContent += `GET Services: ${servicesResult.success ? '‚úÖ OK' : '‚ùå Erreur'}\n`;
                resultDiv.textContent += `Data Structure: ${Array.isArray(servicesResult.data) ? '‚úÖ Array' : '‚ùå Invalid'}\n`;
                resultDiv.textContent += `Services Count: ${servicesResult.data?.length || 0}\n\n`;

                // 3. Frontend Accessibility
                resultDiv.textContent += '3Ô∏è‚É£ FRONTEND:\n';
                try {
                    const adminResponse = await fetch('http://localhost:8536/commercial-services');
                    resultDiv.textContent += `Admin Panel: ${adminResponse.ok ? '‚úÖ Accessible' : '‚ùå Non accessible'}\n`;
                } catch {
                    resultDiv.textContent += `Admin Panel: ‚ùå Non accessible (port 8536)\n`;
                }

                // 4. Delete Route
                resultDiv.textContent += '\n4Ô∏è‚É£ DELETE ROUTE:\n';
                const deleteTest = await fetch(`${API_BASE}/api/commercial-services/test`, {
                    method: 'DELETE'
                });
                resultDiv.textContent += `DELETE Route: ${deleteTest.status === 404 ? '‚úÖ Disponible' : '‚ùå Probl√®me'}\n\n`;

                // 5. Root Cause Analysis
                resultDiv.textContent += '5Ô∏è‚É£ ANALYSE CAUSE RACINE:\n';
                if (servicesResult.success && servicesResult.data?.length > 0) {
                    resultDiv.textContent += '‚úÖ Backend retourne des donn√©es\n';
                    resultDiv.textContent += '‚ùå PROBL√àME: Frontend state management d√©faillant\n';
                    resultDiv.textContent += 'üîß SOLUTION: Simplifier loadServices(), supprimer setTimeout\n\n';
                } else {
                    resultDiv.textContent += '‚ùå Backend ne retourne pas de donn√©es\n';
                    resultDiv.textContent += 'üîß SOLUTION: V√©rifier cr√©ation de services par d√©faut\n\n';
                }

                // 6. Action Plan
                resultDiv.textContent += '6Ô∏è‚É£ PLAN D\'ACTION:\n';
                resultDiv.textContent += '1. Corriger loadServices() (supprimer setTimeout)\n';
                resultDiv.textContent += '2. Supprimer √©tats redondants\n';
                resultDiv.textContent += '3. Am√©liorer handleDeleteService()\n';
                resultDiv.textContent += '4. Tester create ‚Üí display ‚Üí delete flow\n\n';

                resultDiv.textContent += 'üéØ CONCLUSION: Probl√®me identifi√© et solutions pr√™tes!';

            } catch (error) {
                resultDiv.textContent += `‚ùå Erreur test complet: ${error.message}`;
            }
        }

        window.onload = function() {
            console.log('üîç Diagnostic Complet charg√©');
        };
    </script>
</body>
</html>
