<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Projets - Projets.tsx</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f7fa; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .section { padding: 20px; border-bottom: 1px solid #e2e8f0; }
        .section:last-child { border-bottom: none; }
        .test-button { background: #4299e1; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin: 5px; font-weight: 500; }
        .test-button:hover { background: #3182ce; }
        .test-button.success { background: #38a169; }
        .test-button.error { background: #e53e3e; }
        .result { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .success { background: #c6f6d5; border-color: #38a169; color: #22543d; }
        .error { background: #fed7d7; border-color: #e53e3e; color: #c53030; }
        .warning { background: #fef5e7; border-color: #d69e2e; color: #c05621; }
        .info { background: #bee3f8; border-color: #3182ce; color: #2c5282; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .status.online { background: #c6f6d5; color: #22543d; }
        .status.offline { background: #fed7d7; color: #c53030; }
        .project-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .project-header { display: flex; justify-content: between; align-items: center; margin-bottom: 10px; }
        .project-title { font-weight: 600; color: #2d3748; }
        .project-meta { font-size: 12px; color: #718096; }
        .step { background: #f0fff4; border-left: 4px solid #38a169; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Test API Projets</h1>
            <p>V√©rification du remplacement Mock Data ‚Üí API dans Projets.tsx</p>
        </div>

        <div class="section">
            <h2>üîß Configuration Test</h2>
            <div class="grid">
                <div class="card">
                    <h3>Backend Status</h3>
                    <p>URL: <code>http://localhost:3001/api</code></p>
                    <p>Status: <span id="backend-status" class="status offline">Checking...</span></p>
                    <button class="test-button" onclick="checkBackend()">V√©rifier Backend</button>
                </div>
                <div class="card">
                    <h3>Participant Test</h3>
                    <label>Participant ID:</label>
                    <input type="text" id="participant-id" value="PART-2024-001" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #e2e8f0; border-radius: 4px;">
                    <button class="test-button" onclick="testParticipantExists()">V√©rifier Participant</button>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìã Tests API Projets</h2>
            <div class="grid">
                <div>
                    <h3>Test 1: API Projets Directe</h3>
                    <button class="test-button" onclick="testProjectsAPI()">GET /participants/{id}/projects</button>
                    <div id="projects-api-result" class="result"></div>
                </div>
                <div>
                    <h3>Test 2: Projets via Participant</h3>
                    <button class="test-button" onclick="testParticipantProjects()">GET /participants/{id} ‚Üí projects</button>
                    <div id="participant-projects-result" class="result"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üîÑ Test Transformation Data</h2>
            <button class="test-button" onclick="testDataTransformation()">Tester Transformation API ‚Üí Frontend</button>
            <div id="transformation-result" class="result"></div>
        </div>

        <div class="section">
            <h2>üìä R√©sultats Projets</h2>
            <div id="projects-display"></div>
        </div>

        <div class="section">
            <h2>üîç Modifications Apport√©es</h2>
            
            <div class="step">
                <h3>‚úÖ Remplacement Mock Data</h3>
                <div class="grid">
                    <div class="card">
                        <h4>‚ùå AVANT</h4>
                        <pre style="font-size: 11px;">import { mockProjects } from '../../data/participantData';

const [selectedProject, setSelectedProject] = useState&lt;typeof mockProjects[0] | null&gt;(null);

{mockProjects.map((project, index) => (
  // Affichage projet
))}</pre>
                    </div>
                    <div class="card">
                        <h4>‚úÖ APR√àS</h4>
                        <pre style="font-size: 11px;">import { participantApiService, ApiProject } from '../../services/participantApiService';

const [projects, setProjects] = useState&lt;Project[]&gt;([]);
const [isLoading, setIsLoading] = useState(true);
const [error, setError] = useState&lt;string | null&gt;(null);

// API calls + transformation</pre>
                    </div>
                </div>
            </div>

            <div class="step">
                <h3>üîÑ Transformation Status</h3>
                <div class="card">
                    <h4>Mapping Backend ‚Üí Frontend</h4>
                    <pre style="font-size: 11px;">const statusMapping = {
  'not_started': 'En attente',
  'in_progress': 'En attente', 
  'submitted': 'En attente',
  'accepted': 'Accept√©',
  'rejected': 'Refus√©',
  'revision_needed': 'En r√©vision'
};</pre>
                </div>
            </div>

            <div class="step">
                <h3>üé® √âtats UI Ajout√©s</h3>
                <ul>
                    <li>‚úÖ Loading state avec spinner</li>
                    <li>‚úÖ Error state avec message</li>
                    <li>‚úÖ Empty state quand pas de projets</li>
                    <li>‚úÖ Statistiques calcul√©es dynamiquement</li>
                    <li>‚úÖ Logging console pour debug</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>üö® Console Logs</h2>
            <div id="console-logs" class="result" style="max-height: 200px;"></div>
            <button class="test-button" onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let consoleDiv = document.getElementById('console-logs');
        
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            logToDiv('LOG', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            logToDiv('ERROR', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            logToDiv('WARN', args.join(' '));
        };
        
        function logToDiv(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type}: ${message}\n`;
            consoleDiv.textContent += logEntry;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function clearLogs() {
            consoleDiv.textContent = '';
        }

        // Check backend connectivity
        async function checkBackend() {
            const statusEl = document.getElementById('backend-status');
            statusEl.textContent = 'Checking...';
            statusEl.className = 'status offline';
            
            try {
                const response = await fetch(`${API_BASE}/participants`);
                if (response.ok) {
                    statusEl.textContent = 'Online';
                    statusEl.className = 'status online';
                    console.log('‚úÖ Backend accessible');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                statusEl.textContent = 'Offline';
                statusEl.className = 'status offline';
                console.error('‚ùå Backend inaccessible:', error.message);
            }
        }

        // Test if participant exists
        async function testParticipantExists() {
            const participantId = document.getElementById('participant-id').value;
            
            try {
                console.log(`üîç V√©rification participant: ${participantId}`);
                const response = await fetch(`${API_BASE}/participants/${participantId}`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('‚úÖ Participant trouv√©:', result.data.fullName);
                        return true;
                    } else {
                        console.warn('‚ö†Ô∏è Participant non trouv√© dans la r√©ponse');
                        return false;
                    }
                } else {
                    console.error('‚ùå Erreur HTTP:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erreur r√©seau:', error.message);
                return false;
            }
        }

        // Test projects API directly
        async function testProjectsAPI() {
            const participantId = document.getElementById('participant-id').value;
            const resultDiv = document.getElementById('projects-api-result');
            
            try {
                console.log(`üìã Test API projets directe pour: ${participantId}`);
                const response = await fetch(`${API_BASE}/participants/${participantId}/projects`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üìã Projets API response:', result);
                    
                    if (result.success && Array.isArray(result.data)) {
                        resultDiv.className = 'result success';
                        resultDiv.innerHTML = `
                            <strong>‚úÖ API Projets OK</strong><br>
                            Nombre de projets: ${result.data.length}<br>
                            <pre>${JSON.stringify(result.data, null, 2)}</pre>
                        `;
                        return result.data;
                    } else {
                        resultDiv.className = 'result warning';
                        resultDiv.innerHTML = `
                            <strong>‚ö†Ô∏è API OK mais pas de projets</strong><br>
                            Response: <pre>${JSON.stringify(result, null, 2)}</pre>
                        `;
                        return [];
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Erreur API projets:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>‚ùå Erreur API</strong><br>${error.message}`;
                return null;
            }
        }

        // Test projects via participant data
        async function testParticipantProjects() {
            const participantId = document.getElementById('participant-id').value;
            const resultDiv = document.getElementById('participant-projects-result');
            
            try {
                console.log(`üë§ Test projets via participant data pour: ${participantId}`);
                const response = await fetch(`${API_BASE}/participants/${participantId}`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üë§ Participant data response:', result);
                    
                    if (result.success && result.data) {
                        const projects = result.data.projects || [];
                        resultDiv.className = 'result success';
                        resultDiv.innerHTML = `
                            <strong>‚úÖ Participant Data OK</strong><br>
                            Participant: ${result.data.fullName}<br>
                            Projets dans participant: ${projects.length}<br>
                            <pre>${JSON.stringify(projects, null, 2)}</pre>
                        `;
                        return projects;
                    } else {
                        resultDiv.className = 'result warning';
                        resultDiv.innerHTML = `
                            <strong>‚ö†Ô∏è Participant trouv√© mais pas de projets</strong><br>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        `;
                        return [];
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Erreur participant data:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>‚ùå Erreur API</strong><br>${error.message}`;
                return null;
            }
        }

        // Test data transformation (API ‚Üí Frontend format)
        async function testDataTransformation() {
            const resultDiv = document.getElementById('transformation-result');
            
            // Get projects from API
            const apiProjects = await testProjectsAPI();
            if (!apiProjects || apiProjects.length === 0) {
                resultDiv.className = 'result warning';
                resultDiv.innerHTML = '<strong>‚ö†Ô∏è Pas de projets √† transformer</strong>';
                return;
            }

            try {
                console.log('üîÑ Test transformation API ‚Üí Frontend');
                
                // Simulate the transformation function from Projets.tsx
                const transformApiProject = (apiProject) => {
                    const statusMapping = {
                        'not_started': 'En attente',
                        'in_progress': 'En attente', 
                        'submitted': 'En attente',
                        'accepted': 'Accept√©',
                        'rejected': 'Refus√©',
                        'revision_needed': 'En r√©vision'
                    };

                    return {
                        id: apiProject._id,
                        title: apiProject.title,
                        description: apiProject.description,
                        formationId: apiProject.formationId || '',
                        formationTitle: apiProject.formationTitle || 'Formation non sp√©cifi√©e',
                        status: statusMapping[apiProject.status] || 'En attente',
                        submittedDate: apiProject.submittedDate,
                        dueDate: apiProject.dueDate || new Date().toISOString(),
                        feedback: apiProject.feedback,
                        grade: apiProject.grade,
                        projectUrl: apiProject.files?.[0]?.url,
                        files: (apiProject.files || []).map(file => ({
                            id: file.id,
                            name: file.name,
                            size: file.size || '0 KB',
                            type: file.type || 'unknown',
                            uploadDate: file.uploadDate || new Date().toISOString()
                        }))
                    };
                };

                const transformedProjects = apiProjects.map(transformApiProject);
                console.log('‚úÖ Projets transform√©s:', transformedProjects);

                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>‚úÖ Transformation r√©ussie</strong><br>
                    ${transformedProjects.length} projets transform√©s<br>
                    <pre>${JSON.stringify(transformedProjects, null, 2)}</pre>
                `;

                // Display projects in UI
                displayProjects(transformedProjects);

            } catch (error) {
                console.error('‚ùå Erreur transformation:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>‚ùå Erreur transformation</strong><br>${error.message}`;
            }
        }

        // Display projects in a nice format
        function displayProjects(projects) {
            const displayDiv = document.getElementById('projects-display');
            
            if (!projects || projects.length === 0) {
                displayDiv.innerHTML = '<p class="warning">Aucun projet √† afficher</p>';
                return;
            }

            let html = '<h3>üìã Projets Transform√©s</h3>';
            projects.forEach((project, index) => {
                const statusColor = 
                    project.status === 'Accept√©' ? 'green' :
                    project.status === 'Refus√©' ? 'red' :
                    project.status === 'En r√©vision' ? 'orange' : 'blue';
                
                html += `
                    <div class="project-card">
                        <div class="project-header">
                            <span class="project-title">${project.title}</span>
                            <span class="status" style="background: ${statusColor}20; color: ${statusColor};">${project.status}</span>
                        </div>
                        <p class="project-meta">
                            üìÇ ${project.formationTitle} | 
                            üìÖ ${project.dueDate ? new Date(project.dueDate).toLocaleDateString('fr-FR') : 'Pas d\'√©ch√©ance'}
                            ${project.grade ? ` | üìä ${project.grade}/20` : ''}
                        </p>
                        <p style="font-size: 14px; color: #4a5568;">${project.description}</p>
                        ${project.feedback ? `<div style="background: #f7fafc; padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 12px;"><strong>Feedback:</strong> ${project.feedback}</div>` : ''}
                    </div>
                `;
            });
            
            displayDiv.innerHTML = html;
        }

        // Auto-run tests on page load
        window.onload = function() {
            console.log('üöÄ D√©marrage des tests API Projets');
            checkBackend();
        };
    </script>
</body>
</html>
