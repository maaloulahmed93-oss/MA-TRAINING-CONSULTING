<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Assignment Debug - MATC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f9ff;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .debug-section {
            background: #1f2937;
            color: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 600;
        }
        button:hover { background: #2563eb; }
        .error { background: #fef2f2; color: #dc2626; border: 2px solid #ef4444; }
        .success { background: #f0fdf4; color: #166534; border: 2px solid #22c55e; }
        .warning { background: #fffbeb; color: #d97706; border: 2px solid #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Test Assignment Debug</h1>
        <p>Debug complet pour résoudre l'erreur "Service ID et Partner ID requis"</p>

        <button onclick="testDataAvailability()">📋 Test Data Availability</button>
        <button onclick="testAssignmentCall()">🔗 Test Assignment Call</button>
        <button onclick="simulateFormSubmission()">📝 Simulate Form</button>

        <div id="result" class="debug-section">Cliquez sur un bouton pour commencer le test...</div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';

        async function testDataAvailability() {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'debug-section';
            resultDiv.textContent = '📋 Test Data Availability...\n\n';

            try {
                // Test services
                resultDiv.textContent += '1. Testing Services API...\n';
                const servicesResponse = await fetch(`${API_BASE}/api/commercial-services`);
                const servicesResult = await servicesResponse.json();
                
                resultDiv.textContent += `   Status: ${servicesResponse.status}\n`;
                resultDiv.textContent += `   Success: ${servicesResult.success}\n`;
                resultDiv.textContent += `   Count: ${servicesResult.data?.length || 0}\n`;
                
                if (servicesResult.data?.length > 0) {
                    const service = servicesResult.data[0];
                    resultDiv.textContent += `   First Service ID: ${service._id}\n`;
                    resultDiv.textContent += `   First Service Title: ${service.titre}\n`;
                } else {
                    resultDiv.textContent += '   ❌ No services found!\n';
                }
                
                resultDiv.textContent += '\n2. Testing Commercials API...\n';
                const commercialsResponse = await fetch(`${API_BASE}/api/commercial-new/admin/commercials`);
                const commercialsResult = await commercialsResponse.json();
                
                resultDiv.textContent += `   Status: ${commercialsResponse.status}\n`;
                resultDiv.textContent += `   Success: ${commercialsResult.success}\n`;
                resultDiv.textContent += `   Count: ${commercialsResult.data?.length || 0}\n`;
                
                if (commercialsResult.data?.length > 0) {
                    const commercial = commercialsResult.data[0];
                    resultDiv.textContent += `   First Commercial ID: ${commercial._id}\n`;
                    resultDiv.textContent += `   First Commercial PartnerID: ${commercial.partnerId}\n`;
                    resultDiv.textContent += `   First Commercial Name: ${commercial.fullName || commercial.nom}\n`;
                } else {
                    resultDiv.textContent += '   ❌ No commercials found!\n';
                }

                if (servicesResult.data?.length > 0 && commercialsResult.data?.length > 0) {
                    resultDiv.className = 'debug-section success';
                    resultDiv.textContent += '\n✅ Data is available for assignment!';
                } else {
                    resultDiv.className = 'debug-section error';
                    resultDiv.textContent += '\n❌ Missing data for assignment!';
                }

            } catch (error) {
                resultDiv.className = 'debug-section error';
                resultDiv.textContent += `\n❌ ERROR: ${error.message}`;
            }
        }

        async function testAssignmentCall() {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'debug-section';
            resultDiv.textContent = '🔗 Test Assignment Call...\n\n';

            try {
                // Get test data first
                const servicesResponse = await fetch(`${API_BASE}/api/commercial-services`);
                const servicesResult = await servicesResponse.json();
                
                const commercialsResponse = await fetch(`${API_BASE}/api/commercial-new/admin/commercials`);
                const commercialsResult = await commercialsResponse.json();

                if (!servicesResult.data?.length || !commercialsResult.data?.length) {
                    throw new Error('No test data available');
                }

                const service = servicesResult.data[0];
                const commercial = commercialsResult.data[0];

                const requestBody = {
                    serviceId: service._id,
                    partnerId: commercial.partnerId
                };

                resultDiv.textContent += 'REQUEST DATA:\n';
                resultDiv.textContent += `  URL: ${API_BASE}/api/commercial-new/admin/assign-service\n`;
                resultDiv.textContent += `  Method: POST\n`;
                resultDiv.textContent += `  Body: ${JSON.stringify(requestBody, null, 2)}\n\n`;

                resultDiv.textContent += 'VALIDATION:\n';
                resultDiv.textContent += `  serviceId exists: ${!!requestBody.serviceId}\n`;
                resultDiv.textContent += `  partnerId exists: ${!!requestBody.partnerId}\n`;
                resultDiv.textContent += `  serviceId length: ${requestBody.serviceId?.length || 0}\n`;
                resultDiv.textContent += `  partnerId format: ${requestBody.partnerId?.startsWith('COM-') ? 'Valid' : 'Invalid'}\n\n`;

                // Make the actual request
                resultDiv.textContent += 'MAKING REQUEST...\n';
                const assignResponse = await fetch(`${API_BASE}/api/commercial-new/admin/assign-service`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const assignResult = await assignResponse.json();

                resultDiv.textContent += `RESPONSE:\n`;
                resultDiv.textContent += `  Status: ${assignResponse.status}\n`;
                resultDiv.textContent += `  Success: ${assignResult.success}\n`;
                resultDiv.textContent += `  Message: ${assignResult.message}\n`;
                resultDiv.textContent += `  Full Response: ${JSON.stringify(assignResult, null, 2)}\n`;

                if (assignResult.success) {
                    resultDiv.className = 'debug-section success';
                    resultDiv.textContent += '\n✅ ASSIGNMENT SUCCESSFUL!';
                } else {
                    resultDiv.className = 'debug-section error';
                    resultDiv.textContent += `\n❌ ASSIGNMENT FAILED: ${assignResult.message}`;
                }

            } catch (error) {
                resultDiv.className = 'debug-section error';
                resultDiv.textContent += `\n❌ ERROR: ${error.message}`;
            }
        }

        async function simulateFormSubmission() {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'debug-section';
            resultDiv.textContent = '📝 Simulate Form Submission...\n\n';

            // Simulate the exact same flow as the React component
            const assignForm = {
                serviceId: '',
                commercialId: ''
            };

            resultDiv.textContent += 'STEP 1: Initial form state\n';
            resultDiv.textContent += `  assignForm: ${JSON.stringify(assignForm)}\n\n`;

            try {
                // Load services (simulate loadServices)
                resultDiv.textContent += 'STEP 2: Loading services...\n';
                const servicesResponse = await fetch(`${API_BASE}/api/commercial-services`);
                const servicesResult = await servicesResponse.json();
                
                if (servicesResult.data?.length > 0) {
                    assignForm.serviceId = servicesResult.data[0]._id;
                    resultDiv.textContent += `  Selected serviceId: ${assignForm.serviceId}\n`;
                } else {
                    throw new Error('No services available');
                }

                // Load commercials (simulate loadCommercials)
                resultDiv.textContent += 'STEP 3: Loading commercials...\n';
                const commercialsResponse = await fetch(`${API_BASE}/api/commercial-new/admin/commercials`);
                const commercialsResult = await commercialsResponse.json();
                
                if (commercialsResult.data?.length > 0) {
                    assignForm.commercialId = commercialsResult.data[0].partnerId;
                    resultDiv.textContent += `  Selected commercialId: ${assignForm.commercialId}\n`;
                } else {
                    throw new Error('No commercials available');
                }

                resultDiv.textContent += '\nSTEP 4: Form validation\n';
                if (!assignForm.serviceId || !assignForm.commercialId) {
                    throw new Error('Validation failed: missing serviceId or commercialId');
                }
                resultDiv.textContent += '  ✅ Validation passed\n';

                resultDiv.textContent += '\nSTEP 5: Preparing request\n';
                const requestBody = {
                    serviceId: assignForm.serviceId,
                    partnerId: assignForm.commercialId
                };
                resultDiv.textContent += `  Request body: ${JSON.stringify(requestBody, null, 2)}\n`;

                resultDiv.textContent += '\nSTEP 6: Sending request\n';
                const response = await fetch(`${API_BASE}/api/commercial-new/admin/assign-service`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                resultDiv.textContent += `  Response: ${JSON.stringify(result, null, 2)}\n`;

                if (result.success) {
                    resultDiv.className = 'debug-section success';
                    resultDiv.textContent += '\n🎉 FORM SIMULATION SUCCESSFUL!';
                } else {
                    resultDiv.className = 'debug-section error';
                    resultDiv.textContent += `\n❌ FORM SIMULATION FAILED: ${result.message}`;
                }

            } catch (error) {
                resultDiv.className = 'debug-section error';
                resultDiv.textContent += `\n❌ SIMULATION ERROR: ${error.message}`;
            }
        }

        window.onload = function() {
            console.log('🔧 Test Assignment Debug loaded');
        };
    </script>
</body>
</html>
