<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Services Sans Code Secret - MATC</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            color: #059669;
            border-bottom: 3px solid #d1fae5;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #f0fdf4;
        }
        
        button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        button:hover { 
            transform: translateY(-2px);
        }
        
        .success-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 20px 40px;
            font-size: 18px;
            width: 100%;
            margin: 20px 0;
        }
        
        input, select, textarea {
            padding: 10px;
            margin: 5px;
            border: 2px solid #d1fae5;
            border-radius: 8px;
            width: 200px;
            font-size: 14px;
        }
        
        .result {
            background: #1f2937;
            color: #f3f4f6;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success { 
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border: 2px solid #22c55e;
        }
        
        .error { 
            background: linear-gradient(135deg, #fef2f2 0%, #fde8e8 100%);
            color: #dc2626;
            border: 2px solid #ef4444;
        }
        
        .improvement {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 2px solid #10b981;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úÖ Services Sans Code Secret</h1>
            <p>Syst√®me simplifi√© - Plus de code secret requis!</p>
        </div>

        <!-- Am√©lioration -->
        <div class="improvement">
            <h3>üéâ Am√©lioration Appliqu√©e:</h3>
            <ul>
                <li><strong>‚úÖ Code secret supprim√©</strong> de tous les endpoints</li>
                <li><strong>‚úÖ Acc√®s direct</strong> aux fonctions admin</li>
                <li><strong>‚úÖ Interface simplifi√©e</strong> sans champs de s√©curit√©</li>
                <li><strong>‚úÖ Tests plus rapides</strong> et plus faciles</li>
            </ul>
        </div>

        <!-- Test Services -->
        <div class="test-section">
            <h3>üìã Test Services (Sans Code Secret)</h3>
            <button class="success-button" onclick="loadServices()">
                üîç CHARGER SERVICES
            </button>
            <div id="services-result" class="result"></div>
        </div>

        <!-- Cr√©er Service Simplifi√© -->
        <div class="test-section">
            <h3>‚ûï Cr√©er Service (Simplifi√©)</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="titre" placeholder="Titre" value="Formation PowerPoint">
                <input type="text" id="categorie" placeholder="Cat√©gorie" value="Bureautique">
                <input type="number" id="prixPublic" placeholder="Prix Public" value="600">
                <input type="number" id="prixCommercial" placeholder="Prix Commercial" value="480">
                <input type="number" id="commission" placeholder="Commission" value="120">
                <input type="text" id="duree" placeholder="Dur√©e" value="1 jour">
            </div>
            <textarea id="description" placeholder="Description">Formation compl√®te sur Microsoft PowerPoint</textarea>
            <br>
            <button onclick="createServiceSimple()">üöÄ Cr√©er Service (Sans Code)</button>
            <div id="create-result" class="result"></div>
        </div>

        <!-- Assigner Service Simplifi√© -->
        <div class="test-section">
            <h3>üîó Assigner Service (Simplifi√©)</h3>
            <select id="serviceSelect">
                <option value="">S√©lectionner un service</option>
            </select>
            <select id="commercialSelect">
                <option value="">S√©lectionner un commercial</option>
            </select>
            <br>
            <button onclick="loadOptions()">üîÑ Charger Options</button>
            <button onclick="assignServiceSimple()">üîó Assigner (Sans Code)</button>
            <div id="assign-result" class="result"></div>
        </div>

        <!-- Test Complet -->
        <div class="test-section">
            <h3>üß™ Test Complet du Syst√®me</h3>
            <button onclick="testComplete()">üöÄ Test Complet</button>
            <div id="complete-result" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api/commercial-new';

        async function loadServices() {
            const resultDiv = document.getElementById('services-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üîç Chargement des services (sans code secret)...\n\n';

            try {
                const response = await fetch(`${API_BASE}/admin/services`);
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 
                        `‚úÖ SUCC√àS! ${result.data.length} services charg√©s:\n\n`;
                    
                    result.data.forEach((service, index) => {
                        resultDiv.textContent += 
                            `${index + 1}. ${service.titre}\n` +
                            `   Cat√©gorie: ${service.categorie}\n` +
                            `   Prix: ${service.prixPublic}‚Ç¨ ‚Üí ${service.prixCommercial}‚Ç¨\n` +
                            `   Commission: ${service.commission}‚Ç¨\n` +
                            `   Dur√©e: ${service.duree}\n` +
                            `   Commerciaux: ${service.commerciauxAutorises.length}\n\n`;
                    });
                    
                    resultDiv.textContent += 
                        `üéâ PLUS BESOIN DE CODE SECRET!\n` +
                        `Le syst√®me fonctionne directement.`;
                        
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Erreur: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Erreur: ${error.message}`;
            }
        }

        async function createServiceSimple() {
            const resultDiv = document.getElementById('create-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üìù Cr√©ation sans code secret...\n\n';

            const serviceData = {
                titre: document.getElementById('titre').value,
                description: document.getElementById('description').value,
                categorie: document.getElementById('categorie').value,
                prixPublic: document.getElementById('prixPublic').value,
                prixCommercial: document.getElementById('prixCommercial').value,
                commission: document.getElementById('commission').value,
                duree: document.getElementById('duree').value
                // Plus de codeSecret!
            };

            try {
                const response = await fetch(`${API_BASE}/admin/services`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(serviceData)
                });

                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 
                        `‚úÖ SERVICE CR√â√â SANS CODE SECRET!\n\n` +
                        `Titre: ${result.data.titre}\n` +
                        `Cat√©gorie: ${result.data.categorie}\n` +
                        `Prix: ${result.data.prixPublic}‚Ç¨\n` +
                        `Commission: ${result.data.commission}‚Ç¨\n` +
                        `ID: ${result.data._id}\n\n` +
                        `üéâ Cr√©ation simplifi√©e r√©ussie!`;
                    
                    // Clear form
                    document.getElementById('titre').value = '';
                    document.getElementById('description').value = '';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Erreur: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Erreur: ${error.message}`;
            }
        }

        async function loadOptions() {
            // Charger services
            try {
                const servicesResponse = await fetch(`${API_BASE}/admin/services`);
                const servicesResult = await servicesResponse.json();
                
                const serviceSelect = document.getElementById('serviceSelect');
                serviceSelect.innerHTML = '<option value="">S√©lectionner un service</option>';
                
                if (servicesResult.success) {
                    servicesResult.data.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service._id;
                        option.textContent = `${service.titre} (${service.commission}‚Ç¨)`;
                        serviceSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erreur services:', error);
            }

            // Charger commerciaux
            try {
                const commerciauxResponse = await fetch('http://localhost:3001/api/partners?type=commercial');
                const commerciauxResult = await commerciauxResponse.json();
                
                const commercialSelect = document.getElementById('commercialSelect');
                commercialSelect.innerHTML = '<option value="">S√©lectionner un commercial</option>';
                
                if (commerciauxResult.success) {
                    commerciauxResult.data.forEach(commercial => {
                        const option = document.createElement('option');
                        option.value = commercial.partnerId;
                        option.textContent = `${commercial.fullName} (${commercial.partnerId})`;
                        commercialSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erreur commerciaux:', error);
            }
        }

        async function assignServiceSimple() {
            const resultDiv = document.getElementById('assign-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üîó Attribution sans code secret...\n\n';

            const assignData = {
                serviceId: document.getElementById('serviceSelect').value,
                partnerId: document.getElementById('commercialSelect').value
                // Plus de codeSecret!
            };

            if (!assignData.serviceId || !assignData.partnerId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Veuillez s√©lectionner un service et un commercial';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/assign-service`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(assignData)
                });

                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 
                        `‚úÖ ATTRIBUTION SANS CODE SECRET!\n\n` +
                        `Service: ${result.data.service}\n` +
                        `Commercial: ${result.data.commercial}\n` +
                        `Partner ID: ${result.data.partnerId}\n\n` +
                        `üéâ Attribution simplifi√©e r√©ussie!`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Erreur: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Erreur: ${error.message}`;
            }
        }

        async function testComplete() {
            const resultDiv = document.getElementById('complete-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üß™ Test complet du syst√®me sans code secret...\n\n';

            let allTests = [];

            // Test 1: Charger services
            try {
                const servicesResp = await fetch(`${API_BASE}/admin/services`);
                const servicesRes = await servicesResp.json();
                if (servicesRes.success) {
                    allTests.push(`‚úÖ Services: ${servicesRes.data.length} trouv√©s`);
                } else {
                    allTests.push(`‚ùå Services: ${servicesRes.message}`);
                }
            } catch (e) {
                allTests.push(`‚ùå Services: Erreur connexion`);
            }

            // Test 2: Charger commerciaux
            try {
                const commerciauxResp = await fetch('http://localhost:3001/api/partners?type=commercial');
                const commerciauxRes = await commerciauxResp.json();
                if (commerciauxRes.success) {
                    allTests.push(`‚úÖ Commerciaux: ${commerciauxRes.data.length} trouv√©s`);
                } else {
                    allTests.push(`‚ùå Commerciaux: ${commerciauxRes.message}`);
                }
            } catch (e) {
                allTests.push(`‚ùå Commerciaux: Erreur connexion`);
            }

            // Test 3: Test cr√©ation service
            try {
                const testService = {
                    titre: 'Test Service Auto',
                    description: 'Service cr√©√© automatiquement pour test',
                    categorie: 'Test',
                    prixPublic: 100,
                    prixCommercial: 80,
                    commission: 20,
                    duree: '1h'
                };

                const createResp = await fetch(`${API_BASE}/admin/services`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testService)
                });

                const createRes = await createResp.json();
                if (createRes.success) {
                    allTests.push(`‚úÖ Cr√©ation: Service test cr√©√©`);
                } else {
                    allTests.push(`‚ùå Cr√©ation: ${createRes.message}`);
                }
            } catch (e) {
                allTests.push(`‚ùå Cr√©ation: Erreur`);
            }

            // Afficher r√©sultats
            resultDiv.textContent += allTests.join('\n') + '\n\n';

            const successCount = allTests.filter(t => t.includes('‚úÖ')).length;
            const totalCount = allTests.length;

            if (successCount === totalCount) {
                resultDiv.className = 'result success';
                resultDiv.textContent += 
                    `üéâ TOUS LES TESTS R√âUSSIS! (${successCount}/${totalCount})\n\n` +
                    `‚úÖ Le syst√®me fonctionne parfaitement sans code secret!\n` +
                    `‚úÖ Admin Panel peut maintenant utiliser les services\n` +
                    `‚úÖ Cr√©ation et attribution simplifi√©es\n\n` +
                    `üöÄ Testez maintenant sur l'Admin Panel!`;
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent += 
                    `‚ö†Ô∏è Tests partiels: ${successCount}/${totalCount} r√©ussis\n` +
                    `V√©rifiez les erreurs ci-dessus.`;
            }
        }

        // Auto-load au chargement
        window.onload = function() {
            loadOptions();
            console.log('üéâ Syst√®me sans code secret charg√©!');
        };
    </script>
</body>
</html>
