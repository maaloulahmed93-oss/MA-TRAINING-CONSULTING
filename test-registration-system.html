<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Syst√®me d'Inscriptions MATC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .results {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-pending { background-color: #ffc107; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test - Syst√®me d'Inscriptions MATC</h1>
        <p><strong>Backend API:</strong> http://localhost:3001</p>
        <p><strong>Admin Panel:</strong> http://localhost:8536</p>
        <p><strong>Main Site:</strong> http://localhost:5173</p>
    </div>

    <!-- Test API Connection -->
    <div class="container">
        <h2>1. Test de Connexion API</h2>
        <div class="test-section info">
            <button onclick="testApiConnection()">Tester la Connexion</button>
            <div id="api-connection-result" class="results"></div>
        </div>
    </div>

    <!-- Create Test Registration -->
    <div class="container">
        <h2>2. Cr√©er une Inscription Test</h2>
        <div class="test-section">
            <div class="form-group">
                <label>Type:</label>
                <select id="registration-type">
                    <option value="program">Programme</option>
                    <option value="pack">Pack</option>
                </select>
            </div>
            <div class="form-group">
                <label>Nom du Programme/Pack:</label>
                <input type="text" id="item-name" value="Formation React Avanc√©e" placeholder="Nom du programme/pack">
            </div>
            <div class="form-group">
                <label>Pr√©nom:</label>
                <input type="text" id="first-name" value="Ahmed" placeholder="Pr√©nom">
            </div>
            <div class="form-group">
                <label>Nom:</label>
                <input type="text" id="last-name" value="Ben Ali" placeholder="Nom">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="email" value="ahmed.benali@example.com" placeholder="Email">
            </div>
            <div class="form-group">
                <label>WhatsApp (optionnel):</label>
                <input type="tel" id="whatsapp" value="+216 12 345 678" placeholder="WhatsApp">
            </div>
            <div class="form-group">
                <label>Prix:</label>
                <input type="number" id="price" value="299" placeholder="Prix">
            </div>
            <div class="form-group">
                <label>Session ID (pour programmes):</label>
                <input type="text" id="session-id" value="session-1" placeholder="Session ID">
            </div>
            <button onclick="createTestRegistration()">Cr√©er Inscription</button>
            <div id="create-registration-result" class="results"></div>
        </div>
    </div>

    <!-- List Registrations -->
    <div class="container">
        <h2>3. Liste des Inscriptions</h2>
        <div class="test-section">
            <button onclick="fetchRegistrations()">Charger les Inscriptions</button>
            <button onclick="fetchRegistrationStats()">Statistiques</button>
            <div id="registrations-result" class="results"></div>
            <div id="registrations-table"></div>
        </div>
    </div>

    <!-- Test Status Updates -->
    <div class="container">
        <h2>4. Test de Mise √† Jour de Statut</h2>
        <div class="test-section">
            <div class="form-group">
                <label>ID de l'inscription:</label>
                <input type="text" id="update-registration-id" placeholder="ID de l'inscription">
            </div>
            <div class="form-group">
                <label>Nouveau statut:</label>
                <select id="new-status">
                    <option value="pending">En attente</option>
                    <option value="confirmed">Confirm√©</option>
                    <option value="cancelled">Annul√©</option>
                </select>
            </div>
            <button onclick="updateRegistrationStatus()">Mettre √† Jour</button>
            <div id="update-status-result" class="results"></div>
        </div>
    </div>

    <!-- Test Frontend Integration -->
    <div class="container">
        <h2>5. Test d'Int√©gration Frontend</h2>
        <div class="test-section info">
            <p>Pour tester l'int√©gration compl√®te:</p>
            <ol>
                <li>Ouvrez <a href="http://localhost:5173" target="_blank">le site principal</a></li>
                <li>Naviguez vers la page des formations</li>
                <li>Cliquez sur "S'inscrire" pour un programme</li>
                <li>Remplissez et soumettez le formulaire</li>
                <li>V√©rifiez que l'inscription appara√Æt dans <a href="http://localhost:8536/registrations" target="_blank">l'admin panel</a></li>
            </ol>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3001/api';

        // Test API Connection
        async function testApiConnection() {
            const resultDiv = document.getElementById('api-connection-result');
            resultDiv.textContent = 'Test en cours...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.textContent = `‚úÖ Connexion r√©ussie!\n${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'results success';
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå Erreur de connexion: ${error.message}`;
                resultDiv.className = 'results error';
            }
        }

        // Create Test Registration
        async function createTestRegistration() {
            const resultDiv = document.getElementById('create-registration-result');
            resultDiv.textContent = 'Cr√©ation en cours...';
            
            const registrationData = {
                type: document.getElementById('registration-type').value,
                itemId: `item-${Date.now()}`,
                itemName: document.getElementById('item-name').value,
                price: parseInt(document.getElementById('price').value) || null,
                currency: '‚Ç¨',
                sessionId: document.getElementById('session-id').value || undefined,
                user: {
                    firstName: document.getElementById('first-name').value,
                    lastName: document.getElementById('last-name').value,
                    email: document.getElementById('email').value,
                    whatsapp: document.getElementById('whatsapp').value || undefined
                }
            };

            try {
                const response = await fetch(`${API_BASE_URL}/registrations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(registrationData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.textContent = `‚úÖ Inscription cr√©√©e avec succ√®s!\nID: ${data.data._id}\n${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'results success';
                    
                    // Auto-fill update form
                    document.getElementById('update-registration-id').value = data.data._id;
                } else {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå Erreur: ${error.message}`;
                resultDiv.className = 'results error';
            }
        }

        // Fetch Registrations
        async function fetchRegistrations() {
            const resultDiv = document.getElementById('registrations-result');
            const tableDiv = document.getElementById('registrations-table');
            resultDiv.textContent = 'Chargement...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/registrations`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.textContent = `‚úÖ ${data.data.length} inscriptions trouv√©es`;
                    resultDiv.className = 'results success';
                    
                    // Create table
                    if (data.data.length > 0) {
                        let tableHTML = `
                            <table>
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Nom</th>
                                        <th>Email</th>
                                        <th>Prix</th>
                                        <th>Statut</th>
                                        <th>Date</th>
                                        <th>ID</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.data.forEach(reg => {
                            const statusClass = reg.status === 'confirmed' ? 'status-success' : 
                                              reg.status === 'cancelled' ? 'status-error' : 'status-pending';
                            tableHTML += `
                                <tr>
                                    <td>${reg.type}</td>
                                    <td>${reg.user.firstName} ${reg.user.lastName}</td>
                                    <td>${reg.user.email}</td>
                                    <td>${reg.price ? reg.price + ' ' + reg.currency : '‚Äî'}</td>
                                    <td><span class="status-indicator ${statusClass}"></span>${reg.status}</td>
                                    <td>${new Date(reg.submittedAt).toLocaleString()}</td>
                                    <td>${reg._id}</td>
                                </tr>
                            `;
                        });
                        
                        tableHTML += '</tbody></table>';
                        tableDiv.innerHTML = tableHTML;
                    } else {
                        tableDiv.innerHTML = '<p>Aucune inscription trouv√©e.</p>';
                    }
                } else {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå Erreur: ${error.message}`;
                resultDiv.className = 'results error';
                tableDiv.innerHTML = '';
            }
        }

        // Fetch Registration Stats
        async function fetchRegistrationStats() {
            const resultDiv = document.getElementById('registrations-result');
            
            try {
                const response = await fetch(`${API_BASE_URL}/registrations/stats/summary`);
                const data = await response.json();
                
                if (response.ok) {
                    const stats = data.data;
                    resultDiv.textContent = `üìä Statistiques:
Total: ${stats.total}
En attente: ${stats.pending}
Confirm√©es: ${stats.confirmed}
Annul√©es: ${stats.cancelled}
Programmes: ${stats.programs}
Packs: ${stats.packs}`;
                    resultDiv.className = 'results info';
                } else {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå Erreur stats: ${error.message}`;
                resultDiv.className = 'results error';
            }
        }

        // Update Registration Status
        async function updateRegistrationStatus() {
            const resultDiv = document.getElementById('update-status-result');
            const registrationId = document.getElementById('update-registration-id').value;
            const newStatus = document.getElementById('new-status').value;
            
            if (!registrationId) {
                resultDiv.textContent = '‚ùå Veuillez saisir un ID d\'inscription';
                resultDiv.className = 'results error';
                return;
            }
            
            resultDiv.textContent = 'Mise √† jour en cours...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/registrations/${registrationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.textContent = `‚úÖ Statut mis √† jour: ${data.data.status}\n${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'results success';
                } else {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå Erreur: ${error.message}`;
                resultDiv.className = 'results error';
            }
        }

        // Auto-test on page load
        window.onload = function() {
            console.log('üß™ Page de test charg√©e');
            testApiConnection();
        };
    </script>
</body>
</html>
