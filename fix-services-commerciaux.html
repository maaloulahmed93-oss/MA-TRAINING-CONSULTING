<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Services Commerciaux - MATC</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            color: #2563eb;
            border-bottom: 3px solid #e5e7eb;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .fix-section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #f8fafc;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        button:hover { 
            transform: translateY(-2px);
        }
        
        .urgent-button {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            padding: 20px 40px;
            font-size: 18px;
            width: 100%;
            margin: 20px 0;
        }
        
        input, select, textarea {
            padding: 10px;
            margin: 5px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            width: 200px;
            font-size: 14px;
        }
        
        textarea {
            width: 400px;
            height: 80px;
        }
        
        .result {
            background: #1f2937;
            color: #f3f4f6;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success { 
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border: 2px solid #22c55e;
        }
        
        .error { 
            background: linear-gradient(135deg, #fef2f2 0%, #fde8e8 100%);
            color: #dc2626;
            border: 2px solid #ef4444;
        }
        
        .problem {
            background: linear-gradient(135deg, #fef2f2 0%, #fde8e8 100%);
            border: 2px solid #ef4444;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è Fix Services Commerciaux</h1>
            <p>R√©soudre le probl√®me "Aucun service cr√©√©"</p>
        </div>

        <!-- Probl√®me identifi√© -->
        <div class="problem">
            <h3>üö® Probl√®me Identifi√©:</h3>
            <ul>
                <li><strong>Page Admin:</strong> "Gestion des Services Commerciaux"</li>
                <li><strong>Erreur:</strong> "Aucun service cr√©√©"</li>
                <li><strong>Console:</strong> Erreurs 404 sur /api/commercial-new/admin/services</li>
                <li><strong>Cause:</strong> Base de donn√©es vide, pas de services cr√©√©s</li>
            </ul>
        </div>

        <!-- Fix Imm√©diat -->
        <div class="fix-section">
            <h3>üöÄ Fix Imm√©diat</h3>
            <button class="urgent-button" onclick="fixImmediate()">
                üîß CR√âER SERVICES PAR D√âFAUT
            </button>
            <div id="fix-result" class="result"></div>
        </div>

        <!-- Test Services -->
        <div class="fix-section">
            <h3>üìã Test Services</h3>
            <button onclick="loadServices()">üîç Charger Services</button>
            <button onclick="testEndpoint()">üß™ Test Endpoint</button>
            <div id="services-result" class="result"></div>
        </div>

        <!-- Cr√©er Nouveau Service -->
        <div class="fix-section">
            <h3>‚ûï Cr√©er Nouveau Service</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="titre" placeholder="Titre du service" value="Formation Excel">
                <input type="text" id="categorie" placeholder="Cat√©gorie" value="Bureautique">
                <input type="number" id="prixPublic" placeholder="Prix Public (‚Ç¨)" value="500">
                <input type="number" id="prixCommercial" placeholder="Prix Commercial (‚Ç¨)" value="400">
                <input type="number" id="commission" placeholder="Commission (‚Ç¨)" value="100">
                <input type="text" id="duree" placeholder="Dur√©e" value="1 jour">
            </div>
            <textarea id="description" placeholder="Description du service">Formation compl√®te sur Microsoft Excel pour am√©liorer la productivit√©</textarea>
            <br>
            <button onclick="createService()">üöÄ Cr√©er Service</button>
            <div id="create-result" class="result"></div>
        </div>

        <!-- Assigner Service -->
        <div class="fix-section">
            <h3>üîó Assigner Service √† Commercial</h3>
            <select id="serviceSelect">
                <option value="">S√©lectionner un service</option>
            </select>
            <select id="commercialSelect">
                <option value="">S√©lectionner un commercial</option>
            </select>
            <br>
            <button onclick="loadSelectOptions()">üîÑ Charger Options</button>
            <button onclick="assignService()">üîó Assigner</button>
            <div id="assign-result" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api/commercial-new';

        async function fixImmediate() {
            const resultDiv = document.getElementById('fix-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üöÄ Fix imm√©diat en cours...\n\n';

            try {
                // Appeler l'endpoint qui va cr√©er les services par d√©faut
                const response = await fetch(`${API_BASE}/admin/services`);
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 
                        `‚úÖ FIX R√âUSSI!\n\n` +
                        `Message: ${result.message}\n` +
                        `Services cr√©√©s: ${result.data.length}\n\n` +
                        `üìã Services disponibles:\n`;
                    
                    result.data.forEach((service, index) => {
                        resultDiv.textContent += 
                            `${index + 1}. ${service.titre}\n` +
                            `   Cat√©gorie: ${service.categorie}\n` +
                            `   Prix: ${service.prixPublic}‚Ç¨ (Commission: ${service.commission}‚Ç¨)\n` +
                            `   Dur√©e: ${service.duree}\n\n`;
                    });
                    
                    resultDiv.textContent += 
                        `üéØ TESTEZ MAINTENANT:\n` +
                        `1. Rechargez la page Admin Panel\n` +
                        `2. Allez sur "Gestion des Services Commerciaux"\n` +
                        `3. Les services devraient maintenant appara√Ætre!`;
                        
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Erreur: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Erreur: ${error.message}`;
            }
        }

        async function loadServices() {
            const resultDiv = document.getElementById('services-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üîç Chargement des services...\n\n';

            try {
                const response = await fetch(`${API_BASE}/admin/services`);
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 
                        `‚úÖ ${result.data.length} services trouv√©s:\n\n`;
                    
                    result.data.forEach((service, index) => {
                        resultDiv.textContent += 
                            `${index + 1}. ${service.titre}\n` +
                            `   ID: ${service._id}\n` +
                            `   Cat√©gorie: ${service.categorie}\n` +
                            `   Prix Public: ${service.prixPublic}‚Ç¨\n` +
                            `   Prix Commercial: ${service.prixCommercial}‚Ç¨\n` +
                            `   Commission: ${service.commission}‚Ç¨\n` +
                            `   Dur√©e: ${service.duree}\n` +
                            `   Commerciaux autoris√©s: ${service.commerciauxAutorises.length}\n\n`;
                    });
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Erreur: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Erreur: ${error.message}`;
            }
        }

        async function testEndpoint() {
            const resultDiv = document.getElementById('services-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üß™ Test endpoint...\n\n';

            try {
                const response = await fetch(`${API_BASE}/admin/services`);
                resultDiv.textContent += `Status: ${response.status}\n`;
                resultDiv.textContent += `Headers: ${JSON.stringify([...response.headers.entries()], null, 2)}\n\n`;
                
                const result = await response.json();
                resultDiv.textContent += `Response: ${JSON.stringify(result, null, 2)}`;
                
                if (result.success) {
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `‚ùå Erreur: ${error.message}`;
            }
        }

        async function createService() {
            const resultDiv = document.getElementById('create-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üìù Cr√©ation du service...\n\n';

            const serviceData = {
                titre: document.getElementById('titre').value,
                description: document.getElementById('description').value,
                categorie: document.getElementById('categorie').value,
                prixPublic: document.getElementById('prixPublic').value,
                prixCommercial: document.getElementById('prixCommercial').value,
                commission: document.getElementById('commission').value,
                duree: document.getElementById('duree').value
            };

            try {
                const response = await fetch(`${API_BASE}/admin/services`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(serviceData)
                });

                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 
                        `‚úÖ Service cr√©√© avec succ√®s!\n\n` +
                        `Titre: ${result.data.titre}\n` +
                        `Cat√©gorie: ${result.data.categorie}\n` +
                        `Prix: ${result.data.prixPublic}‚Ç¨\n` +
                        `Commission: ${result.data.commission}‚Ç¨\n` +
                        `ID: ${result.data._id}`;
                    
                    // Clear form
                    document.getElementById('titre').value = '';
                    document.getElementById('description').value = '';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Erreur: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Erreur: ${error.message}`;
            }
        }

        async function loadSelectOptions() {
            // Charger les services
            try {
                const servicesResponse = await fetch(`${API_BASE}/admin/services`);
                const servicesResult = await servicesResponse.json();
                
                const serviceSelect = document.getElementById('serviceSelect');
                serviceSelect.innerHTML = '<option value="">S√©lectionner un service</option>';
                
                if (servicesResult.success) {
                    servicesResult.data.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service._id;
                        option.textContent = `${service.titre} (${service.commission}‚Ç¨)`;
                        serviceSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erreur chargement services:', error);
            }

            // Charger les commerciaux
            try {
                const commerciauxResponse = await fetch('http://localhost:3001/api/partners?type=commercial');
                const commerciauxResult = await commerciauxResponse.json();
                
                const commercialSelect = document.getElementById('commercialSelect');
                commercialSelect.innerHTML = '<option value="">S√©lectionner un commercial</option>';
                
                if (commerciauxResult.success) {
                    commerciauxResult.data.forEach(commercial => {
                        const option = document.createElement('option');
                        option.value = commercial.partnerId;
                        option.textContent = `${commercial.fullName} (${commercial.partnerId})`;
                        commercialSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erreur chargement commerciaux:', error);
            }
        }

        async function assignService() {
            const resultDiv = document.getElementById('assign-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üîó Attribution en cours...\n\n';

            const assignData = {
                serviceId: document.getElementById('serviceSelect').value,
                partnerId: document.getElementById('commercialSelect').value
            };

            if (!assignData.serviceId || !assignData.partnerId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Veuillez s√©lectionner un service et un commercial';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/assign-service`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(assignData)
                });

                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 
                        `‚úÖ Attribution r√©ussie!\n\n` +
                        `Service: ${result.data.service}\n` +
                        `Commercial: ${result.data.commercial}\n` +
                        `Partner ID: ${result.data.partnerId}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Erreur: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Erreur: ${error.message}`;
            }
        }

        // Auto-load au chargement
        window.onload = function() {
            loadSelectOptions();
        };
    </script>
</body>
</html>
