# IDE Note: Warnings about ${{ secrets.* }} context access are false positives
# This is the official GitHub Actions syntax and will work correctly at runtime
name: 🚀 Deploy MATC Frontend to Vercel

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

jobs:
  deploy-frontend:
    name: 🌐 Deploy Frontend
    runs-on: ubuntu-latest
    
    environment:
      name: production
      url: https://matrainingconsulting.vercel.app
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: 📦 Install Dependencies
        run: |
          npm ci
          npm audit --audit-level=high

      - name: 🔍 Validate Environment Variables
        run: |
          echo "Validating required environment variables..."
          if [ -z "$VITE_API_BASE_URL" ]; then
            echo "❌ VITE_API_BASE_URL is not set"
            exit 1
          fi
          echo "✅ All required environment variables are set"
          echo "🔗 API Base URL: $VITE_API_BASE_URL"
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

      - name: 🧪 Backend Health Check
        run: |
          echo "Checking backend health before deployment..."
          
          # Wait for backend to be ready
          for i in {1..5}; do
            echo "Backend health check attempt $i/5..."
            
            if curl -f -s "$VITE_API_BASE_URL/health"; then
              echo "✅ Backend is healthy!"
              break
            else
              echo "⏳ Backend not ready, waiting 30 seconds..."
              sleep 30
            fi
            
            if [ $i -eq 5 ]; then
              echo "❌ Backend health check failed"
              exit 1
            fi
          done
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

      - name: 🏗️ Build Application
        run: |
          npm run build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_APP_NAME: ${{ secrets.VITE_APP_NAME }}
          VITE_APP_VERSION: ${{ secrets.VITE_APP_VERSION }}
          NODE_ENV: production

      - name: 🧪 Test Build
        run: |
          echo "Testing build output..."
          if [ ! -d "dist" ]; then
            echo "❌ Build failed - dist directory not found"
            exit 1
          fi
          
          if [ ! -f "dist/index.html" ]; then
            echo "❌ Build failed - index.html not found"
            exit 1
          fi
          
          echo "✅ Build output validated"

      - name: 🚀 Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./

      - name: ⏳ Wait for Deployment
        run: |
          echo "Waiting for Vercel deployment to propagate..."
          sleep 45

      - name: 🧪 Frontend Health Check
        run: |
          echo "Running frontend health check..."
          
          # Health check with retry
          for i in {1..5}; do
            echo "Frontend health check attempt $i/5..."
            
            response=$(curl -s -o /dev/null -w "%{http_code}" "https://matrainingconsulting.vercel.app")
            
            if [ "$response" = "200" ]; then
              echo "✅ Frontend health check passed!"
              break
            else
              echo "⏳ Frontend not ready (HTTP $response), retrying in 15 seconds..."
              sleep 15
            fi
            
            if [ $i -eq 5 ]; then
              echo "❌ Frontend health check failed"
              exit 1
            fi
          done

      - name: 🧪 API Connectivity Test
        run: |
          echo "Testing API connectivity from frontend..."
          
          # Test API endpoints
          endpoints=("/health" "/programs" "/categories")
          
          for endpoint in "${endpoints[@]}"; do
            echo "Testing endpoint: $endpoint"
            
            if curl -f -s "$VITE_API_BASE_URL$endpoint" > /dev/null; then
              echo "✅ $endpoint - OK"
            else
              echo "❌ $endpoint - Failed"
              exit 1
            fi
          done
          
          echo "✅ All API endpoints are accessible"
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

      - name: 📊 Deployment Summary
        run: |
          echo "## 🎉 Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ✅ Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend URL**: https://matrainingconsulting.vercel.app" >> $GITHUB_STEP_SUMMARY
          echo "- **API Connectivity**: ✅ Verified" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY

  notify:
    name: 📢 Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy-frontend
    if: always()
    
    steps:
      - name: 📢 Deployment Notification
        run: |
          if [ "${{ needs.deploy-frontend.result }}" = "success" ]; then
            echo "✅ MATC Frontend deployment successful!"
            echo "🔗 Frontend URL: https://matrainingconsulting.vercel.app"
            echo "🧪 API Connectivity: Verified"
          else
            echo "❌ MATC Frontend deployment failed!"
            echo "Please check the deployment logs for details."
          fi
