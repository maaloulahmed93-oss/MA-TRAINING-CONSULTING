<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Debug Test - MATC</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            color: #7c3aed;
            border-bottom: 3px solid #e9d5ff;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .ultimate-section {
            margin-bottom: 30px;
            padding: 25px;
            border: 3px solid #7c3aed;
            border-radius: 12px;
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
        }
        
        button {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        button:hover { 
            transform: translateY(-2px);
        }
        
        .ultimate-button {
            padding: 25px 50px;
            font-size: 22px;
            width: 100%;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .result {
            background: #1f2937;
            color: #f3f4f6;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .success { 
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border: 2px solid #22c55e;
        }
        
        .error { 
            background: linear-gradient(135deg, #fef2f2 0%, #fde8e8 100%);
            color: #dc2626;
            border: 2px solid #ef4444;
        }
        
        .warning { 
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
            color: #92400e;
            border: 2px solid #f59e0b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÆ Ultimate Debug Test</h1>
            <p>Test ultime pour identifier le probl√®me exact</p>
        </div>

        <!-- Ultimate Analysis -->
        <div class="ultimate-section">
            <h3>üîÆ ULTIMATE ANALYSIS:</h3>
            <ul>
                <li>üîç <strong>Network Tab:</strong> Requests arrivent et retournent 200 OK</li>
                <li>üîç <strong>API Response:</strong> Contient les services (visible dans Network)</li>
                <li>üîç <strong>React State:</strong> Reste √† 0 malgr√© les donn√©es</li>
                <li>üîç <strong>Nuclear Fix:</strong> N'a pas fonctionn√©</li>
                <li>üîç <strong>Debug Info:</strong> Montre Key/Force qui changent mais services = 0</li>
            </ul>
            <p><strong>üéØ CONCLUSION:</strong> React state est compl√®tement cass√© ou il y a un bug plus profond</p>
        </div>

        <!-- Ultimate Test -->
        <div style="text-align: center;">
            <button class="ultimate-button" onclick="ultimateTest()">
                üîÆ ULTIMATE TEST - DIAGNOSTIC FINAL
            </button>
            <div id="ultimate-result" class="result"></div>
        </div>

        <!-- Tests Sp√©cifiques -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
            <div style="padding: 20px; border: 2px solid #e5e7eb; border-radius: 8px;">
                <h3>üß™ Test React Simulation</h3>
                <button onclick="testReactSimulation()">‚öõÔ∏è Simuler React</button>
                <div id="react-result" class="result"></div>
            </div>
            
            <div style="padding: 20px; border: 2px solid #e5e7eb; border-radius: 8px;">
                <h3>üî¨ Test Memory/Cache</h3>
                <button onclick="testMemoryCache()">üíæ Test Cache</button>
                <div id="cache-result" class="result"></div>
            </div>
        </div>

        <!-- Solution Finale -->
        <div style="margin-top: 30px; padding: 25px; background: #f3e8ff; border: 2px solid #7c3aed; border-radius: 10px;">
            <h3>üîÆ Solutions Finales:</h3>
            <ol>
                <li><strong>Hard Refresh:</strong> Ctrl+Shift+R (clear cache)</li>
                <li><strong>Incognito Mode:</strong> Test sans extensions</li>
                <li><strong>Different Browser:</strong> Test Chrome/Firefox/Edge</li>
                <li><strong>Direct HTML:</strong> Bypass React compl√®tement</li>
                <li><strong>Admin Panel Rebuild:</strong> npm run build</li>
            </ol>
            
            <h4>üéØ Si rien ne marche:</h4>
            <p>Le probl√®me est dans l'environnement de d√©veloppement ou une corruption du cache/build</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api/commercial-new';

        async function ultimateTest() {
            const resultDiv = document.getElementById('ultimate-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üîÆ ULTIMATE TEST EN COURS...\n\n';

            try {
                // Test 1: API Direct
                resultDiv.textContent += '1Ô∏è‚É£ TEST API DIRECT...\n';
                const response = await fetch(`${API_BASE}/admin/services`);
                const result = await response.json();
                
                resultDiv.textContent += `Status: ${response.status}\n`;
                resultDiv.textContent += `Success: ${result.success}\n`;
                resultDiv.textContent += `Data Count: ${result.data?.length || 0}\n\n`;

                if (result.success && result.data && result.data.length > 0) {
                    resultDiv.textContent += `‚úÖ API FONCTIONNE PARFAITEMENT!\n`;
                    resultDiv.textContent += `${result.data.length} services trouv√©s:\n\n`;
                    
                    result.data.forEach((service, index) => {
                        resultDiv.textContent += 
                            `${index + 1}. ${service.titre}\n` +
                            `   Commission: ${service.commission}‚Ç¨\n` +
                            `   Cr√©√©: ${new Date(service.createdAt).toLocaleString()}\n` +
                            `   ID: ${service._id}\n\n`;
                    });

                    // Test 2: Simulation React setState
                    resultDiv.textContent += '2Ô∏è‚É£ SIMULATION REACT SETSTATE...\n';
                    
                    // Simuler ce que React devrait faire
                    let simulatedState = [];
                    resultDiv.textContent += `√âtat initial: ${simulatedState.length}\n`;
                    
                    // Simuler setServices([])
                    simulatedState = [];
                    resultDiv.textContent += `Apr√®s clear: ${simulatedState.length}\n`;
                    
                    // Simuler setServices(newData)
                    simulatedState = [...result.data];
                    resultDiv.textContent += `Apr√®s set: ${simulatedState.length}\n`;
                    
                    if (simulatedState.length > 0) {
                        resultDiv.textContent += '‚úÖ Simulation React fonctionne!\n\n';
                    }

                    // Test 3: Test localStorage/sessionStorage
                    resultDiv.textContent += '3Ô∏è‚É£ TEST STORAGE...\n';
                    try {
                        localStorage.setItem('test-services', JSON.stringify(result.data));
                        const stored = JSON.parse(localStorage.getItem('test-services') || '[]');
                        resultDiv.textContent += `LocalStorage: ${stored.length} services\n`;
                        localStorage.removeItem('test-services');
                    } catch (e) {
                        resultDiv.textContent += `LocalStorage error: ${e.message}\n`;
                    }

                    // Test 4: Test DOM Manipulation
                    resultDiv.textContent += '\n4Ô∏è‚É£ TEST DOM DIRECT...\n';
                    const testDiv = document.createElement('div');
                    testDiv.innerHTML = `<p>Services: ${result.data.length}</p>`;
                    resultDiv.textContent += `DOM Test: ${testDiv.textContent}\n`;

                    // Diagnostic Final
                    resultDiv.className = 'result warning';
                    resultDiv.textContent += 
                        '\nüîÆ DIAGNOSTIC FINAL:\n\n' +
                        '‚úÖ API: Fonctionne parfaitement\n' +
                        '‚úÖ Donn√©es: Pr√©sentes et valides\n' +
                        '‚úÖ Simulation React: Fonctionne\n' +
                        '‚úÖ Storage: Fonctionne\n' +
                        '‚úÖ DOM: Fonctionne\n\n' +
                        '‚ùå PROBL√àME IDENTIFI√â:\n' +
                        'React dans Admin Panel est CASS√â\n\n' +
                        'üîß SOLUTIONS RECOMMAND√âES:\n' +
                        '1. Hard refresh (Ctrl+Shift+R)\n' +
                        '2. Mode incognito\n' +
                        '3. Autre navigateur\n' +
                        '4. Rebuild admin panel\n' +
                        '5. Red√©marrer dev server\n\n' +
                        'üéØ Si rien ne marche:\n' +
                        'Cr√©er une nouvelle page admin\n' +
                        'sans React state management';

                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent += '‚ùå API ne retourne pas de donn√©es';
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `‚ùå ERREUR: ${error.message}`;
            }
        }

        async function testReactSimulation() {
            const resultDiv = document.getElementById('react-result');
            resultDiv.className = 'result';
            resultDiv.textContent = '‚öõÔ∏è Test React Simulation...\n\n';

            try {
                // Simuler exactement ce que fait React
                const response = await fetch(`${API_BASE}/admin/services`);
                const result = await response.json();

                if (result.success && result.data) {
                    // Simuler le processus React
                    resultDiv.textContent += 'Simulation du processus React:\n\n';
                    
                    // 1. useState initial
                    let services = [];
                    resultDiv.textContent += `1. useState initial: ${services.length}\n`;
                    
                    // 2. Deep clone (comme dans le code)
                    const newServices = JSON.parse(JSON.stringify(result.data));
                    resultDiv.textContent += `2. Deep clone: ${newServices.length}\n`;
                    
                    // 3. setServices([])
                    services = [];
                    resultDiv.textContent += `3. setServices([]): ${services.length}\n`;
                    
                    // 4. setTimeout + setServices(newData)
                    setTimeout(() => {
                        services = newServices;
                        resultDiv.textContent += `4. setServices(newData): ${services.length}\n`;
                        
                        if (services.length > 0) {
                            resultDiv.className = 'result success';
                            resultDiv.textContent += '\n‚úÖ React simulation fonctionne!\n';
                            resultDiv.textContent += 'Le probl√®me est dans React lui-m√™me.';
                        }
                    }, 10);
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `‚ùå Erreur: ${error.message}`;
            }
        }

        async function testMemoryCache() {
            const resultDiv = document.getElementById('cache-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üíæ Test Memory/Cache...\n\n';

            // Test cache navigator
            resultDiv.textContent += 'Cache Navigator:\n';
            resultDiv.textContent += `Storage quota: ${navigator.storage ? 'Available' : 'Not available'}\n`;
            
            // Test localStorage
            resultDiv.textContent += '\nLocalStorage:\n';
            resultDiv.textContent += `Length: ${localStorage.length}\n`;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('service')) {
                    resultDiv.textContent += `Key: ${key}\n`;
                }
            }
            
            // Test sessionStorage
            resultDiv.textContent += '\nSessionStorage:\n';
            resultDiv.textContent += `Length: ${sessionStorage.length}\n`;
            
            // Test memory usage
            if (performance.memory) {
                resultDiv.textContent += '\nMemory Usage:\n';
                resultDiv.textContent += `Used: ${Math.round(performance.memory.usedJSHeapSize / 1048576)}MB\n`;
                resultDiv.textContent += `Total: ${Math.round(performance.memory.totalJSHeapSize / 1048576)}MB\n`;
            }
            
            resultDiv.className = 'result success';
            resultDiv.textContent += '\n‚úÖ Memory/Cache test completed';
        }

        // Auto-message
        window.onload = function() {
            console.log('üîÆ Ultimate Debug Test charg√©');
        };
    </script>
</body>
</html>
