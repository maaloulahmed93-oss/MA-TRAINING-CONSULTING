<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Project Data - PART-177037</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f7fa; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 30px; text-align: center; }
        .section { padding: 20px; border-bottom: 1px solid #e2e8f0; }
        .section:last-child { border-bottom: none; }
        .test-button { background: #4299e1; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin: 5px; font-weight: 500; }
        .test-button:hover { background: #3182ce; }
        .test-button.success { background: #38a169; }
        .test-button.error { background: #e53e3e; }
        .result { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .success { background: #c6f6d5; border-color: #38a169; color: #22543d; }
        .error { background: #fed7d7; border-color: #e53e3e; color: #c53030; }
        .warning { background: #fef5e7; border-color: #d69e2e; color: #c05621; }
        .info { background: #bee3f8; border-color: #3182ce; color: #2c5282; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .project-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .project-title { font-weight: 600; color: #2d3748; margin-bottom: 8px; }
        .project-field { font-size: 12px; color: #718096; margin: 4px 0; }
        .highlight { background: #fef3c7; padding: 2px 4px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Debug Project Data</h1>
            <p>Analyse des donn√©es du projet PART-177037 "dbdc"</p>
            <div style="font-size: 14px; margin-top: 20px; opacity: 0.9;">
                Diagnostic du probl√®me "Pas de lien"
            </div>
        </div>

        <div class="section">
            <h2>üéØ Probl√®me Actuel</h2>
            <div class="warning">
                <h3>‚ö†Ô∏è Sympt√¥mes Observ√©s</h3>
                <ul>
                    <li>Console log: "üìã Ouverture des d√©tails du projet (pas de lien)"</li>
                    <li>Modal affiche "Pas de lien" au lieu de "Ouvrir lien"</li>
                    <li>Panel Admin montre le lien correctement</li>
                    <li>API semble r√©cup√©rer les donn√©es</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>üîç Tests de Diagnostic</h2>
            
            <div class="grid">
                <div class="card">
                    <h3>üîå Test API Direct</h3>
                    <button class="test-button" onclick="testApiDirect()">GET /participants/PART-177037/projects</button>
                    <div id="api-direct-result" class="result"></div>
                </div>
                
                <div class="card">
                    <h3>üë§ Test Participant Data</h3>
                    <button class="test-button" onclick="testParticipantData()">GET /participants/PART-177037</button>
                    <div id="participant-data-result" class="result"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üîÑ Transformation Debug</h2>
            <button class="test-button" onclick="testTransformation()">Tester Transformation API ‚Üí Frontend</button>
            <div id="transformation-result" class="result"></div>
        </div>

        <div class="section">
            <h2>üìä Analyse D√©taill√©e</h2>
            <div id="detailed-analysis"></div>
        </div>

        <div class="section">
            <h2>üõ†Ô∏è Solutions Possibles</h2>
            
            <div class="info">
                <h3>üí° Actions Recommand√©es</h3>
                <ol>
                    <li><strong>V√©rifier Backend:</strong> Red√©marrer le serveur backend</li>
                    <li><strong>Mettre √† jour Projet:</strong> Modifier le projet dans Panel Admin</li>
                    <li><strong>V√©rifier Base:</strong> Ex√©cuter script de mise √† jour</li>
                    <li><strong>Test Frontend:</strong> Rafra√Æchir l'Espace Participant</li>
                </ol>
            </div>

            <div class="grid">
                <div class="card">
                    <h4>üîß Solution 1: Panel Admin</h4>
                    <ol style="font-size: 14px;">
                        <li>Ouvrir Panel Admin</li>
                        <li>Chercher participant PART-177037</li>
                        <li>Modifier le projet "dbdc"</li>
                        <li>Re-saisir le lien</li>
                        <li>Sauvegarder</li>
                    </ol>
                </div>
                
                <div class="card">
                    <h4>üóÑÔ∏è Solution 2: Backend Script</h4>
                    <ol style="font-size: 14px;">
                        <li>Aller dans /backend</li>
                        <li>Ex√©cuter: node update-existing-projects.js</li>
                        <li>V√©rifier les logs</li>
                        <li>Red√©marrer backend</li>
                        <li>Tester √† nouveau</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        const PARTICIPANT_ID = 'PART-177037';
        
        async function testApiDirect() {
            const resultDiv = document.getElementById('api-direct-result');
            resultDiv.textContent = 'Test en cours...';
            
            try {
                console.log('üîç Test API Direct pour PART-177037');
                const response = await fetch(`${API_BASE}/participants/${PARTICIPANT_ID}/projects`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üìä API Direct Response:', result);
                    
                    if (result.success && result.data.length > 0) {
                        const project = result.data[0]; // Premier projet
                        
                        resultDiv.className = 'result success';
                        resultDiv.innerHTML = `
                            <strong>‚úÖ API Direct OK</strong><br>
                            Projets trouv√©s: ${result.data.length}<br><br>
                            <strong>Projet "dbdc":</strong><br>
                            ‚Ä¢ ID: ${project._id}<br>
                            ‚Ä¢ Titre: ${project.title}<br>
                            ‚Ä¢ Description: ${project.description}<br>
                            ‚Ä¢ Status: ${project.status}<br>
                            ‚Ä¢ ProjectUrl: <span class="highlight">${project.projectUrl || 'VIDE/ABSENT'}</span><br>
                            ‚Ä¢ ParticipantId: ${project.participantId}<br>
                            ‚Ä¢ IsActive: ${project.isActive}<br><br>
                            <strong>Raw Data:</strong><br>
                            <pre>${JSON.stringify(project, null, 2)}</pre>
                        `;
                        
                        return result.data;
                    } else {
                        resultDiv.className = 'result warning';
                        resultDiv.innerHTML = '<strong>‚ö†Ô∏è Aucun projet trouv√©</strong>';
                        return [];
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Erreur API Direct:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>‚ùå Erreur API</strong><br>${error.message}`;
                return null;
            }
        }
        
        async function testParticipantData() {
            const resultDiv = document.getElementById('participant-data-result');
            resultDiv.textContent = 'Test en cours...';
            
            try {
                console.log('üë§ Test Participant Data pour PART-177037');
                const response = await fetch(`${API_BASE}/participants/${PARTICIPANT_ID}`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üë§ Participant Data Response:', result);
                    
                    if (result.success && result.data) {
                        const projects = result.data.projects || [];
                        
                        resultDiv.className = 'result success';
                        resultDiv.innerHTML = `
                            <strong>‚úÖ Participant Data OK</strong><br>
                            Participant: ${result.data.fullName}<br>
                            Projets dans data: ${projects.length}<br><br>
                            ${projects.map((project, index) => `
                                <strong>Projet ${index + 1}:</strong><br>
                                ‚Ä¢ Titre: ${project.title}<br>
                                ‚Ä¢ ProjectUrl: <span class="highlight">${project.projectUrl || 'VIDE/ABSENT'}</span><br>
                                ‚Ä¢ Status: ${project.status}<br><br>
                            `).join('')}
                        `;
                        
                        return projects;
                    } else {
                        resultDiv.className = 'result warning';
                        resultDiv.innerHTML = '<strong>‚ö†Ô∏è Participant non trouv√©</strong>';
                        return [];
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Erreur Participant Data:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>‚ùå Erreur API</strong><br>${error.message}`;
                return null;
            }
        }
        
        async function testTransformation() {
            const resultDiv = document.getElementById('transformation-result');
            resultDiv.textContent = 'Test en cours...';
            
            // Get data from API
            const apiProjects = await testApiDirect();
            if (!apiProjects || apiProjects.length === 0) {
                resultDiv.className = 'result warning';
                resultDiv.innerHTML = '<strong>‚ö†Ô∏è Pas de donn√©es √† transformer</strong>';
                return;
            }
            
            try {
                console.log('üîÑ Test Transformation');
                
                // Simulate the transformation from Projets.tsx
                const transformApiProject = (apiProject) => {
                    const statusMapping = {
                        'not_started': 'En attente',
                        'in_progress': 'En attente', 
                        'submitted': 'En attente',
                        'accepted': 'Accept√©',
                        'rejected': 'Refus√©',
                        'revision_needed': 'En r√©vision'
                    };

                    return {
                        id: apiProject._id,
                        title: apiProject.title,
                        description: apiProject.description,
                        formationId: apiProject.formationId || '',
                        formationTitle: apiProject.formationTitle || 'Formation non sp√©cifi√©e',
                        status: statusMapping[apiProject.status] || 'En attente',
                        submittedDate: apiProject.submittedDate,
                        dueDate: apiProject.dueDate || new Date().toISOString(),
                        feedback: apiProject.feedback,
                        grade: apiProject.grade,
                        projectUrl: apiProject.projectUrl || apiProject.files?.[0]?.url,
                        files: (apiProject.files || []).map(file => ({
                            id: file.id,
                            name: file.name,
                            size: file.size || '0 KB',
                            type: file.type || 'unknown',
                            uploadDate: file.uploadDate || new Date().toISOString()
                        }))
                    };
                };

                const transformedProject = transformApiProject(apiProjects[0]);
                console.log('‚úÖ Projet transform√©:', transformedProject);

                // Simulate the handleAccessProject logic
                const hasUrl = transformedProject.projectUrl && transformedProject.projectUrl.trim();
                
                resultDiv.className = hasUrl ? 'result success' : 'result warning';
                resultDiv.innerHTML = `
                    <strong>${hasUrl ? '‚úÖ' : '‚ö†Ô∏è'} Transformation ${hasUrl ? 'OK' : 'PROBL√àME'}</strong><br><br>
                    <strong>Donn√©es API:</strong><br>
                    ‚Ä¢ projectUrl: <span class="highlight">${apiProjects[0].projectUrl || 'VIDE'}</span><br>
                    ‚Ä¢ files[0]?.url: <span class="highlight">${apiProjects[0].files?.[0]?.url || 'VIDE'}</span><br><br>
                    <strong>Apr√®s Transformation:</strong><br>
                    ‚Ä¢ projectUrl final: <span class="highlight">${transformedProject.projectUrl || 'VIDE'}</span><br>
                    ‚Ä¢ hasUrl check: <span class="highlight">${hasUrl ? 'TRUE' : 'FALSE'}</span><br><br>
                    <strong>Comportement attendu:</strong><br>
                    ‚Ä¢ Bouton: ${hasUrl ? 'üü¢ Vert "Ouvrir lien"' : 'üîµ Bleu "D√©tails"'}<br>
                    ‚Ä¢ Action: ${hasUrl ? 'üîó Ouvre le lien' : 'üìã Ouvre modal d√©tails'}<br><br>
                    <strong>Projet transform√© complet:</strong><br>
                    <pre>${JSON.stringify(transformedProject, null, 2)}</pre>
                `;
                
                // Update detailed analysis
                updateDetailedAnalysis(apiProjects[0], transformedProject, hasUrl);
                
            } catch (error) {
                console.error('‚ùå Erreur transformation:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>‚ùå Erreur Transformation</strong><br>${error.message}`;
            }
        }
        
        function updateDetailedAnalysis(apiProject, transformedProject, hasUrl) {
            const analysisDiv = document.getElementById('detailed-analysis');
            
            const diagnosis = hasUrl ? 
                '‚úÖ Le projet devrait afficher "Ouvrir lien"' : 
                '‚ùå Le projet affiche "Pas de lien" - projectUrl manquant';
            
            const solution = hasUrl ? 
                'Aucune action requise - le lien devrait fonctionner' :
                'Action requise: Ajouter projectUrl au projet dans la base de donn√©es';
            
            analysisDiv.innerHTML = `
                <div class="project-card">
                    <div class="project-title">üìä Diagnostic Complet</div>
                    
                    <div class="project-field"><strong>Diagnostic:</strong> ${diagnosis}</div>
                    <div class="project-field"><strong>Solution:</strong> ${solution}</div>
                    
                    <h4>üîç D√©tails Techniques:</h4>
                    <div class="project-field">‚Ä¢ API projectUrl: ${apiProject.projectUrl || 'ABSENT'}</div>
                    <div class="project-field">‚Ä¢ Frontend projectUrl: ${transformedProject.projectUrl || 'ABSENT'}</div>
                    <div class="project-field">‚Ä¢ hasUrl check: ${hasUrl}</div>
                    <div class="project-field">‚Ä¢ Status mapping: ${apiProject.status} ‚Üí ${transformedProject.status}</div>
                    
                    ${!hasUrl ? `
                        <h4>üõ†Ô∏è Actions Recommand√©es:</h4>
                        <div class="project-field">1. Ouvrir Panel Admin</div>
                        <div class="project-field">2. Modifier le projet "dbdc"</div>
                        <div class="project-field">3. Ajouter le lien: https://www.youtube.com/watch?v=wwhPciDPE5s&list=RDV4NEJel0A92Q&index=5</div>
                        <div class="project-field">4. Sauvegarder le participant</div>
                        <div class="project-field">5. Tester √† nouveau dans l'Espace Participant</div>
                    ` : ''}
                </div>
            `;
        }
        
        // Auto-run tests on page load
        window.onload = function() {
            console.log('üîç Debug Project Data - Page charg√©e');
            setTimeout(() => {
                testApiDirect();
            }, 1000);
        };
    </script>
</body>
</html>
