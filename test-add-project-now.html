<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ ÙÙˆØ±ÙŠ</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f0f2f5; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; color: #333; }
        .test-button { background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; margin: 10px; transition: all 0.3s ease; }
        .test-button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(40,167,69,0.3); }
        .log { background: #1a1a1a; color: #00ff00; padding: 20px; margin: 20px 0; border-radius: 10px; font-family: 'Courier New', monospace; white-space: pre-wrap; max-height: 500px; overflow-y: auto; font-size: 14px; direction: ltr; border: 2px solid #333; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        .result-box { background: #f8f9fa; border: 2px solid #dee2e6; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .project-card { background: linear-gradient(135deg, #e3f2fd, #f8f9ff); border: 2px solid #2196f3; padding: 15px; margin: 10px 0; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ ÙÙˆØ±ÙŠ</h1>
            <p>Ø³Ù†Ø¶ÙŠÙ Ù…Ø´Ø±ÙˆØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ ÙˆÙ†ØªØ­Ù‚Ù‚ Ù…Ù† Ø­ÙØ¸Ù‡ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
        </div>
        
        <div style="text-align: center;">
            <button class="test-button" onclick="runTest()">ğŸš€ Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø§Ù„Ø¢Ù†</button>
            <button class="test-button" onclick="checkExistingProjects()" style="background: linear-gradient(135deg, #007bff, #0056b3);">ğŸ“Š ÙØ­Øµ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</button>
            <button class="test-button" onclick="clearLog()" style="background: linear-gradient(135deg, #6c757d, #495057);">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
        </div>

        <div id="results" class="log">ğŸš€ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±...\n</div>
        
        <div id="projectsDisplay" class="result-box" style="display: none;">
            <h3>ğŸ“‹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</h3>
            <div id="projectsList"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        const log = document.getElementById('results');
        
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            let color = '#00ff00';
            let emoji = 'â„¹ï¸';
            
            switch(type) {
                case 'success': color = '#28a745'; emoji = 'âœ…'; break;
                case 'error': color = '#dc3545'; emoji = 'âŒ'; break;
                case 'warning': color = '#ffc107'; emoji = 'âš ï¸'; break;
                case 'info': color = '#17a2b8'; emoji = 'â„¹ï¸'; break;
            }
            
            const logEntry = `[${timestamp}] ${emoji} ${message}\n`;
            log.innerHTML += `<span style="color: ${color}">${logEntry}</span>`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            log.innerHTML = 'ğŸš€ Ø§Ù„Ø³Ø¬Ù„ ØªÙ… Ù…Ø³Ø­Ù‡...\n';
        }

        async function apiCall(url, options = {}) {
            try {
                logMessage(`ğŸ”„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API: ${url}`, 'info');
                const response = await fetch(`${API_BASE}${url}`, {
                    headers: { 'Content-Type': 'application/json', ...options.headers },
                    ...options
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`HTTP ${response.status}: ${errorData.message || 'Ø®Ø·Ø£ ÙÙŠ API'}`);
                }

                const data = await response.json();
                logMessage(`âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡: ${response.status}`, 'success');
                return data;
            } catch (error) {
                logMessage(`âŒ Ø®Ø·Ø£ ÙÙŠ API: ${error.message}`, 'error');
                throw error;
            }
        }

        async function findEnterprisePartner() {
            logMessage('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ Enterprise...', 'info');
            
            try {
                const response = await apiCall('/partners?type=entreprise');
                
                if (!response.success || !response.data || response.data.length === 0) {
                    logMessage('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Ø¡ Enterprise', 'error');
                    return null;
                }
                
                const partner = response.data[0];
                logMessage(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙŠÙƒ: ${partner.partnerId} - ${partner.fullName}`, 'success');
                return partner;
            } catch (error) {
                logMessage(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø±ÙŠÙƒ: ${error.message}`, 'error');
                return null;
            }
        }

        async function addTestProject(partner) {
            logMessage('ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ...', 'info');
            
            const projectData = {
                title: `Ù…Ø´Ø±ÙˆØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ - ${new Date().toLocaleTimeString()}`,
                description: 'Ù…Ø´Ø±ÙˆØ¹ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… - ØªØ·ÙˆÙŠØ± Ù…ÙˆÙ‚Ø¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ØªÙƒØ§Ù…Ù„',
                status: 'planning',
                startDate: '2024-01-15',
                endDate: '2024-07-15',
                budget: 85000,
                progress: 20,
                objectives: ['ØªØµÙ…ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©', 'ØªØ·ÙˆÙŠØ± Backend', 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…'],
                deliverables: ['Ù…ÙˆÙ‚Ø¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ…', 'ÙˆØ«Ø§Ø¦Ù‚ ÙÙ†ÙŠØ©']
            };
            
            logMessage(`ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:`, 'info');
            logMessage(`   Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${projectData.title}`, 'info');
            logMessage(`   Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${projectData.budget} Ø¯ÙŠÙ†Ø§Ø±`, 'info');
            logMessage(`   Ø§Ù„ØªÙ‚Ø¯Ù…: ${projectData.progress}%`, 'info');
            
            try {
                const response = await apiCall(`/enterprise/${partner.partnerId}/projects`, {
                    method: 'POST',
                    body: JSON.stringify(projectData)
                });
                
                if (response.success && response.data) {
                    logMessage(`âœ… Ù…Ø´Ø±ÙˆØ¹ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                    logMessage(`ğŸ“Š Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ${response.data.projectId || response.data._id || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`, 'success');
                    return response.data;
                } else {
                    logMessage(`âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ${response.message}`, 'error');
                    return null;
                }
            } catch (error) {
                logMessage(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ${error.message}`, 'error');
                return null;
            }
        }

        async function verifyProjectSaved(partner) {
            logMessage('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
            
            try {
                const response = await apiCall(`/enterprise/${partner.partnerId}/projects`);
                
                if (response.success && response.data) {
                    const projectCount = response.data.length;
                    logMessage(`ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©: ${projectCount}`, 'success');
                    
                    if (projectCount > 0) {
                        logMessage(`âœ… Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!`, 'success');
                        
                        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
                        displayProjects(response.data, partner);
                        
                        return response.data;
                    } else {
                        logMessage(`âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø­ÙÙˆØ¸Ø©!`, 'error');
                        return [];
                    }
                } else {
                    logMessage(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹: ${response.message}`, 'error');
                    return [];
                }
            } catch (error) {
                logMessage(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚: ${error.message}`, 'error');
                return [];
            }
        }

        function displayProjects(projects, partner) {
            const display = document.getElementById('projectsDisplay');
            const list = document.getElementById('projectsList');
            
            display.style.display = 'block';
            
            let html = `<h4>ğŸ¢ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø´Ø±ÙŠÙƒ: ${partner.partnerId} - ${partner.fullName}</h4>`;
            
            projects.forEach((project, index) => {
                html += `
                    <div class="project-card">
                        <h5>${index + 1}. ${project.title}</h5>
                        <p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${project.description || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${project.status}</p>
                        <p><strong>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©:</strong> ${project.budget || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} Ø¯ÙŠÙ†Ø§Ø±</p>
                        <p><strong>Ø§Ù„ØªÙ‚Ø¯Ù…:</strong> ${project.progress || 0}%</p>
                        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong> ${new Date(project.createdAt).toLocaleString('ar')}</p>
                        <p><strong>Partner ID:</strong> ${project.partnerId}</p>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        async function checkExistingProjects() {
            logMessage('ğŸ” ÙØ­Øµ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©...', 'info');
            
            const partner = await findEnterprisePartner();
            if (!partner) return;
            
            await verifyProjectSaved(partner);
        }

        async function runTest() {
            logMessage('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹...', 'info');
            logMessage('=' .repeat(50), 'info');
            
            try {
                // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ Enterprise
                const partner = await findEnterprisePartner();
                if (!partner) {
                    logMessage('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¯ÙˆÙ† Ø´Ø±ÙŠÙƒ Enterprise', 'error');
                    return;
                }
                
                // 2. Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ
                const project = await addTestProject(partner);
                if (!project) {
                    logMessage('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹', 'error');
                    return;
                }
                
                // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸
                await new Promise(resolve => setTimeout(resolve, 1000)); // Ø§Ù†ØªØ¸Ø§Ø± Ø«Ø§Ù†ÙŠØ©
                const savedProjects = await verifyProjectSaved(partner);
                
                // 4. Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
                if (savedProjects.length > 0) {
                    logMessage('ğŸ‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¬Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„!', 'success');
                    logMessage('âœ… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ÙˆØ­ÙØ¸Ù‡ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    logMessage('âœ… Backend ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'success');
                    logMessage('ğŸ’¡ Ø¥Ø°Ø§ Ù„Ù… ØªØ¸Ù‡Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙÙŠ Espace PartenariatØŒ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Frontend', 'warning');
                } else {
                    logMessage('âŒ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙØ´Ù„ - Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ù… ÙŠÙØ­ÙØ¸', 'error');
                }
                
            } catch (error) {
                logMessage(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${error.message}`, 'error');
            }
        }

        // ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', () => {
            logMessage('ğŸ§ª Ù†Ø¸Ø§Ù… Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ - MATC', 'info');
            logMessage('â„¹ï¸ Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø§Ù„Ø¢Ù†" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'info');
        });
    </script>
</body>
</html>
