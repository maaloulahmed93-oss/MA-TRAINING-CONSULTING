<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Services Issue - MATC</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            color: #dc2626;
            border-bottom: 3px solid #fecaca;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #f9fafb;
        }
        
        button {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        button:hover { 
            transform: translateY(-2px);
        }
        
        .urgent-button {
            padding: 20px 40px;
            font-size: 18px;
            width: 100%;
            margin: 20px 0;
        }
        
        .result {
            background: #1f2937;
            color: #f3f4f6;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .success { 
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border: 2px solid #22c55e;
        }
        
        .error { 
            background: linear-gradient(135deg, #fef2f2 0%, #fde8e8 100%);
            color: #dc2626;
            border: 2px solid #ef4444;
        }
        
        .problem {
            background: linear-gradient(135deg, #fef2f2 0%, #fde8e8 100%);
            border: 2px solid #ef4444;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Debug Services Issue</h1>
            <p>Analyse compl√®te du probl√®me des services qui ne s'affichent pas</p>
        </div>

        <!-- Probl√®me identifi√© -->
        <div class="problem">
            <h3>üö® Probl√®me Identifi√©:</h3>
            <ul>
                <li><strong>Sympt√¥me:</strong> "Service cr√©√© avec succ√®s!" mais ne s'affiche pas</li>
                <li><strong>Page:</strong> Admin Panel ‚Üí Gestion des Services Commerciaux</li>
                <li><strong>Comportement:</strong> Cr√©ation r√©ussie mais liste vide</li>
                <li><strong>Similaire √†:</strong> Probl√®me des programmes qui ne s'affichaient pas</li>
            </ul>
        </div>

        <!-- Diagnostic Complet -->
        <div class="debug-section">
            <h3>üî¨ Diagnostic Complet</h3>
            <button class="urgent-button" onclick="fullDiagnostic()">
                üö® DIAGNOSTIC COMPLET
            </button>
            <div id="diagnostic-result" class="result"></div>
        </div>

        <!-- Test Backend Direct -->
        <div class="debug-section">
            <h3>üîß Test Backend Direct</h3>
            <button onclick="testBackendDirect()">üì° Test API Direct</button>
            <button onclick="testCreateService()">‚ûï Test Cr√©ation</button>
            <button onclick="testLoadServices()">üìã Test Chargement</button>
            <div id="backend-result" class="result"></div>
        </div>

        <!-- Test Frontend -->
        <div class="debug-section">
            <h3>üñ•Ô∏è Test Frontend</h3>
            <button onclick="testFrontendLoad()">üîÑ Test loadServices()</button>
            <button onclick="testNetworkTab()">üåê Analyser Network Tab</button>
            <button onclick="testConsoleErrors()">‚ö†Ô∏è Check Console Errors</button>
            <div id="frontend-result" class="result"></div>
        </div>

        <!-- Solution Propos√©e -->
        <div class="debug-section">
            <h3>üí° Solution Propos√©e</h3>
            <button onclick="proposeSolution()">üîß Analyser & Proposer Solution</button>
            <div id="solution-result" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api/commercial-new';

        async function fullDiagnostic() {
            const resultDiv = document.getElementById('diagnostic-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üî¨ DIAGNOSTIC COMPLET EN COURS...\n\n';

            let issues = [];
            let allGood = true;

            try {
                // Test 1: Backend Status
                resultDiv.textContent += '1Ô∏è‚É£ Test Backend Status...\n';
                try {
                    const backendResponse = await fetch('http://localhost:3001/api/partners');
                    if (backendResponse.ok) {
                        resultDiv.textContent += '   ‚úÖ Backend accessible\n';
                    } else {
                        resultDiv.textContent += '   ‚ùå Backend probl√®me\n';
                        issues.push('Backend non accessible');
                        allGood = false;
                    }
                } catch (e) {
                    resultDiv.textContent += '   ‚ùå Backend offline\n';
                    issues.push('Backend offline');
                    allGood = false;
                }

                // Test 2: Services API Endpoint
                resultDiv.textContent += '\n2Ô∏è‚É£ Test Services API...\n';
                try {
                    const servicesResponse = await fetch(`${API_BASE}/admin/services`);
                    const servicesResult = await servicesResponse.json();
                    
                    if (servicesResult.success) {
                        resultDiv.textContent += `   ‚úÖ API fonctionne: ${servicesResult.data.length} services\n`;
                        if (servicesResult.data.length === 0) {
                            resultDiv.textContent += '   ‚ö†Ô∏è Aucun service dans la DB\n';
                            issues.push('Base de donn√©es vide');
                        } else {
                            resultDiv.textContent += '   üìã Services trouv√©s:\n';
                            servicesResult.data.forEach((service, index) => {
                                resultDiv.textContent += `      ${index + 1}. ${service.titre} (${service.commission}‚Ç¨)\n`;
                            });
                        }
                    } else {
                        resultDiv.textContent += `   ‚ùå API erreur: ${servicesResult.message}\n`;
                        issues.push('API erreur');
                        allGood = false;
                    }
                } catch (e) {
                    resultDiv.textContent += `   ‚ùå API inaccessible: ${e.message}\n`;
                    issues.push('API inaccessible');
                    allGood = false;
                }

                // Test 3: Test Cr√©ation
                resultDiv.textContent += '\n3Ô∏è‚É£ Test Cr√©ation Service...\n';
                try {
                    const testService = {
                        titre: 'Test Debug Service',
                        description: 'Service cr√©√© pour debug',
                        categorie: 'Debug',
                        prixPublic: 100,
                        prixCommercial: 80,
                        commission: 20,
                        duree: '1h'
                    };

                    const createResponse = await fetch(`${API_BASE}/admin/services`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testService)
                    });

                    const createResult = await createResponse.json();
                    
                    if (createResult.success) {
                        resultDiv.textContent += '   ‚úÖ Cr√©ation fonctionne\n';
                        resultDiv.textContent += `   üìù Service cr√©√©: ${createResult.data.titre}\n`;
                    } else {
                        resultDiv.textContent += `   ‚ùå Cr√©ation √©choue: ${createResult.message}\n`;
                        issues.push('Cr√©ation √©choue');
                        allGood = false;
                    }
                } catch (e) {
                    resultDiv.textContent += `   ‚ùå Cr√©ation erreur: ${e.message}\n`;
                    issues.push('Cr√©ation erreur');
                    allGood = false;
                }

                // Test 4: Re-test apr√®s cr√©ation
                resultDiv.textContent += '\n4Ô∏è‚É£ Re-test apr√®s cr√©ation...\n';
                try {
                    const reTestResponse = await fetch(`${API_BASE}/admin/services`);
                    const reTestResult = await reTestResponse.json();
                    
                    if (reTestResult.success) {
                        resultDiv.textContent += `   üìä Services apr√®s cr√©ation: ${reTestResult.data.length}\n`;
                        if (reTestResult.data.length > 0) {
                            resultDiv.textContent += '   ‚úÖ Les services sont bien sauvegard√©s\n';
                        }
                    }
                } catch (e) {
                    resultDiv.textContent += `   ‚ùå Re-test erreur: ${e.message}\n`;
                }

                // R√©sultat final
                resultDiv.textContent += '\nüìä R√âSULTAT DIAGNOSTIC:\n';
                if (allGood && issues.length === 0) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent += '‚úÖ BACKEND FONCTIONNE PARFAITEMENT!\n';
                    resultDiv.textContent += '\nüéØ CONCLUSION: Le probl√®me est dans le FRONTEND\n';
                    resultDiv.textContent += 'La fonction loadServices() ne fonctionne pas correctement\n';
                    resultDiv.textContent += 'ou il y a un probl√®me de rafra√Æchissement de l\'interface.';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent += '‚ùå PROBL√àMES D√âTECT√âS:\n';
                    issues.forEach(issue => {
                        resultDiv.textContent += `   ‚Ä¢ ${issue}\n`;
                    });
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `‚ùå ERREUR CRITIQUE: ${error.message}`;
            }
        }

        async function testBackendDirect() {
            const resultDiv = document.getElementById('backend-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üì° Test Backend Direct...\n\n';

            try {
                // Test GET
                const getResponse = await fetch(`${API_BASE}/admin/services`);
                const getResult = await getResponse.json();
                
                resultDiv.textContent += `GET ${API_BASE}/admin/services\n`;
                resultDiv.textContent += `Status: ${getResponse.status}\n`;
                resultDiv.textContent += `Response: ${JSON.stringify(getResult, null, 2)}\n\n`;

                if (getResult.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent += `‚úÖ Backend fonctionne: ${getResult.data.length} services`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent += `‚ùå Backend erreur: ${getResult.message}`;
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `‚ùå Erreur: ${error.message}`;
            }
        }

        async function testCreateService() {
            const resultDiv = document.getElementById('backend-result');
            resultDiv.className = 'result';
            resultDiv.textContent = '‚ûï Test Cr√©ation Service...\n\n';

            const testService = {
                titre: `Test Service ${Date.now()}`,
                description: 'Service de test automatique',
                categorie: 'Test',
                prixPublic: 200,
                prixCommercial: 160,
                commission: 40,
                duree: '2h'
            };

            try {
                const response = await fetch(`${API_BASE}/admin/services`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testService)
                });

                const result = await response.json();
                
                resultDiv.textContent += `POST ${API_BASE}/admin/services\n`;
                resultDiv.textContent += `Body: ${JSON.stringify(testService, null, 2)}\n`;
                resultDiv.textContent += `Status: ${response.status}\n`;
                resultDiv.textContent += `Response: ${JSON.stringify(result, null, 2)}\n`;

                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent += `\n‚úÖ Service cr√©√©: ${result.data.titre}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent += `\n‚ùå Cr√©ation √©chou√©e: ${result.message}`;
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `‚ùå Erreur: ${error.message}`;
            }
        }

        async function testLoadServices() {
            const resultDiv = document.getElementById('backend-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üìã Test Chargement Services...\n\n';

            try {
                const response = await fetch(`${API_BASE}/admin/services`);
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent += `‚úÖ ${result.data.length} services charg√©s:\n\n`;
                    
                    result.data.forEach((service, index) => {
                        resultDiv.textContent += 
                            `${index + 1}. ${service.titre}\n` +
                            `   Cat√©gorie: ${service.categorie}\n` +
                            `   Prix: ${service.prixPublic}‚Ç¨ ‚Üí ${service.prixCommercial}‚Ç¨\n` +
                            `   Commission: ${service.commission}‚Ç¨\n` +
                            `   Dur√©e: ${service.duree}\n` +
                            `   ID: ${service._id}\n` +
                            `   Cr√©√©: ${new Date(service.createdAt).toLocaleString()}\n\n`;
                    });
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent += `‚ùå Erreur: ${result.message}`;
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `‚ùå Erreur: ${error.message}`;
            }
        }

        async function testFrontendLoad() {
            const resultDiv = document.getElementById('frontend-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üîÑ Simulation loadServices() Frontend...\n\n';

            try {
                // Simuler exactement ce que fait le frontend
                resultDiv.textContent += 'Simulation du code Frontend:\n';
                resultDiv.textContent += 'const response = await fetch("http://localhost:3001/api/commercial-new/admin/services");\n';
                resultDiv.textContent += 'const result = await response.json();\n\n';

                const response = await fetch('http://localhost:3001/api/commercial-new/admin/services');
                const result = await response.json();
                
                resultDiv.textContent += `Response re√ßue:\n`;
                resultDiv.textContent += `success: ${result.success}\n`;
                resultDiv.textContent += `data: ${result.data ? `Array(${result.data.length})` : 'undefined'}\n`;
                resultDiv.textContent += `message: ${result.message || 'N/A'}\n\n`;

                if (result.success && result.data) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent += `‚úÖ Frontend devrait recevoir ${result.data.length} services\n\n`;
                    resultDiv.textContent += 'üéØ CONCLUSION: Le probl√®me n\'est PAS dans l\'API\n';
                    resultDiv.textContent += 'Le probl√®me est probablement:\n';
                    resultDiv.textContent += '1. loadServices() n\'est pas appel√©e apr√®s cr√©ation\n';
                    resultDiv.textContent += '2. setState ne met pas √† jour l\'interface\n';
                    resultDiv.textContent += '3. Probl√®me de re-render du composant\n';
                    resultDiv.textContent += '4. Cache du navigateur\n';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent += `‚ùå API ne retourne pas de donn√©es valides`;
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `‚ùå Erreur: ${error.message}`;
            }
        }

        async function testNetworkTab() {
            const resultDiv = document.getElementById('frontend-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üåê Instructions pour Network Tab...\n\n';
            
            resultDiv.textContent += 
                'üìã INSTRUCTIONS POUR D√âBUGGER:\n\n' +
                '1. Ouvrez DevTools (F12)\n' +
                '2. Allez sur l\'onglet Network\n' +
                '3. Actualisez la page Admin Panel\n' +
                '4. Cherchez la requ√™te: admin/services\n' +
                '5. V√©rifiez:\n' +
                '   - Status Code (doit √™tre 200)\n' +
                '   - Response Body (doit contenir les services)\n' +
                '   - Request Headers\n\n' +
                '6. Cr√©ez un nouveau service\n' +
                '7. V√©rifiez si une nouvelle requ√™te admin/services est faite\n' +
                '8. Si non ‚Üí Probl√®me: loadServices() pas appel√©e\n' +
                '9. Si oui mais pas d\'affichage ‚Üí Probl√®me: setState\n\n' +
                'üéØ Rapportez ce que vous voyez dans Network Tab!';
        }

        async function testConsoleErrors() {
            const resultDiv = document.getElementById('frontend-result');
            resultDiv.className = 'result';
            resultDiv.textContent = '‚ö†Ô∏è Check Console Errors...\n\n';
            
            resultDiv.textContent += 
                'üìã V√âRIFICATIONS CONSOLE:\n\n' +
                '1. Ouvrez DevTools Console\n' +
                '2. Cherchez les erreurs rouges\n' +
                '3. Erreurs communes √† chercher:\n' +
                '   - CORS errors\n' +
                '   - 404 Not Found\n' +
                '   - TypeError: Cannot read properties\n' +
                '   - Network errors\n' +
                '   - React warnings\n\n' +
                '4. Apr√®s cr√©ation de service, v√©rifiez:\n' +
                '   - "Service cr√©√© avec succ√®s!" appara√Æt\n' +
                '   - Pas d\'erreur apr√®s le succ√®s\n' +
                '   - loadServices() est appel√©e\n\n' +
                'üéØ Copiez toute erreur que vous voyez!';
        }

        async function proposeSolution() {
            const resultDiv = document.getElementById('solution-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'üí° Analyse et Solution...\n\n';

            // Test rapide pour d√©terminer la cause
            try {
                const response = await fetch(`${API_BASE}/admin/services`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent += 
                        'üéØ DIAGNOSTIC: Backend fonctionne parfaitement\n\n' +
                        '‚ùå PROBL√àME IDENTIFI√â: Frontend ne rafra√Æchit pas\n\n' +
                        'üîß SOLUTIONS PROPOS√âES:\n\n' +
                        '1. SOLUTION IMM√âDIATE:\n' +
                        '   - Actualisez la page Admin Panel (F5)\n' +
                        '   - Les services devraient appara√Ætre\n\n' +
                        '2. SOLUTION CODE:\n' +
                        '   - V√©rifier que loadServices() est appel√©e apr√®s cr√©ation\n' +
                        '   - Ajouter console.log dans loadServices()\n' +
                        '   - V√©rifier setState(services)\n\n' +
                        '3. SOLUTION DEBUG:\n' +
                        '   - Ajouter un bouton "Actualiser" temporaire\n' +
                        '   - Forcer le re-render du composant\n\n' +
                        'üö® TESTEZ: Actualisez la page maintenant!';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent += 
                        '‚ùå PROBL√àME: Backend ne retourne pas de services\n\n' +
                        'üîß SOLUTIONS:\n' +
                        '1. V√©rifier que les services sont bien sauvegard√©s\n' +
                        '2. V√©rifier la connexion MongoDB\n' +
                        '3. Red√©marrer le backend\n';
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `‚ùå Erreur: ${error.message}`;
            }
        }

        // Auto-message
        window.onload = function() {
            console.log('üîç Debug Services Issue charg√©');
        };
    </script>
</body>
</html>
