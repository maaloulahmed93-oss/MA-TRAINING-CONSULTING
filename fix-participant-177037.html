<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix - Participant PART-177037</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .success { background: #d4edda; padding: 10px; border-radius: 4px; color: #155724; margin: 10px 0; }
        .error { background: #f8d7da; padding: 10px; border-radius: 4px; color: #721c24; margin: 10px 0; }
        .info { background: #d1ecf1; padding: 10px; border-radius: 4px; color: #0c5460; margin: 10px 0; }
        .warning { background: #fff3cd; padding: 10px; border-radius: 4px; color: #856404; margin: 10px 0; }
        button { padding: 10px 20px; margin: 10px 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .fix-section { background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix - Participant PART-177037</h1>
        <p>Outil de diagnostic et r√©paration pour le participant PART-177037</p>

        <div class="warning">
            <strong>Probl√®me identifi√©:</strong><br>
            Le participant PART-177037 existe dans l'Admin Panel mais l'API retourne 404
        </div>

        <div class="fix-section">
            <h3>üîç √âtapes de diagnostic:</h3>
            <button class="btn-primary" onclick="step1_checkBackend()">1. V√©rifier Backend</button>
            <button class="btn-primary" onclick="step2_listParticipants()">2. Lister Participants</button>
            <button class="btn-primary" onclick="step3_checkDatabase()">3. V√©rifier Base de Donn√©es</button>
            <button class="btn-warning" onclick="step4_fixParticipant()">4. R√©parer Participant</button>
            <button class="btn-success" onclick="step5_testFixed()">5. Tester R√©paration</button>
        </div>

        <div class="fix-section">
            <h3>üöÄ R√©parations automatiques:</h3>
            <button class="btn-success" onclick="autoFix()">üîß R√©paration Automatique</button>
            <button class="btn-danger" onclick="recreateParticipant()">üîÑ Recr√©er Participant</button>
            <button onclick="clearResults()">Effacer R√©sultats</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        const PARTICIPANT_ID = 'PART-177037';
        let participantData = null;

        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            resultsDiv.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function step1_checkBackend() {
            log('üîÑ √âtape 1: V√©rification du backend...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    log('‚úÖ Backend op√©rationnel', 'success');
                    return true;
                } else {
                    log('‚ùå Backend non accessible', 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erreur backend: ${error.message}`, 'error');
                log('üîß Assurez-vous que le backend est d√©marr√© sur le port 3001', 'warning');
                return false;
            }
        }

        async function step2_listParticipants() {
            log('üîÑ √âtape 2: Listage des participants...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/participants`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log(`‚úÖ ${data.data.length} participants trouv√©s`, 'success');
                    
                    const target = data.data.find(p => 
                        p.id === PARTICIPANT_ID || 
                        p.partnerId === PARTICIPANT_ID
                    );
                    
                    if (target) {
                        log('üéØ PART-177037 trouv√© dans la liste!', 'success');
                        participantData = target;
                        return true;
                    } else {
                        log('‚ùå PART-177037 non trouv√© dans la liste', 'error');
                        log('üìã Participants disponibles:', 'info');
                        data.data.forEach(p => {
                            log(`‚Ä¢ ${p.id || p.partnerId} - ${p.fullName}`, 'info');
                        });
                        return false;
                    }
                } else {
                    log(`‚ùå Erreur API participants: ${data.message}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                return false;
            }
        }

        async function step3_checkDatabase() {
            log('üîÑ √âtape 3: V√©rification base de donn√©es...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/partners`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log(`‚úÖ Base de donn√©es accessible`, 'success');
                    
                    const target = data.data.find(p => 
                        p.partnerId === PARTICIPANT_ID ||
                        (p.fullName && p.fullName.includes('177037'))
                    );
                    
                    if (target) {
                        log('üéØ Participant trouv√© dans la base de donn√©es!', 'success');
                        log(`<pre>Donn√©es brutes:
Type: ${target.type}
Partner ID: ${target.partnerId}
Nom: ${target.fullName}
Email: ${target.email}
Actif: ${target.isActive}
Description: ${target.description}</pre>`, 'info');
                        
                        // V√©rifier les crit√®res de filtrage
                        if (target.type !== 'participant') {
                            log(`‚ö†Ô∏è Probl√®me: Type = "${target.type}" (devrait √™tre "participant")`, 'warning');
                        }
                        if (!target.isActive) {
                            log(`‚ö†Ô∏è Probl√®me: isActive = false (devrait √™tre true)`, 'warning');
                        }
                        
                        participantData = target;
                        return true;
                    } else {
                        log('‚ùå Participant non trouv√© dans la base de donn√©es', 'error');
                        return false;
                    }
                } else {
                    log(`‚ùå Erreur base de donn√©es: ${data.message}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                return false;
            }
        }

        async function step4_fixParticipant() {
            log('üîÑ √âtape 4: R√©paration du participant...', 'info');
            
            if (!participantData) {
                log('‚ùå Aucune donn√©e participant trouv√©e. Ex√©cutez d\'abord les √©tapes 1-3', 'error');
                return false;
            }
            
            try {
                // Essayer de mettre √† jour le participant pour corriger les probl√®mes
                const updateData = {
                    fullName: participantData.fullName || 'Ahmed',
                    email: participantData.email || 'aj@hotmail.com',
                    phone: participantData.phone || '',
                    address: participantData.address || '',
                    firstName: 'Ahmed',
                    lastName: '',
                    status: 'active'
                };
                
                const response = await fetch(`${API_BASE}/participants/${PARTICIPANT_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log('‚úÖ Participant r√©par√© avec succ√®s!', 'success');
                    log(`<pre>${JSON.stringify(data.data, null, 2)}</pre>`, 'success');
                    return true;
                } else {
                    log(`‚ùå Erreur lors de la r√©paration: ${data.message}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                return false;
            }
        }

        async function step5_testFixed() {
            log('üîÑ √âtape 5: Test de la r√©paration...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/participants/${PARTICIPANT_ID}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log('üéâ SUCC√àS! Participant accessible!', 'success');
                    log(`<pre>${JSON.stringify(data.data, null, 2)}</pre>`, 'success');
                    log('‚úÖ Le probl√®me 404 est r√©solu!', 'success');
                    return true;
                } else {
                    log(`‚ùå Toujours en erreur: ${data.message}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                return false;
            }
        }

        async function autoFix() {
            log('üöÄ D√©marrage de la r√©paration automatique...', 'info');
            clearResults();
            
            const step1 = await step1_checkBackend();
            if (!step1) return;
            
            const step2 = await step2_listParticipants();
            const step3 = await step3_checkDatabase();
            
            if (step2 || step3) {
                const step4 = await step4_fixParticipant();
                if (step4) {
                    await step5_testFixed();
                }
            } else {
                log('‚ùå Participant non trouv√©. Essayez "Recr√©er Participant"', 'error');
            }
        }

        async function recreateParticipant() {
            log('üîÑ Recr√©ation du participant PART-177037...', 'info');
            
            try {
                const newParticipantData = {
                    partnerId: PARTICIPANT_ID,
                    fullName: 'Ahmed',
                    firstName: 'Ahmed',
                    lastName: '',
                    email: 'aj@hotmail.com',
                    phone: '+216 20 123 456',
                    address: 'Tunis, Tunisie',
                    avatar: '',
                    status: 'active',
                    notes: 'Participant recr√©√© automatiquement'
                };
                
                const response = await fetch(`${API_BASE}/participants`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newParticipantData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log('‚úÖ Participant recr√©√© avec succ√®s!', 'success');
                    log(`<pre>${JSON.stringify(data.data, null, 2)}</pre>`, 'success');
                    
                    // Tester imm√©diatement
                    await step5_testFixed();
                } else {
                    log(`‚ùå Erreur lors de la recr√©ation: ${data.message}`, 'error');
                    
                    if (data.message && data.message.includes('existe d√©j√†')) {
                        log('‚ÑπÔ∏è Le participant existe d√©j√†. Essayez la r√©paration automatique.', 'info');
                    }
                }
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        // Auto-start
        window.addEventListener('load', () => {
            log('üîß Outil de r√©paration PART-177037 charg√©', 'info');
            log('Cliquez sur "R√©paration Automatique" pour r√©soudre le probl√®me', 'info');
        });
    </script>
</body>
</html>
