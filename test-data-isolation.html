<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Data Isolation by PartnerId - MATC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            padding: 30px;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }
        
        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .partner-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .partner-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .console {
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        
        .log-entry.success { color: #28a745; }
        .log-entry.error { color: #dc3545; }
        .log-entry.warning { color: #ffc107; }
        .log-entry.info { color: #17a2b8; }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .data-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #ddd;
        }
        
        .data-count {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
        }
        
        .isolation-test {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .isolation-test.success {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .isolation-test.error {
            background: #f8d7da;
            border-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí Test Data Isolation by PartnerId</h1>
            <p>V√©rification que chaque partenaire ne voit que ses propres donn√©es</p>
        </div>
        
        <!-- Controls -->
        <div style="padding: 0 30px;">
            <div class="controls">
                <button onclick="createTestPartners()" id="create-btn">üë• Cr√©er Partenaires Test</button>
                <button onclick="createTestData()" id="data-btn">üìä Cr√©er Donn√©es Test</button>
                <button onclick="testDataIsolation()" id="isolation-btn">üîí Test Isolation</button>
                <button onclick="testCrossAccess()" id="cross-btn">‚ö†Ô∏è Test Acc√®s Crois√©</button>
                <button onclick="clearConsole()">üßπ Clear Console</button>
            </div>
        </div>
        
        <!-- Test Partners -->
        <div class="test-grid">
            <div class="test-section">
                <div class="section-title">
                    üë• Partenaires Test
                </div>
                <div id="test-partners"></div>
            </div>
            
            <div class="test-section">
                <div class="section-title">
                    üìä Donn√©es par Partenaire
                </div>
                <div id="partner-data"></div>
            </div>
        </div>
        
        <!-- Isolation Test Results -->
        <div style="padding: 0 30px;">
            <div class="isolation-test" id="isolation-results" style="display: none;">
                <h3>üîí R√©sultats Test d'Isolation</h3>
                <div id="isolation-details"></div>
            </div>
        </div>
        
        <!-- Console -->
        <div style="padding: 0 30px;">
            <div class="console" id="console">
                <div class="log-entry info">[SYSTEM] Test d'isolation des donn√©es par partnerId initialis√©</div>
                <div class="log-entry info">[INFO] Pr√™t √† tester l'isolation des donn√©es</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        
        // Partenaires de test
        const TEST_PARTNERS = [
            {
                partnerId: 'ENT-TEST001',
                fullName: 'Entreprise Alpha Test',
                email: 'alpha@test-isolation.com',
                type: 'entreprise',
                contactPerson: 'Ahmed Alpha',
                phone: '+216 20 111 111'
            },
            {
                partnerId: 'ENT-TEST002', 
                fullName: 'Entreprise Beta Test',
                email: 'beta@test-isolation.com',
                type: 'entreprise',
                contactPerson: 'Sarah Beta',
                phone: '+216 20 222 222'
            },
            {
                partnerId: 'FOR-TEST001',
                fullName: 'Formateur Gamma Test',
                email: 'gamma@test-isolation.com',
                type: 'formateur',
                contactPerson: 'Mohamed Gamma',
                phone: '+216 20 333 333'
            }
        ];
        
        let createdPartners = [];
        let testData = {};

        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }

                return data;
            } catch (error) {
                throw error;
            }
        }

        async function createTestPartners() {
            log('üë• Cr√©ation des partenaires de test...', 'info');
            const btn = document.getElementById('create-btn');
            btn.disabled = true;
            
            createdPartners = [];
            
            for (const partner of TEST_PARTNERS) {
                try {
                    const result = await apiCall('/partners', {
                        method: 'POST',
                        body: JSON.stringify(partner)
                    });
                    
                    if (result.success) {
                        createdPartners.push(result.data);
                        log(`‚úÖ Partenaire cr√©√©: ${result.data.partnerId} - ${result.data.fullName}`, 'success');
                    }
                } catch (error) {
                    if (error.message.includes('duplicate') || error.message.includes('existe')) {
                        log(`‚ö†Ô∏è Partenaire existe d√©j√†: ${partner.partnerId}`, 'warning');
                        // R√©cup√©rer le partenaire existant
                        try {
                            const existing = await apiCall(`/partners/${partner.partnerId}`);
                            if (existing.success) {
                                createdPartners.push(existing.data);
                            }
                        } catch (e) {
                            log(`‚ùå Erreur r√©cup√©ration partenaire existant: ${e.message}`, 'error');
                        }
                    } else {
                        log(`‚ùå Erreur cr√©ation ${partner.partnerId}: ${error.message}`, 'error');
                    }
                }
            }
            
            displayTestPartners();
            btn.disabled = false;
            log(`üìä ${createdPartners.length} partenaires pr√™ts pour les tests`, 'success');
        }

        function displayTestPartners() {
            const container = document.getElementById('test-partners');
            container.innerHTML = '';
            
            createdPartners.forEach(partner => {
                const card = document.createElement('div');
                card.className = 'partner-card';
                card.innerHTML = `
                    <div class="partner-id">${partner.partnerId}</div>
                    <div><strong>${partner.fullName}</strong></div>
                    <div>Type: ${partner.type}</div>
                    <div>Email: ${partner.email}</div>
                `;
                container.appendChild(card);
            });
        }

        async function createTestData() {
            log('üìä Cr√©ation des donn√©es de test pour chaque partenaire...', 'info');
            const btn = document.getElementById('data-btn');
            btn.disabled = true;
            
            testData = {};
            
            for (const partner of createdPartners) {
                if (partner.type === 'entreprise') {
                    await createEnterpriseData(partner.partnerId);
                } else if (partner.type === 'formateur') {
                    await createFormateurData(partner.partnerId);
                }
            }
            
            displayPartnerData();
            btn.disabled = false;
            log('‚úÖ Donn√©es de test cr√©√©es pour tous les partenaires', 'success');
        }

        async function createEnterpriseData(partnerId) {
            try {
                // Cr√©er des projets
                const projectData = {
                    title: `Projet Test ${partnerId}`,
                    description: `Projet de test pour ${partnerId}`,
                    startDate: new Date().toISOString(),
                    endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                    budget: 5000
                };
                
                const project = await apiCall(`/enterprise/${partnerId}/projects`, {
                    method: 'POST',
                    body: JSON.stringify(projectData)
                });
                
                // Cr√©er des formations
                const formationData = {
                    title: `Formation Test ${partnerId}`,
                    description: `Formation de test pour ${partnerId}`,
                    date: new Date().toISOString(),
                    duration: 8,
                    location: 'online',
                    maxParticipants: 20
                };
                
                const formation = await apiCall(`/enterprise/${partnerId}/formations`, {
                    method: 'POST',
                    body: JSON.stringify(formationData)
                });
                
                // Cr√©er des participants
                const participantData = {
                    fullName: `Participant Test ${partnerId}`,
                    email: `participant-${partnerId.toLowerCase()}@test.com`,
                    phone: '+216 20 999 999',
                    position: 'Employ√© Test'
                };
                
                const participant = await apiCall(`/enterprise/${partnerId}/participants`, {
                    method: 'POST',
                    body: JSON.stringify(participantData)
                });
                
                testData[partnerId] = {
                    projects: [project.data],
                    formations: [formation.data],
                    participants: [participant.data]
                };
                
                log(`‚úÖ Donn√©es cr√©√©es pour entreprise ${partnerId}`, 'success');
                
            } catch (error) {
                log(`‚ùå Erreur cr√©ation donn√©es ${partnerId}: ${error.message}`, 'error');
            }
        }

        async function createFormateurData(partnerId) {
            try {
                // Cr√©er un programme formateur
                const programmeData = {
                    titre: `Programme Test ${partnerId}`,
                    description: `Programme de test pour ${partnerId}`,
                    dateDebut: new Date().toISOString(),
                    dateFin: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                    prix: 1500,
                    lieu: 'Tunis'
                };
                
                const programme = await apiCall(`/formateur-programmes/${partnerId}`, {
                    method: 'POST',
                    body: JSON.stringify(programmeData)
                });
                
                testData[partnerId] = {
                    programmes: [programme.data]
                };
                
                log(`‚úÖ Donn√©es cr√©√©es pour formateur ${partnerId}`, 'success');
                
            } catch (error) {
                log(`‚ùå Erreur cr√©ation donn√©es formateur ${partnerId}: ${error.message}`, 'error');
            }
        }

        async function displayPartnerData() {
            const container = document.getElementById('partner-data');
            container.innerHTML = '';
            
            for (const partner of createdPartners) {
                try {
                    let dataCount = 0;
                    let dataTypes = [];
                    
                    if (partner.type === 'entreprise') {
                        // R√©cup√©rer les donn√©es de l'entreprise
                        const projects = await apiCall(`/enterprise/${partner.partnerId}/projects`);
                        const formations = await apiCall(`/enterprise/${partner.partnerId}/formations`);
                        const participants = await apiCall(`/enterprise/${partner.partnerId}/participants`);
                        
                        dataCount = projects.count + formations.count + participants.count;
                        dataTypes = [`${projects.count} projets`, `${formations.count} formations`, `${participants.count} participants`];
                    } else if (partner.type === 'formateur') {
                        const programmes = await apiCall(`/formateur-programmes/${partner.partnerId}`);
                        dataCount = programmes.count || programmes.data.length;
                        dataTypes = [`${dataCount} programmes`];
                    }
                    
                    const card = document.createElement('div');
                    card.className = 'data-card';
                    card.innerHTML = `
                        <div class="partner-id">${partner.partnerId}</div>
                        <div class="data-count">${dataCount}</div>
                        <div>${dataTypes.join(', ')}</div>
                    `;
                    container.appendChild(card);
                    
                } catch (error) {
                    log(`‚ùå Erreur r√©cup√©ration donn√©es ${partner.partnerId}: ${error.message}`, 'error');
                }
            }
        }

        async function testDataIsolation() {
            log('üîí Test d\'isolation des donn√©es...', 'info');
            const btn = document.getElementById('isolation-btn');
            btn.disabled = true;
            
            const results = document.getElementById('isolation-results');
            const details = document.getElementById('isolation-details');
            results.style.display = 'block';
            results.className = 'isolation-test';
            
            let isolationPassed = true;
            let testResults = [];
            
            // Test 1: Chaque partenaire ne voit que ses donn√©es
            for (const partner of createdPartners) {
                try {
                    if (partner.type === 'entreprise') {
                        const projects = await apiCall(`/enterprise/${partner.partnerId}/projects`);
                        const formations = await apiCall(`/enterprise/${partner.partnerId}/formations`);
                        
                        // V√©rifier que toutes les donn√©es appartiennent bien au partenaire
                        const allProjectsValid = projects.data.every(p => p.partnerId === partner.partnerId);
                        const allFormationsValid = formations.data.every(f => f.partnerId === partner.partnerId);
                        
                        if (allProjectsValid && allFormationsValid) {
                            testResults.push(`‚úÖ ${partner.partnerId}: Isolation OK`);
                            log(`‚úÖ Isolation valid√©e pour ${partner.partnerId}`, 'success');
                        } else {
                            testResults.push(`‚ùå ${partner.partnerId}: Donn√©es m√©lang√©es d√©tect√©es`);
                            isolationPassed = false;
                            log(`‚ùå Isolation √©chou√©e pour ${partner.partnerId}`, 'error');
                        }
                    }
                } catch (error) {
                    testResults.push(`‚ùå ${partner.partnerId}: Erreur test - ${error.message}`);
                    isolationPassed = false;
                    log(`‚ùå Erreur test isolation ${partner.partnerId}: ${error.message}`, 'error');
                }
            }
            
            // Afficher les r√©sultats
            details.innerHTML = `
                <div><strong>R√©sultat Global:</strong> ${isolationPassed ? '‚úÖ SUCC√àS' : '‚ùå √âCHEC'}</div>
                <div style="margin-top: 15px;"><strong>D√©tails:</strong></div>
                <ul style="margin-left: 20px;">
                    ${testResults.map(result => `<li>${result}</li>`).join('')}
                </ul>
            `;
            
            results.className = `isolation-test ${isolationPassed ? 'success' : 'error'}`;
            
            btn.disabled = false;
            log(`üèÅ Test d'isolation termin√©: ${isolationPassed ? 'SUCC√àS' : '√âCHEC'}`, isolationPassed ? 'success' : 'error');
        }

        async function testCrossAccess() {
            log('‚ö†Ô∏è Test d\'acc√®s crois√© (doit √©chouer)...', 'info');
            const btn = document.getElementById('cross-btn');
            btn.disabled = true;
            
            if (createdPartners.length < 2) {
                log('‚ùå Besoin d\'au moins 2 partenaires pour le test d\'acc√®s crois√©', 'error');
                btn.disabled = false;
                return;
            }
            
            const partner1 = createdPartners[0];
            const partner2 = createdPartners[1];
            
            try {
                // Essayer d'acc√©der aux donn√©es du partner2 avec l'ID du partner1
                log(`üîç Tentative d'acc√®s aux donn√©es de ${partner2.partnerId} via ${partner1.partnerId}...`, 'info');
                
                if (partner2.type === 'entreprise') {
                    try {
                        const crossData = await apiCall(`/enterprise/${partner2.partnerId}/projects`);
                        log(`‚ùå S√âCURIT√â COMPROMISE: Acc√®s crois√© r√©ussi!`, 'error');
                    } catch (error) {
                        if (error.message.includes('404') || error.message.includes('non trouv√©') || error.message.includes('non autoris√©')) {
                            log(`‚úÖ Acc√®s crois√© correctement bloqu√©: ${error.message}`, 'success');
                        } else {
                            log(`‚ö†Ô∏è Erreur inattendue: ${error.message}`, 'warning');
                        }
                    }
                }
                
            } catch (error) {
                log(`‚ùå Erreur test acc√®s crois√©: ${error.message}`, 'error');
            }
            
            btn.disabled = false;
            log('üèÅ Test d\'acc√®s crois√© termin√©', 'info');
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
            log('Console cleared', 'info');
        }

        // Auto-start
        window.onload = function() {
            log('üîß Syst√®me de test d\'isolation pr√™t', 'success');
            log('üí° Cliquez sur "Cr√©er Partenaires Test" pour commencer', 'info');
        };
    </script>
</body>
</html>
