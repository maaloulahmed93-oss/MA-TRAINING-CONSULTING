<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Meetings Sync</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .section h3 {
            color: #333;
            margin-top: 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        
        .workflow-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .workflow-box h4 {
            margin-top: 0;
            color: #495057;
        }
        .step {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .step-number {
            display: inline-block;
            width: 25px;
            height: 25px;
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            font-weight: bold;
            margin-right: 10px;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .data-column {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
        }
        .data-column h4 {
            margin-top: 0;
            color: #495057;
        }
        .meeting-item {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 12px;
            border-left: 4px solid #007bff;
            background-color: #e3f2fd;
        }
        .meeting-new {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .meeting-missing {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test - Meetings Synchronization</h1>
        <p>Test de synchronisation des r√©unions entre Admin Panel et Freelancer Space</p>

        <!-- Workflow attendu -->
        <div class="section">
            <h3>üìã Workflow de Synchronisation</h3>
            <div class="workflow-box">
                <h4>üéØ Processus Attendu:</h4>
                <div class="step">
                    <span class="step-number">1</span>
                    <span>Admin cr√©e une r√©union dans Admin Panel</span>
                </div>
                <div class="step">
                    <span class="step-number">2</span>
                    <span>R√©union sauvegard√©e dans API (localhost:8336)</span>
                </div>
                <div class="step">
                    <span class="step-number">3</span>
                    <span>Freelancer Space charge les r√©unions via API</span>
                </div>
                <div class="step">
                    <span class="step-number">4</span>
                    <span>R√©unions transform√©es au format Freelancer</span>
                </div>
                <div class="step">
                    <span class="step-number">5</span>
                    <span>R√©unions affich√©es dans l'espace Freelancer</span>
                </div>
            </div>
        </div>

        <!-- Test API Connection -->
        <div class="section">
            <h3>1. Test de Connexion API</h3>
            <button class="btn-primary" onclick="testAPIConnection()">Tester Connexion API</button>
            <div id="api-result" class="result" style="display: none;"></div>
        </div>

        <!-- Test Meetings Loading -->
        <div class="section">
            <h3>2. Test de Chargement des R√©unions</h3>
            <button class="btn-success" onclick="testMeetingsLoading()">Charger R√©unions</button>
            <button class="btn-warning" onclick="testWithFreelancerId()">Tester avec FRE-340255</button>
            <div id="meetings-result" class="result" style="display: none;"></div>
        </div>

        <!-- Comparaison Admin vs Freelancer -->
        <div class="section">
            <h3>3. Comparaison Admin Panel vs Freelancer Space</h3>
            <button class="btn-warning" onclick="compareMeetings()">Comparer R√©unions</button>
            <div id="comparison-result" style="display: none;"></div>
        </div>

        <!-- Test localStorage -->
        <div class="section">
            <h3>4. Test localStorage</h3>
            <button class="btn-primary" onclick="checkLocalStorage()">V√©rifier localStorage</button>
            <button class="btn-danger" onclick="clearMeetingsCache()">Vider Cache</button>
            <div id="storage-result" class="result" style="display: none;"></div>
        </div>

        <!-- Instructions de test -->
        <div class="section">
            <h3>5. Instructions de Test Complet</h3>
            <div class="workflow-box">
                <h4>üß™ Pour tester la synchronisation:</h4>
                <ol>
                    <li><strong>Ouvrez Admin Panel:</strong> <a href="http://localhost:8336/partners/freelancer-meetings" target="_blank">Admin Panel</a></li>
                    <li><strong>Cr√©ez une nouvelle r√©union</strong> avec freelancerId = "FRE-340255"</li>
                    <li><strong>Notez les d√©tails</strong> (sujet, date, heure)</li>
                    <li><strong>Ouvrez Freelancer Space:</strong> <a href="http://localhost:5173/espace-freelancer" target="_blank">Freelancer Space</a></li>
                    <li><strong>Connectez-vous</strong> avec FRE-340255</li>
                    <li><strong>Allez dans "R√©unions"</strong></li>
                    <li><strong>V√©rifiez</strong> que la nouvelle r√©union appara√Æt</li>
                    <li><strong>Actualisez</strong> si n√©cessaire (F5)</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // Test de connexion API
        async function testAPIConnection() {
            const resultDiv = document.getElementById('api-result');
            
            try {
                let result = `üîç TEST DE CONNEXION API:\n\n`;
                
                // Test de l'endpoint principal
                const response = await fetch('http://localhost:8336/partners/freelancer-meetings');
                
                result += `üì° URL: http://localhost:8336/partners/freelancer-meetings\n`;
                result += `üìä Status: ${response.status} ${response.statusText}\n`;
                result += `üîó OK: ${response.ok}\n\n`;
                
                if (response.ok) {
                    const data = await response.json();
                    result += `üìã Donn√©es re√ßues:\n`;
                    result += `   Type: ${Array.isArray(data) ? 'Array' : typeof data}\n`;
                    result += `   Longueur: ${Array.isArray(data) ? data.length : 'N/A'}\n\n`;
                    
                    if (Array.isArray(data) && data.length > 0) {
                        result += `üìÑ Premier √©l√©ment:\n`;
                        const first = data[0];
                        result += `   ID: ${first._id || first.id}\n`;
                        result += `   Subject: ${first.subject}\n`;
                        result += `   Date: ${first.date}\n`;
                        result += `   FreelancerId: ${first.freelancerId}\n`;
                    }
                } else {
                    result += `‚ùå Erreur HTTP: ${response.status}\n`;
                    const text = await response.text();
                    result += `üìÑ R√©ponse: ${text.substring(0, 200)}...\n`;
                }
                
                showResult(resultDiv, response.ok ? 'success' : 'error', result);
                
            } catch (error) {
                showResult(resultDiv, 'error', `‚ùå Erreur de connexion: ${error.message}`);
            }
        }

        // Test de chargement des r√©unions
        async function testMeetingsLoading() {
            const resultDiv = document.getElementById('meetings-result');
            
            try {
                let result = `üîç TEST DE CHARGEMENT DES R√âUNIONS:\n\n`;
                
                // Test sans freelancerId
                result += `1Ô∏è‚É£ Test sans freelancerId:\n`;
                const response1 = await fetch('http://localhost:8336/partners/freelancer-meetings');
                result += `   Status: ${response1.status}\n`;
                
                if (response1.ok) {
                    const data1 = await response1.json();
                    result += `   R√©unions trouv√©es: ${data1.length}\n`;
                } else {
                    result += `   Erreur: ${response1.statusText}\n`;
                }
                
                result += `\n2Ô∏è‚É£ Test avec freelancerId FRE-340255:\n`;
                const response2 = await fetch('http://localhost:8336/partners/freelancer-meetings?freelancerId=FRE-340255');
                result += `   Status: ${response2.status}\n`;
                
                if (response2.ok) {
                    const data2 = await response2.json();
                    result += `   R√©unions pour FRE-340255: ${data2.length}\n\n`;
                    
                    if (data2.length > 0) {
                        result += `üìã R√âUNIONS TROUV√âES:\n`;
                        data2.forEach((meeting, index) => {
                            result += `   ${index + 1}. ${meeting.subject}\n`;
                            result += `      Date: ${meeting.date} √† ${meeting.startTime}\n`;
                            result += `      Avec: ${meeting.withWhom}\n`;
                            result += `      Type: ${meeting.type}\n\n`;
                        });
                    }
                } else {
                    result += `   Erreur: ${response2.statusText}\n`;
                }
                
                showResult(resultDiv, 'info', result);
                
            } catch (error) {
                showResult(resultDiv, 'error', `‚ùå Erreur: ${error.message}`);
            }
        }

        // Test avec freelancerId sp√©cifique
        async function testWithFreelancerId() {
            const resultDiv = document.getElementById('meetings-result');
            
            try {
                let result = `üéØ TEST AVEC FREELANCER ID:\n\n`;
                
                const freelancerId = 'FRE-340255';
                result += `üë§ FreelancerId: ${freelancerId}\n\n`;
                
                // Simuler le processus de getMeetings
                result += `üîÑ Simulation getMeetings():\n`;
                
                const response = await fetch(`http://localhost:8336/partners/freelancer-meetings?freelancerId=${freelancerId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    result += `‚úÖ API Response: ${data.length} r√©unions\n\n`;
                    
                    // Transformation des donn√©es
                    const transformedMeetings = data.map(meeting => ({
                        id: meeting._id || meeting.id,
                        title: meeting.subject || meeting.title,
                        client: meeting.withWhom || 'Client',
                        date: meeting.date,
                        time: meeting.startTime || meeting.time,
                        duration: meeting.durationMinutes || 60,
                        type: meeting.type === 'visio' ? 'video_call' : 'client_meeting',
                        status: meeting.status || 'scheduled',
                        meetingLink: meeting.meetingLink || '',
                        platform: detectPlatform(meeting.meetingLink),
                        participants: meeting.participants || [],
                        agenda: meeting.agenda || '',
                        notes: meeting.notes || ''
                    }));
                    
                    result += `üîÑ Donn√©es transform√©es:\n`;
                    transformedMeetings.forEach((meeting, index) => {
                        result += `   ${index + 1}. ${meeting.title}\n`;
                        result += `      Client: ${meeting.client}\n`;
                        result += `      Date: ${meeting.date} √† ${meeting.time}\n`;
                        result += `      Platform: ${meeting.platform}\n`;
                        result += `      Status: ${meeting.status}\n\n`;
                    });
                    
                    // Test localStorage
                    localStorage.setItem('freelancerMeetings', JSON.stringify(transformedMeetings));
                    result += `üíæ Sauvegard√© dans localStorage\n`;
                    
                } else {
                    result += `‚ùå Erreur API: ${response.status} ${response.statusText}\n`;
                }
                
                showResult(resultDiv, 'success', result);
                
            } catch (error) {
                showResult(resultDiv, 'error', `‚ùå Erreur: ${error.message}`);
            }
        }

        // Fonction utilitaire pour d√©tecter la plateforme
        function detectPlatform(meetingLink) {
            if (!meetingLink) return 'Unknown';
            
            if (meetingLink.includes('meet.google.com')) return 'Google Meet';
            if (meetingLink.includes('zoom.us')) return 'Zoom';
            if (meetingLink.includes('teams.microsoft.com')) return 'Teams';
            if (meetingLink.includes('webex.com')) return 'Webex';
            
            return 'Other';
        }

        // Comparaison des r√©unions
        async function compareMeetings() {
            const resultDiv = document.getElementById('comparison-result');
            resultDiv.style.display = 'block';
            
            try {
                // R√©cup√©rer les donn√©es de l'API
                const apiResponse = await fetch('http://localhost:8336/partners/freelancer-meetings?freelancerId=FRE-340255');
                const apiMeetings = apiResponse.ok ? await apiResponse.json() : [];
                
                // R√©cup√©rer les donn√©es du localStorage
                const localMeetings = JSON.parse(localStorage.getItem('freelancerMeetings') || '[]');
                
                let html = '<div class="comparison">';
                
                // Colonne Admin Panel
                html += '<div class="data-column">';
                html += '<h4>üìã Admin Panel (API)</h4>';
                if (apiMeetings.length > 0) {
                    apiMeetings.forEach(meeting => {
                        html += `<div class="meeting-item">
                            <strong>${meeting.subject}</strong><br>
                            üìÖ ${meeting.date} √† ${meeting.startTime}<br>
                            üë§ ${meeting.withWhom}<br>
                            üîó ${meeting.type}
                        </div>`;
                    });
                } else {
                    html += '<div class="meeting-item">Aucune r√©union trouv√©e</div>';
                }
                html += '</div>';
                
                // Colonne Freelancer Space
                html += '<div class="data-column">';
                html += '<h4>üë§ Freelancer Space (localStorage)</h4>';
                if (localMeetings.length > 0) {
                    localMeetings.forEach(meeting => {
                        html += `<div class="meeting-item">
                            <strong>${meeting.title}</strong><br>
                            üìÖ ${meeting.date} √† ${meeting.time}<br>
                            üë§ ${meeting.client}<br>
                            üé• ${meeting.platform}
                        </div>`;
                    });
                } else {
                    html += '<div class="meeting-item">Aucune r√©union en cache</div>';
                }
                html += '</div>';
                
                html += '</div>';
                
                // Analyse
                html += '<div style="margin-top: 20px; padding: 15px; background-color: #fff3cd; border-radius: 8px;">';
                html += '<h4>üìä Analyse:</h4>';
                html += `<p>R√©unions dans Admin Panel: ${apiMeetings.length}</p>`;
                html += `<p>R√©unions dans Freelancer Cache: ${localMeetings.length}</p>`;
                
                const isSync = apiMeetings.length === localMeetings.length;
                html += `<p><strong>Synchronisation: ${isSync ? '‚úÖ OK' : '‚ùå PROBL√àME'}</strong></p>`;
                
                if (!isSync) {
                    html += '<p style="color: red;">‚ö†Ô∏è Les donn√©es ne sont pas synchronis√©es!</p>';
                    html += '<p>Essayez d\'actualiser Freelancer Space ou attendez la synchronisation automatique (30s).</p>';
                }
                
                html += '</div>';
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // V√©rifier localStorage
        function checkLocalStorage() {
            const resultDiv = document.getElementById('storage-result');
            
            try {
                let result = `üîç V√âRIFICATION LOCALSTORAGE:\n\n`;
                
                // V√©rifier freelancerMeetings
                const meetings = JSON.parse(localStorage.getItem('freelancerMeetings') || '[]');
                result += `üìÖ freelancerMeetings: ${meetings.length} r√©unions\n`;
                meetings.forEach((meeting, index) => {
                    result += `   ${index + 1}. ${meeting.title} (${meeting.date})\n`;
                });
                
                result += `\n`;
                
                // V√©rifier session
                const session = localStorage.getItem('freelancer_session');
                result += `üë§ freelancer_session: ${session ? 'Pr√©sente' : 'Absente'}\n`;
                
                if (session) {
                    try {
                        const sessionData = JSON.parse(session);
                        result += `   FreelancerId: ${sessionData.freelancerId || 'Non d√©fini'}\n`;
                    } catch (e) {
                        result += `   Erreur de parsing session\n`;
                    }
                }
                
                result += `\nüíæ TAILLE TOTALE:\n`;
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key) && key.includes('freelancer')) {
                        totalSize += localStorage[key].length;
                        result += `   ${key}: ${localStorage[key].length} caract√®res\n`;
                    }
                }
                result += `   TOTAL: ${totalSize} caract√®res\n`;
                
                showResult(resultDiv, 'info', result);
                
            } catch (error) {
                showResult(resultDiv, 'error', `‚ùå Erreur: ${error.message}`);
            }
        }

        // Vider le cache des r√©unions
        function clearMeetingsCache() {
            if (confirm('√ätes-vous s√ªr de vouloir vider le cache des r√©unions ?')) {
                localStorage.removeItem('freelancerMeetings');
                
                const resultDiv = document.getElementById('storage-result');
                showResult(resultDiv, 'warning', 'üóëÔ∏è Cache des r√©unions vid√©.\n\nLes r√©unions seront recharg√©es depuis l\'API au prochain acc√®s.');
            }
        }

        // Fonction utilitaire
        function showResult(element, type, message) {
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = message;
        }

        // Auto-load
        window.onload = function() {
            console.log('üß™ Meetings Sync Test loaded');
            console.log('üîÑ Testing synchronization between Admin Panel and Freelancer Space');
        };
    </script>
</body>
</html>
