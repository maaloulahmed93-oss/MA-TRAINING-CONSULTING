<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” ØªØ´Ø®ÙŠØµ Ù…Ø³Ø§Ø± Ø§Ù„ÙÙˆØ±Ù…</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        .success { background: #d4edda; padding: 15px; border-radius: 5px; color: #155724; margin: 10px 0; }
        .error { background: #f8d7da; padding: 15px; border-radius: 5px; color: #721c24; margin: 10px 0; }
        .info { background: #d1ecf1; padding: 15px; border-radius: 5px; color: #0c5460; margin: 10px 0; }
        .warning { background: #fff3cd; padding: 15px; border-radius: 5px; color: #856404; margin: 10px 0; }
        button { padding: 12px 24px; margin: 10px 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 10px; max-height: 200px; overflow-y: auto; direction: ltr; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ØªØ´Ø®ÙŠØµ Ù…Ø³Ø§Ø± Ø§Ù„ÙÙˆØ±Ù…</h1>
        <p>ØªØ­Ù„ÙŠÙ„ Ø¹Ù…ÙŠÙ‚ Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙÙˆØ±Ù… Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>

        <div class="info">
            <h3>ğŸ“‹ Ø®Ø·Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ:</h3>
            <ol>
                <li>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø§Ø±Ùƒ Ø£Ø³Ø§Ø³ÙŠ</li>
                <li>Ø¥Ø¶Ø§ÙØ© Formation Ù…Ø¹ Links</li>
                <li>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
                <li>Ù…Ø­Ø§ÙƒØ§Ø© Refresh</li>
            </ol>
        </div>

        <button class="btn-primary" onclick="step1()">1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø§Ø±Ùƒ</button>
        <button class="btn-success" onclick="step2()">2. Ø¥Ø¶Ø§ÙØ© Formation</button>
        <button class="btn-danger" onclick="step3()">3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† DB</button>
        <button class="btn-primary" onclick="step4()">4. Ù…Ø­Ø§ÙƒØ§Ø© Refresh</button>
        <button class="btn-danger" onclick="runAll()">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙ„</button>

        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        const TEST_ID = 'PART-DEBUG-FLOW';

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const time = new Date().toLocaleTimeString();
            results.innerHTML += `<div class="${type}"><strong>[${time}]</strong> ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        async function step1() {
            log('ğŸ”„ Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø§Ø±Ùƒ Ø£Ø³Ø§Ø³ÙŠ...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/participants`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        partnerId: TEST_ID,
                        fullName: 'Ù…Ø´Ø§Ø±Ùƒ ØªØ´Ø®ÙŠØµ',
                        firstName: 'Ù…Ø´Ø§Ø±Ùƒ',
                        lastName: 'ØªØ´Ø®ÙŠØµ',
                        email: 'debug@matc.com',
                        phone: '+216 99 000 000',
                        status: 'active'
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    log('âœ… Ù†Ø¬Ø­ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ', 'success');
                    return true;
                } else {
                    if (result.message && result.message.includes('existe dÃ©jÃ ')) {
                        log('âš ï¸ Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©...', 'warning');
                        return true;
                    } else {
                        log(`âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ: ${result.message}`, 'error');
                        return false;
                    }
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
                return false;
            }
        }

        async function step2() {
            log('ğŸ”„ Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¶Ø§ÙØ© Formation Ù…Ø¹ Links...', 'info');
            
            const data = {
                fullName: 'Ù…Ø´Ø§Ø±Ùƒ ØªØ´Ø®ÙŠØµ',
                email: 'debug@matc.com',
                formations: [{
                    id: 'form-debug',
                    title: 'Formation ØªØ´Ø®ÙŠØµ',
                    description: 'formation Ù„Ù„ØªØ´Ø®ÙŠØµ',
                    domain: 'ØªØ´Ø®ÙŠØµ',
                    level: 'DÃ©butant',
                    duration: '2 Ø³Ø§Ø¹Ø©',
                    status: 'not_started',
                    progress: 0,
                    enrollmentDate: new Date().toISOString(),
                    courses: [],
                    links: [
                        {
                            id: 'link-1',
                            title: 'Ø±Ø§Ø¨Ø· ØªØ´Ø®ÙŠØµ',
                            url: 'https://debug.com',
                            type: 'programme'
                        }
                    ]
                }],
                projects: [],
                coachingResources: [],
                notifications: []
            };

            try {
                log(`ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ PUT Ù…Ø¹ ${data.formations[0].links.length} links...`, 'info');
                
                const response = await fetch(`${API_BASE}/participants/${TEST_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    log('âœ… Ù†Ø¬Ø­ Ø­ÙØ¸ Formation Ù…Ø¹ Links', 'success');
                    return true;
                } else {
                    log(`âŒ ÙØ´Ù„ Ø­ÙØ¸ Formation: ${result.message}`, 'error');
                    if (result.error) {
                        log(`ğŸ” ØªÙØ§ØµÙŠÙ„: ${result.error}`, 'error');
                    }
                    return false;
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
                return false;
            }
        }

        async function step3() {
            log('ğŸ”„ Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/participants/${TEST_ID}`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const formations = result.data.formations || [];
                    log(`ğŸ“Š Ø¹Ø¯Ø¯ Formations ÙÙŠ DB: ${formations.length}`, 'info');
                    
                    if (formations.length > 0) {
                        formations.forEach((f, i) => {
                            log(`  Formation ${i+1}: ${f.title}`, 'info');
                            log(`    Links: ${f.links?.length || 0}`, 'info');
                        });
                        log('âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
                        return true;
                    } else {
                        log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ formations ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                        return false;
                    }
                } else {
                    log(`âŒ ÙØ´Ù„ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${result.message}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
                return false;
            }
        }

        async function step4() {
            log('ğŸ”„ Ø§Ù„Ø®Ø·ÙˆØ© 4: Ù…Ø­Ø§ÙƒØ§Ø© Refresh...', 'info');
            log('â³ Ø§Ù†ØªØ¸Ø§Ø± 2 Ø«Ø§Ù†ÙŠØ©...', 'info');
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            try {
                const response = await fetch(`${API_BASE}/participants/${TEST_ID}`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const formations = result.data.formations || [];
                    log(`ğŸ“Š Ø¨Ø¹Ø¯ Refresh: ${formations.length} formations`, 'info');
                    
                    if (formations.length > 0) {
                        log('ğŸ‰ Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù‚ÙŠØ© Ø¨Ø¹Ø¯ Refresh!', 'success');
                        log('âœ… Ø§Ù„ÙÙˆØ±Ù… ÙŠØ¹Ù…Ù„ ØµØ­ÙŠØ­', 'success');
                        return true;
                    } else {
                        log('âŒ ÙØ´Ù„: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø®ØªÙØª Ø¨Ø¹Ø¯ Refresh', 'error');
                        log('ğŸš¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§ ØªØ­ÙØ¸ ØµØ­ÙŠØ­', 'error');
                        return false;
                    }
                } else {
                    log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${result.message}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
                return false;
            }
        }

        async function runAll() {
            log('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø´Ø§Ù…Ù„...', 'info');
            
            const s1 = await step1();
            if (!s1) { log('âŒ ØªÙˆÙ‚Ù: ÙØ´Ù„ Ø§Ù„Ø®Ø·ÙˆØ© 1', 'error'); return; }
            
            await new Promise(r => setTimeout(r, 1000));
            const s2 = await step2();
            if (!s2) { log('âŒ ØªÙˆÙ‚Ù: ÙØ´Ù„ Ø§Ù„Ø®Ø·ÙˆØ© 2', 'error'); return; }
            
            await new Promise(r => setTimeout(r, 1000));
            const s3 = await step3();
            if (!s3) { log('âŒ ØªÙˆÙ‚Ù: ÙØ´Ù„ Ø§Ù„Ø®Ø·ÙˆØ© 3', 'error'); return; }
            
            await new Promise(r => setTimeout(r, 1000));
            await step4();
        }

        window.addEventListener('load', () => {
            log('ğŸš€ Ø£Ø¯Ø§Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ Ø¬Ø§Ù‡Ø²Ø©', 'success');
            log('ğŸ¯ Ø§Ù„Ù‡Ø¯Ù: Ù…Ø¹Ø±ÙØ© Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'info');
        });
    </script>
</body>
</html>
