<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATC - Analyse d'Int√©gration Espace Participant</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .section {
            padding: 30px;
            border-bottom: 1px solid #e2e8f0;
        }
        .section:last-child {
            border-bottom: none;
        }
        .section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .test-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
        }
        .test-card h3 {
            margin-top: 0;
            color: #4a5568;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status.success { background: #c6f6d5; color: #22543d; }
        .status.warning { background: #fef5e7; color: #c05621; }
        .status.error { background: #fed7d7; color: #c53030; }
        .status.info { background: #bee3f8; color: #2c5282; }
        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover { background: #3182ce; }
        .btn.danger { background: #e53e3e; }
        .btn.danger:hover { background: #c53030; }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 6px;
            border-left: 4px solid #4299e1;
        }
        .field-mapping {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
        }
        .arrow {
            color: #4299e1;
            font-weight: bold;
        }
        .compatibility-score {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        .score-excellent { color: #38a169; }
        .score-good { color: #3182ce; }
        .score-warning { color: #d69e2e; }
        .score-poor { color: #e53e3e; }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        .icon {
            width: 20px;
            height: 20px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Analyse d'Int√©gration - Espace Participant MATC</h1>
            <p>V√©rification de la synchronisation entre Admin Panel et Espace Participant</p>
        </div>

        <div class="section">
            <h2>
                <span class="icon">üéØ</span>
                Score de Compatibilit√© Global
            </h2>
            <div id="compatibilityScore" class="compatibility-score">
                Calcul en cours...
            </div>
            <div id="scoreDetails"></div>
        </div>

        <div class="section">
            <h2>
                <span class="icon">üîÑ</span>
                Mapping des Champs de Donn√©es
            </h2>
            <div id="fieldMapping"></div>
        </div>

        <div class="section">
            <h2>
                <span class="icon">üß™</span>
                Tests d'Int√©gration
            </h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>üîå Connectivit√© Backend</h3>
                    <button class="btn" onclick="testBackendConnectivity()">Tester la Connectivit√©</button>
                    <div id="backendResults" class="results" style="display:none;"></div>
                </div>

                <div class="test-card">
                    <h3>üë§ Authentification Participant</h3>
                    <input type="text" id="participantId" placeholder="ID Participant (ex: PART-123456)" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #e2e8f0; border-radius: 4px;">
                    <button class="btn" onclick="testParticipantAuth()">Tester l'Authentification</button>
                    <div id="authResults" class="results" style="display:none;"></div>
                </div>

                <div class="test-card">
                    <h3>üìö Synchronisation Formations</h3>
                    <button class="btn" onclick="testFormationsSync()">Tester les Formations</button>
                    <div id="formationsResults" class="results" style="display:none;"></div>
                </div>

                <div class="test-card">
                    <h3>üìã Synchronisation Projets</h3>
                    <button class="btn" onclick="testProjectsSync()">Tester les Projets</button>
                    <div id="projectsResults" class="results" style="display:none;"></div>
                </div>

                <div class="test-card">
                    <h3>üéØ Ressources Coaching</h3>
                    <button class="btn" onclick="testResourcesSync()">Tester les Ressources</button>
                    <div id="resourcesResults" class="results" style="display:none;"></div>
                </div>

                <div class="test-card">
                    <h3>üîî Notifications</h3>
                    <button class="btn" onclick="testNotificationsSync()">Tester les Notifications</button>
                    <div id="notificationsResults" class="results" style="display:none;"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>
                <span class="icon">‚ö†Ô∏è</span>
                Inconsistances D√©tect√©es
            </h2>
            <div id="inconsistencies"></div>
        </div>

        <div class="section">
            <h2>
                <span class="icon">üõ†Ô∏è</span>
                Plan d'Action Recommand√©
            </h2>
            <div id="actionPlan"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        const ADMIN_BASE = 'http://localhost:8536';
        const PARTICIPANT_BASE = 'http://localhost:5173';

        let testResults = {
            backend: null,
            auth: null,
            formations: null,
            projects: null,
            resources: null,
            notifications: null
        };

        // Initialize analysis
        document.addEventListener('DOMContentLoaded', function() {
            generateFieldMapping();
            detectInconsistencies();
            generateActionPlan();
        });

        function generateFieldMapping() {
            const mappings = [
                {
                    admin: 'participant.fullName',
                    backend: 'Partner.fullName',
                    participant: 'participant.name / participant.fullName',
                    status: 'success'
                },
                {
                    admin: 'participant.formations[]',
                    backend: 'ParticipantFormation[]',
                    participant: 'participant.formations[]',
                    status: 'success'
                },
                {
                    admin: 'participant.projects[]',
                    backend: 'ParticipantProject[]',
                    participant: 'participant.projects[]',
                    status: 'success'
                },
                {
                    admin: 'participant.coachingResources[]',
                    backend: 'ParticipantResource[]',
                    participant: 'participant.coachingResources[]',
                    status: 'warning'
                },
                {
                    admin: 'participant.notifications[]',
                    backend: 'ParticipantNotification[]',
                    participant: 'participant.notifications[]',
                    status: 'success'
                },
                {
                    admin: 'participant.totalProgress',
                    backend: 'calculated from formations',
                    participant: 'participant.totalProgress',
                    status: 'success'
                },
                {
                    admin: 'participant.status',
                    backend: 'Partner.description.status',
                    participant: 'participant.status',
                    status: 'warning'
                }
            ];

            const container = document.getElementById('fieldMapping');
            container.innerHTML = mappings.map(mapping => `
                <div class="field-mapping">
                    <div><strong>Admin:</strong> ${mapping.admin}</div>
                    <div class="arrow">‚ÜîÔ∏è</div>
                    <div><strong>Backend:</strong> ${mapping.backend}</div>
                    <div class="arrow">‚ÜîÔ∏è</div>
                    <div><strong>Participant:</strong> ${mapping.participant}</div>
                    <div><span class="status ${mapping.status}">${mapping.status}</span></div>
                </div>
            `).join('');
        }

        async function testBackendConnectivity() {
            const resultsDiv = document.getElementById('backendResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div>üîÑ Test en cours...</div>';

            try {
                // Test participants endpoint
                const participantsResponse = await fetch(`${API_BASE}/participants`);
                const participantsOk = participantsResponse.ok;

                // Test a specific participant
                const testParticipantResponse = await fetch(`${API_BASE}/participants/PART-653876`);
                const testParticipantOk = testParticipantResponse.ok;

                testResults.backend = {
                    participantsEndpoint: participantsOk,
                    specificParticipant: testParticipantOk,
                    status: participantsOk && testParticipantOk ? 'success' : 'error'
                };

                resultsDiv.innerHTML = `
                    <div><span class="status ${testResults.backend.status}">${testResults.backend.status}</span></div>
                    <div>‚úÖ Endpoint /participants: ${participantsOk ? 'OK' : 'ERREUR'}</div>
                    <div>‚úÖ Participant sp√©cifique: ${testParticipantOk ? 'OK' : 'ERREUR'}</div>
                `;
            } catch (error) {
                testResults.backend = { status: 'error', error: error.message };
                resultsDiv.innerHTML = `
                    <div><span class="status error">error</span></div>
                    <div>‚ùå Erreur: ${error.message}</div>
                `;
            }

            updateCompatibilityScore();
        }

        async function testParticipantAuth() {
            const participantId = document.getElementById('participantId').value || 'PART-653876';
            const resultsDiv = document.getElementById('authResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div>üîÑ Test d\'authentification en cours...</div>';

            try {
                // Test login endpoint
                const loginResponse = await fetch(`${API_BASE}/participants/${participantId}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const loginData = loginResponse.ok ? await loginResponse.json() : null;

                // Test participant data retrieval
                const dataResponse = await fetch(`${API_BASE}/participants/${participantId}`);
                const participantData = dataResponse.ok ? await dataResponse.json() : null;

                testResults.auth = {
                    login: loginResponse.ok,
                    dataRetrieval: dataResponse.ok,
                    participantExists: !!participantData?.data,
                    status: loginResponse.ok && dataResponse.ok ? 'success' : 'error'
                };

                resultsDiv.innerHTML = `
                    <div><span class="status ${testResults.auth.status}">${testResults.auth.status}</span></div>
                    <div>üîê Login: ${loginResponse.ok ? 'OK' : 'ERREUR'}</div>
                    <div>üìä R√©cup√©ration donn√©es: ${dataResponse.ok ? 'OK' : 'ERREUR'}</div>
                    <div>üë§ Participant existe: ${testResults.auth.participantExists ? 'OUI' : 'NON'}</div>
                    ${participantData?.data ? `<div>üìù Nom: ${participantData.data.fullName}</div>` : ''}
                `;
            } catch (error) {
                testResults.auth = { status: 'error', error: error.message };
                resultsDiv.innerHTML = `
                    <div><span class="status error">error</span></div>
                    <div>‚ùå Erreur: ${error.message}</div>
                `;
            }

            updateCompatibilityScore();
        }

        async function testFormationsSync() {
            const participantId = document.getElementById('participantId').value || 'PART-653876';
            const resultsDiv = document.getElementById('formationsResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div>üîÑ Test des formations en cours...</div>';

            try {
                // Get formations from participant endpoint
                const participantResponse = await fetch(`${API_BASE}/participants/${participantId}`);
                const participantData = participantResponse.ok ? await participantResponse.json() : null;

                // Get formations from dedicated endpoint
                const formationsResponse = await fetch(`${API_BASE}/participants/${participantId}/formations`);
                const formationsData = formationsResponse.ok ? await formationsResponse.json() : null;

                const participantFormations = participantData?.data?.formations || [];
                const dedicatedFormations = formationsData?.data || [];

                testResults.formations = {
                    participantEndpoint: participantResponse.ok,
                    formationsEndpoint: formationsResponse.ok,
                    participantCount: participantFormations.length,
                    dedicatedCount: dedicatedFormations.length,
                    synchronized: participantFormations.length === dedicatedFormations.length,
                    status: participantResponse.ok && formationsResponse.ok ? 'success' : 'error'
                };

                resultsDiv.innerHTML = `
                    <div><span class="status ${testResults.formations.status}">${testResults.formations.status}</span></div>
                    <div>üìö Formations (participant): ${testResults.formations.participantCount}</div>
                    <div>üìö Formations (d√©di√©): ${testResults.formations.dedicatedCount}</div>
                    <div>üîÑ Synchronis√©: ${testResults.formations.synchronized ? 'OUI' : 'NON'}</div>
                `;
            } catch (error) {
                testResults.formations = { status: 'error', error: error.message };
                resultsDiv.innerHTML = `
                    <div><span class="status error">error</span></div>
                    <div>‚ùå Erreur: ${error.message}</div>
                `;
            }

            updateCompatibilityScore();
        }

        async function testProjectsSync() {
            const participantId = document.getElementById('participantId').value || 'PART-653876';
            const resultsDiv = document.getElementById('projectsResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div>üîÑ Test des projets en cours...</div>';

            try {
                const participantResponse = await fetch(`${API_BASE}/participants/${participantId}`);
                const participantData = participantResponse.ok ? await participantResponse.json() : null;

                const projectsResponse = await fetch(`${API_BASE}/participants/${participantId}/projects`);
                const projectsData = projectsResponse.ok ? await projectsResponse.json() : null;

                const participantProjects = participantData?.data?.projects || [];
                const dedicatedProjects = projectsData?.data || [];

                testResults.projects = {
                    participantEndpoint: participantResponse.ok,
                    projectsEndpoint: projectsResponse.ok,
                    participantCount: participantProjects.length,
                    dedicatedCount: dedicatedProjects.length,
                    synchronized: participantProjects.length === dedicatedProjects.length,
                    status: participantResponse.ok && projectsResponse.ok ? 'success' : 'error'
                };

                resultsDiv.innerHTML = `
                    <div><span class="status ${testResults.projects.status}">${testResults.projects.status}</span></div>
                    <div>üìã Projets (participant): ${testResults.projects.participantCount}</div>
                    <div>üìã Projets (d√©di√©): ${testResults.projects.dedicatedCount}</div>
                    <div>üîÑ Synchronis√©: ${testResults.projects.synchronized ? 'OUI' : 'NON'}</div>
                `;
            } catch (error) {
                testResults.projects = { status: 'error', error: error.message };
                resultsDiv.innerHTML = `
                    <div><span class="status error">error</span></div>
                    <div>‚ùå Erreur: ${error.message}</div>
                `;
            }

            updateCompatibilityScore();
        }

        async function testResourcesSync() {
            const participantId = document.getElementById('participantId').value || 'PART-653876';
            const resultsDiv = document.getElementById('resourcesResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div>üîÑ Test des ressources en cours...</div>';

            try {
                const participantResponse = await fetch(`${API_BASE}/participants/${participantId}`);
                const participantData = participantResponse.ok ? await participantResponse.json() : null;

                const resourcesResponse = await fetch(`${API_BASE}/participants/${participantId}/resources`);
                const resourcesData = resourcesResponse.ok ? await resourcesResponse.json() : null;

                const participantResources = participantData?.data?.coachingResources || [];
                const dedicatedResources = resourcesData?.data || [];

                testResults.resources = {
                    participantEndpoint: participantResponse.ok,
                    resourcesEndpoint: resourcesResponse.ok,
                    participantCount: participantResources.length,
                    dedicatedCount: dedicatedResources.length,
                    synchronized: participantResources.length === dedicatedResources.length,
                    status: participantResponse.ok && resourcesResponse.ok ? 'success' : 'error'
                };

                resultsDiv.innerHTML = `
                    <div><span class="status ${testResults.resources.status}">${testResults.resources.status}</span></div>
                    <div>üéØ Ressources (participant): ${testResults.resources.participantCount}</div>
                    <div>üéØ Ressources (d√©di√©): ${testResults.resources.dedicatedCount}</div>
                    <div>üîÑ Synchronis√©: ${testResults.resources.synchronized ? 'OUI' : 'NON'}</div>
                `;
            } catch (error) {
                testResults.resources = { status: 'error', error: error.message };
                resultsDiv.innerHTML = `
                    <div><span class="status error">error</span></div>
                    <div>‚ùå Erreur: ${error.message}</div>
                `;
            }

            updateCompatibilityScore();
        }

        async function testNotificationsSync() {
            const participantId = document.getElementById('participantId').value || 'PART-653876';
            const resultsDiv = document.getElementById('notificationsResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div>üîÑ Test des notifications en cours...</div>';

            try {
                const participantResponse = await fetch(`${API_BASE}/participants/${participantId}`);
                const participantData = participantResponse.ok ? await participantResponse.json() : null;

                const notificationsResponse = await fetch(`${API_BASE}/participants/${participantId}/notifications`);
                const notificationsData = notificationsResponse.ok ? await notificationsResponse.json() : null;

                const participantNotifications = participantData?.data?.notifications || [];
                const dedicatedNotifications = notificationsData?.data || [];

                testResults.notifications = {
                    participantEndpoint: participantResponse.ok,
                    notificationsEndpoint: notificationsResponse.ok,
                    participantCount: participantNotifications.length,
                    dedicatedCount: dedicatedNotifications.length,
                    synchronized: participantNotifications.length === dedicatedNotifications.length,
                    status: participantResponse.ok && notificationsResponse.ok ? 'success' : 'error'
                };

                resultsDiv.innerHTML = `
                    <div><span class="status ${testResults.notifications.status}">${testResults.notifications.status}</span></div>
                    <div>üîî Notifications (participant): ${testResults.notifications.participantCount}</div>
                    <div>üîî Notifications (d√©di√©): ${testResults.notifications.dedicatedCount}</div>
                    <div>üîÑ Synchronis√©: ${testResults.notifications.synchronized ? 'OUI' : 'NON'}</div>
                `;
            } catch (error) {
                testResults.notifications = { status: 'error', error: error.message };
                resultsDiv.innerHTML = `
                    <div><span class="status error">error</span></div>
                    <div>‚ùå Erreur: ${error.message}</div>
                `;
            }

            updateCompatibilityScore();
        }

        function updateCompatibilityScore() {
            const results = Object.values(testResults).filter(r => r !== null);
            if (results.length === 0) return;

            const successCount = results.filter(r => r.status === 'success').length;
            const totalCount = results.length;
            const score = Math.round((successCount / totalCount) * 100);

            const scoreElement = document.getElementById('compatibilityScore');
            const detailsElement = document.getElementById('scoreDetails');

            let scoreClass = 'score-poor';
            let scoreText = 'Critique';
            
            if (score >= 90) {
                scoreClass = 'score-excellent';
                scoreText = 'Excellent';
            } else if (score >= 75) {
                scoreClass = 'score-good';
                scoreText = 'Bon';
            } else if (score >= 50) {
                scoreClass = 'score-warning';
                scoreText = 'Moyen';
            }

            scoreElement.className = `compatibility-score ${scoreClass}`;
            scoreElement.textContent = `${score}%`;

            detailsElement.innerHTML = `
                <div style="text-align: center;">
                    <div><strong>√âvaluation: ${scoreText}</strong></div>
                    <div>${successCount}/${totalCount} tests r√©ussis</div>
                </div>
            `;
        }

        function detectInconsistencies() {
            const inconsistencies = [
                {
                    type: 'Schema Mismatch',
                    description: 'Le champ status est stock√© dans Partner.description (JSON) au lieu d\'un champ d√©di√©',
                    severity: 'warning',
                    impact: 'Filtrage et recherche complexes'
                },
                {
                    type: 'Data Transformation',
                    description: 'Les ressources coaching n√©cessitent une transformation entre backend et frontend',
                    severity: 'warning',
                    impact: 'Complexit√© de maintenance'
                },
                {
                    type: 'API Duplication',
                    description: 'Donn√©es disponibles via /participants/:id ET /participants/:id/formations',
                    severity: 'info',
                    impact: 'Redondance mais flexibilit√©'
                },
                {
                    type: 'Type Safety',
                    description: 'Types TypeScript diff√©rents entre admin panel et participant space',
                    severity: 'warning',
                    impact: 'Erreurs potentielles √† l\'ex√©cution'
                }
            ];

            const container = document.getElementById('inconsistencies');
            container.innerHTML = inconsistencies.map(inc => `
                <div style="margin: 15px 0; padding: 15px; border-left: 4px solid ${
                    inc.severity === 'error' ? '#e53e3e' : 
                    inc.severity === 'warning' ? '#d69e2e' : '#4299e1'
                }; background: #f7fafc;">
                    <div><strong>${inc.type}</strong> <span class="status ${inc.severity}">${inc.severity}</span></div>
                    <div style="margin: 5px 0;">${inc.description}</div>
                    <div style="font-size: 12px; color: #666;">Impact: ${inc.impact}</div>
                </div>
            `).join('');
        }

        function generateActionPlan() {
            const actions = [
                {
                    priority: 'High',
                    title: 'Unifier les Types TypeScript',
                    description: 'Cr√©er des types partag√©s entre admin panel et participant space',
                    files: ['src/types/shared.ts', 'admin-panel/src/types/shared.ts'],
                    effort: '2-3 jours'
                },
                {
                    priority: 'Medium',
                    title: 'Optimiser le Schema Partner',
                    description: 'Extraire les champs participant du JSON description vers des champs d√©di√©s',
                    files: ['backend/models/Partner.js', 'backend/routes/participants.js'],
                    effort: '1-2 jours'
                },
                {
                    priority: 'Medium',
                    title: 'Standardiser la Transformation des Donn√©es',
                    description: 'Cr√©er des transformers coh√©rents pour les ressources coaching',
                    files: ['backend/routes/participants.js', 'src/services/participantApiService.ts'],
                    effort: '1 jour'
                },
                {
                    priority: 'Low',
                    title: 'Am√©liorer la Gestion d\'Erreurs',
                    description: 'Ajouter une gestion d\'erreurs plus robuste avec fallbacks',
                    files: ['admin-panel/src/services/participantsService.ts', 'src/services/participantApiService.ts'],
                    effort: '1 jour'
                },
                {
                    priority: 'Low',
                    title: 'Optimiser les Requ√™tes API',
                    description: 'R√©duire les appels redondants en utilisant les donn√©es d√©j√† charg√©es',
                    files: ['backend/routes/participants.js'],
                    effort: '0.5 jour'
                }
            ];

            const container = document.getElementById('actionPlan');
            container.innerHTML = actions.map(action => `
                <div style="margin: 20px 0; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; background: white;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0; color: #2d3748;">${action.title}</h3>
                        <span class="status ${action.priority.toLowerCase() === 'high' ? 'error' : action.priority.toLowerCase() === 'medium' ? 'warning' : 'info'}">${action.priority}</span>
                    </div>
                    <p style="margin: 10px 0; color: #4a5568;">${action.description}</p>
                    <div style="font-size: 12px; color: #666;">
                        <div><strong>Fichiers:</strong> ${action.files.join(', ')}</div>
                        <div><strong>Effort estim√©:</strong> ${action.effort}</div>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
