<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Formations - MesFormations.tsx</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f7fa; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .section { padding: 20px; border-bottom: 1px solid #e2e8f0; }
        .section:last-child { border-bottom: none; }
        .test-button { background: #4299e1; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin: 5px; font-weight: 500; }
        .test-button:hover { background: #3182ce; }
        .test-button.success { background: #38a169; }
        .test-button.error { background: #e53e3e; }
        .result { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .success { background: #c6f6d5; border-color: #38a169; color: #22543d; }
        .error { background: #fed7d7; border-color: #e53e3e; color: #c53030; }
        .warning { background: #fef5e7; border-color: #d69e2e; color: #c05621; }
        .info { background: #bee3f8; border-color: #3182ce; color: #2c5282; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .status.online { background: #c6f6d5; color: #22543d; }
        .status.offline { background: #fed7d7; color: #c53030; }
        .formation-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .formation-header { display: flex; justify-content: between; align-items: center; margin-bottom: 10px; }
        .formation-title { font-weight: 600; color: #2d3748; }
        .formation-meta { font-size: 12px; color: #718096; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Test API Formations</h1>
            <p>V√©rification du remplacement Mock Data ‚Üí API dans MesFormations.tsx</p>
        </div>

        <div class="section">
            <h2>üîß Configuration Test</h2>
            <div class="grid">
                <div class="card">
                    <h3>Backend Status</h3>
                    <p>URL: <code>http://localhost:3001/api</code></p>
                    <p>Status: <span id="backend-status" class="status offline">Checking...</span></p>
                    <button class="test-button" onclick="checkBackend()">V√©rifier Backend</button>
                </div>
                <div class="card">
                    <h3>Participant Test</h3>
                    <label>Participant ID:</label>
                    <input type="text" id="participant-id" value="PART-2024-001" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #e2e8f0; border-radius: 4px;">
                    <button class="test-button" onclick="testParticipantExists()">V√©rifier Participant</button>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìö Tests API Formations</h2>
            <div class="grid">
                <div>
                    <h3>Test 1: API Formations Directe</h3>
                    <button class="test-button" onclick="testFormationsAPI()">GET /participants/{id}/formations</button>
                    <div id="formations-api-result" class="result"></div>
                </div>
                <div>
                    <h3>Test 2: Formations via Participant</h3>
                    <button class="test-button" onclick="testParticipantFormations()">GET /participants/{id} ‚Üí formations</button>
                    <div id="participant-formations-result" class="result"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üîÑ Test Transformation Data</h2>
            <button class="test-button" onclick="testDataTransformation()">Tester Transformation API ‚Üí Frontend</button>
            <div id="transformation-result" class="result"></div>
        </div>

        <div class="section">
            <h2>üìä R√©sultats Formations</h2>
            <div id="formations-display"></div>
        </div>

        <div class="section">
            <h2>üö® Console Logs</h2>
            <div id="console-logs" class="result" style="max-height: 200px;"></div>
            <button class="test-button" onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let consoleDiv = document.getElementById('console-logs');
        
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            logToDiv('LOG', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            logToDiv('ERROR', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            logToDiv('WARN', args.join(' '));
        };
        
        function logToDiv(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type}: ${message}\n`;
            consoleDiv.textContent += logEntry;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function clearLogs() {
            consoleDiv.textContent = '';
        }

        // Check backend connectivity
        async function checkBackend() {
            const statusEl = document.getElementById('backend-status');
            statusEl.textContent = 'Checking...';
            statusEl.className = 'status offline';
            
            try {
                const response = await fetch(`${API_BASE}/participants`);
                if (response.ok) {
                    statusEl.textContent = 'Online';
                    statusEl.className = 'status online';
                    console.log('‚úÖ Backend accessible');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                statusEl.textContent = 'Offline';
                statusEl.className = 'status offline';
                console.error('‚ùå Backend inaccessible:', error.message);
            }
        }

        // Test if participant exists
        async function testParticipantExists() {
            const participantId = document.getElementById('participant-id').value;
            
            try {
                console.log(`üîç V√©rification participant: ${participantId}`);
                const response = await fetch(`${API_BASE}/participants/${participantId}`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('‚úÖ Participant trouv√©:', result.data.fullName);
                        return true;
                    } else {
                        console.warn('‚ö†Ô∏è Participant non trouv√© dans la r√©ponse');
                        return false;
                    }
                } else {
                    console.error('‚ùå Erreur HTTP:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erreur r√©seau:', error.message);
                return false;
            }
        }

        // Test formations API directly
        async function testFormationsAPI() {
            const participantId = document.getElementById('participant-id').value;
            const resultDiv = document.getElementById('formations-api-result');
            
            try {
                console.log(`üìö Test API formations directe pour: ${participantId}`);
                const response = await fetch(`${API_BASE}/participants/${participantId}/formations`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üìö Formations API response:', result);
                    
                    if (result.success && Array.isArray(result.data)) {
                        resultDiv.className = 'result success';
                        resultDiv.innerHTML = `
                            <strong>‚úÖ API Formations OK</strong><br>
                            Nombre de formations: ${result.data.length}<br>
                            <pre>${JSON.stringify(result.data, null, 2)}</pre>
                        `;
                        return result.data;
                    } else {
                        resultDiv.className = 'result warning';
                        resultDiv.innerHTML = `
                            <strong>‚ö†Ô∏è API OK mais pas de formations</strong><br>
                            Response: <pre>${JSON.stringify(result, null, 2)}</pre>
                        `;
                        return [];
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Erreur API formations:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>‚ùå Erreur API</strong><br>${error.message}`;
                return null;
            }
        }

        // Test formations via participant data
        async function testParticipantFormations() {
            const participantId = document.getElementById('participant-id').value;
            const resultDiv = document.getElementById('participant-formations-result');
            
            try {
                console.log(`üë§ Test formations via participant data pour: ${participantId}`);
                const response = await fetch(`${API_BASE}/participants/${participantId}`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üë§ Participant data response:', result);
                    
                    if (result.success && result.data) {
                        const formations = result.data.formations || [];
                        resultDiv.className = 'result success';
                        resultDiv.innerHTML = `
                            <strong>‚úÖ Participant Data OK</strong><br>
                            Participant: ${result.data.fullName}<br>
                            Formations dans participant: ${formations.length}<br>
                            <pre>${JSON.stringify(formations, null, 2)}</pre>
                        `;
                        return formations;
                    } else {
                        resultDiv.className = 'result warning';
                        resultDiv.innerHTML = `
                            <strong>‚ö†Ô∏è Participant trouv√© mais pas de formations</strong><br>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        `;
                        return [];
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Erreur participant data:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>‚ùå Erreur API</strong><br>${error.message}`;
                return null;
            }
        }

        // Test data transformation (API ‚Üí Frontend format)
        async function testDataTransformation() {
            const resultDiv = document.getElementById('transformation-result');
            
            // Get formations from API
            const apiFormations = await testFormationsAPI();
            if (!apiFormations || apiFormations.length === 0) {
                resultDiv.className = 'result warning';
                resultDiv.innerHTML = '<strong>‚ö†Ô∏è Pas de formations √† transformer</strong>';
                return;
            }

            try {
                console.log('üîÑ Test transformation API ‚Üí Frontend');
                
                // Simulate the transformation function from MesFormations.tsx
                const transformApiFormation = (apiFormation) => {
                    return {
                        id: apiFormation._id,
                        title: apiFormation.title,
                        description: apiFormation.description,
                        domain: apiFormation.domain,
                        level: apiFormation.level,
                        duration: apiFormation.duration,
                        progress: apiFormation.progress || 0,
                        totalCourses: apiFormation.courses?.length || 0,
                        completedCourses: apiFormation.courses?.filter(course => course.isCompleted).length || 0,
                        courses: apiFormation.courses || [],
                        thumbnail: apiFormation.thumbnail || 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=300&h=200&fit=crop'
                    };
                };

                const transformedFormations = apiFormations.map(transformApiFormation);
                console.log('‚úÖ Formations transform√©es:', transformedFormations);

                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>‚úÖ Transformation r√©ussie</strong><br>
                    ${transformedFormations.length} formations transform√©es<br>
                    <pre>${JSON.stringify(transformedFormations, null, 2)}</pre>
                `;

                // Display formations in UI
                displayFormations(transformedFormations);

            } catch (error) {
                console.error('‚ùå Erreur transformation:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>‚ùå Erreur transformation</strong><br>${error.message}`;
            }
        }

        // Display formations in a nice format
        function displayFormations(formations) {
            const displayDiv = document.getElementById('formations-display');
            
            if (!formations || formations.length === 0) {
                displayDiv.innerHTML = '<p class="warning">Aucune formation √† afficher</p>';
                return;
            }

            let html = '<h3>üìö Formations Transform√©es</h3>';
            formations.forEach((formation, index) => {
                html += `
                    <div class="formation-card">
                        <div class="formation-header">
                            <span class="formation-title">${formation.title}</span>
                            <span class="status online">${formation.level}</span>
                        </div>
                        <p class="formation-meta">
                            üìÇ ${formation.domain} | ‚è±Ô∏è ${formation.duration} | 
                            üìà ${formation.progress}% | üìö ${formation.completedCourses}/${formation.totalCourses} cours
                        </p>
                        <p style="font-size: 14px; color: #4a5568;">${formation.description}</p>
                        <div style="margin-top: 10px;">
                            <img src="${formation.thumbnail}" alt="${formation.title}" 
                                 style="width: 100px; height: 60px; object-fit: cover; border-radius: 4px;">
                        </div>
                    </div>
                `;
            });
            
            displayDiv.innerHTML = html;
        }

        // Auto-run tests on page load
        window.onload = function() {
            console.log('üöÄ D√©marrage des tests API Formations');
            checkBackend();
        };
    </script>
</body>
</html>
