<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار النتائج النهائية</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .test-section {
            padding: 30px;
        }
        .partner-test {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .partner-test.ent-752810 { border-left-color: #28a745; }
        .partner-test.ent-190973 { border-left-color: #dc3545; }
        .partner-id {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }
        button {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .results {
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .result-item {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .success { background: rgba(40, 167, 69, 0.2); color: #28a745; }
        .error { background: rgba(220, 53, 69, 0.2); color: #dc3545; }
        .warning { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .info { background: rgba(23, 162, 184, 0.2); color: #17a2b8; }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .stats-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎉 اختبار النتائج النهائية</h1>
            <p>التحقق من نجاح إصلاح مشكلة عزل البيانات</p>
        </div>
        
        <div class="test-section">
            <div style="text-align: center; margin-bottom: 30px;">
                <button onclick="testBothPartners()" id="test-all-btn">🚀 اختبار شامل للشريكين</button>
                <button onclick="compareResults()" id="compare-btn">📊 مقارنة النتائج</button>
                <button onclick="clearResults()">🧹 مسح النتائج</button>
            </div>
            
            <div class="comparison">
                <div class="partner-test ent-752810">
                    <div class="partner-id">ENT-752810</div>
                    <button onclick="testPartner('ENT-752810')" id="test-752810-btn">اختبار الشريك الأول</button>
                    <div class="results" id="results-752810"></div>
                </div>
                
                <div class="partner-test ent-190973">
                    <div class="partner-id">ENT-190973</div>
                    <button onclick="testPartner('ENT-190973')" id="test-190973-btn">اختبار الشريك الثاني</button>
                    <div class="results" id="results-190973"></div>
                </div>
            </div>
            
            <div id="comparison-results" style="margin-top: 30px;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        
        function addResult(partnerId, message, type = 'info') {
            const resultsDiv = document.getElementById(`results-${partnerId.replace('-', '')}`);
            const div = document.createElement('div');
            div.className = `result-item ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsDiv.appendChild(div);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function apiCall(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                throw error;
            }
        }

        async function testPartner(partnerId) {
            addResult(partnerId, `🔍 اختبار الشريك ${partnerId}...`, 'info');
            const btn = document.getElementById(`test-${partnerId.replace('-', '')}-btn`);
            btn.disabled = true;
            
            try {
                // اختبار الإحصائيات
                addResult(partnerId, '📊 جلب الإحصائيات...', 'info');
                const statsResponse = await apiCall(`/enterprise/${partnerId}/stats`);
                const stats = statsResponse.data;
                
                addResult(partnerId, `📈 إجمالي الفورماسيون: ${stats.totalFormations}`, 
                    stats.totalFormations > 0 ? 'success' : 'warning');
                addResult(partnerId, `📈 إجمالي المشاريع: ${stats.totalProjects}`, 'info');
                addResult(partnerId, `📈 الأحداث القادمة: ${stats.upcomingEvents}`, 'info');
                
                // اختبار الفورماسيون
                addResult(partnerId, '📚 جلب الفورماسيون...', 'info');
                const formationsResponse = await apiCall(`/enterprise/${partnerId}/formations`);
                const formations = formationsResponse.data;
                
                addResult(partnerId, `📋 عدد الفورماسيون: ${formations.length}`, 
                    formations.length > 0 ? 'success' : 'warning');
                
                if (formations.length > 0) {
                    formations.forEach((formation, index) => {
                        const isCorrectPartner = formation.partnerId === partnerId;
                        addResult(partnerId, 
                            `${index + 1}. ${formation.title} (Partner: ${formation.partnerId})`,
                            isCorrectPartner ? 'success' : 'error');
                    });
                } else {
                    addResult(partnerId, 'لا توجد فورماسيون', 'warning');
                }
                
                // اختبار المشاريع
                addResult(partnerId, '🏗️ جلب المشاريع...', 'info');
                const projectsResponse = await apiCall(`/enterprise/${partnerId}/projects`);
                addResult(partnerId, `📋 عدد المشاريع: ${projectsResponse.data.length}`, 'info');
                
                // اختبار الأحداث
                addResult(partnerId, '📅 جلب الأحداث...', 'info');
                const eventsResponse = await apiCall(`/enterprise/${partnerId}/events`);
                addResult(partnerId, `📋 عدد الأحداث: ${eventsResponse.data.length}`, 'info');
                
                addResult(partnerId, '✅ اكتمل الاختبار بنجاح', 'success');
                
                return {
                    partnerId,
                    stats,
                    formations,
                    projects: projectsResponse.data,
                    events: eventsResponse.data
                };
                
            } catch (error) {
                addResult(partnerId, `❌ خطأ: ${error.message}`, 'error');
                return null;
            } finally {
                btn.disabled = false;
            }
        }

        async function testBothPartners() {
            const btn = document.getElementById('test-all-btn');
            btn.disabled = true;
            
            try {
                const results = await Promise.all([
                    testPartner('ENT-752810'),
                    testPartner('ENT-190973')
                ]);
                
                // مقارنة النتائج
                setTimeout(() => {
                    compareResults(results);
                }, 1000);
                
            } catch (error) {
                console.error('خطأ في الاختبار الشامل:', error);
            } finally {
                btn.disabled = false;
            }
        }

        function compareResults(results = null) {
            const comparisonDiv = document.getElementById('comparison-results');
            
            if (!results) {
                comparisonDiv.innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 20px;">
                        <h3>📊 مقارنة النتائج</h3>
                        <p>اضغط "اختبار شامل للشريكين" أولاً لرؤية المقارنة</p>
                    </div>
                `;
                return;
            }
            
            const [result1, result2] = results;
            
            if (!result1 || !result2) {
                comparisonDiv.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #dc3545; border-radius: 8px; padding: 20px;">
                        <h3>❌ خطأ في المقارنة</h3>
                        <p>لم يتم الحصول على نتائج صحيحة من أحد الشريكين</p>
                    </div>
                `;
                return;
            }
            
            // تحليل النتائج
            const isolation = {
                perfect: true,
                issues: []
            };
            
            // فحص الفورماسيون المشتركة
            const formations1 = result1.formations.map(f => f.formationId);
            const formations2 = result2.formations.map(f => f.formationId);
            const sharedFormations = formations1.filter(id => formations2.includes(id));
            
            if (sharedFormations.length > 0) {
                isolation.perfect = false;
                isolation.issues.push(`${sharedFormations.length} فورماسيون مشتركة`);
            }
            
            // فحص partnerId صحيح
            const wrongPartner1 = result1.formations.filter(f => f.partnerId !== result1.partnerId);
            const wrongPartner2 = result2.formations.filter(f => f.partnerId !== result2.partnerId);
            
            if (wrongPartner1.length > 0 || wrongPartner2.length > 0) {
                isolation.perfect = false;
                isolation.issues.push('فورماسيون بـ partnerId خاطئ');
            }
            
            const comparisonHtml = `
                <div style="background: ${isolation.perfect ? '#d4edda' : '#f8d7da'}; 
                           border: 1px solid ${isolation.perfect ? '#28a745' : '#dc3545'}; 
                           border-radius: 8px; padding: 20px;">
                    <h3>${isolation.perfect ? '✅' : '❌'} نتائج المقارنة</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div>
                            <h4>ENT-752810</h4>
                            <p>الفورماسيون: ${result1.formations.length}</p>
                            <p>المشاريع: ${result1.projects.length}</p>
                            <p>الأحداث: ${result1.events.length}</p>
                            <p>الإحصائيات: ${result1.stats.totalFormations} فورماسيون</p>
                        </div>
                        <div>
                            <h4>ENT-190973</h4>
                            <p>الفورماسيون: ${result2.formations.length}</p>
                            <p>المشاريع: ${result2.projects.length}</p>
                            <p>الأحداث: ${result2.events.length}</p>
                            <p>الإحصائيات: ${result2.stats.totalFormations} فورماسيون</p>
                        </div>
                    </div>
                    
                    ${isolation.perfect ? 
                        '<p><strong>🎉 عزل البيانات يعمل بشكل مثالي!</strong></p>' :
                        `<p><strong>⚠️ مشاكل في العزل:</strong> ${isolation.issues.join(', ')}</p>`
                    }
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.1); border-radius: 5px;">
                        <h4>📋 ملخص النتائج:</h4>
                        <ul>
                            <li>فورماسيون مشتركة: ${sharedFormations.length}</li>
                            <li>فورماسيون بـ partnerId خاطئ: ${wrongPartner1.length + wrongPartner2.length}</li>
                            <li>تطابق الإحصائيات: ${result1.stats.totalFormations === result1.formations.length && result2.stats.totalFormations === result2.formations.length ? 'نعم ✅' : 'لا ❌'}</li>
                        </ul>
                    </div>
                </div>
            `;
            
            comparisonDiv.innerHTML = comparisonHtml;
        }

        function clearResults() {
            document.getElementById('results-752810').innerHTML = '';
            document.getElementById('results-190973').innerHTML = '';
            document.getElementById('comparison-results').innerHTML = '';
        }

        // تشغيل تلقائي
        window.onload = function() {
            document.getElementById('comparison-results').innerHTML = `
                <div style="background: #d1ecf1; border: 1px solid #17a2b8; border-radius: 8px; padding: 20px; text-align: center;">
                    <h3>🚀 أداة اختبار النتائج النهائية</h3>
                    <p>اضغط "اختبار شامل للشريكين" لبدء الاختبار والتحقق من نجاح الإصلاح</p>
                    <p><strong>المتوقع:</strong> كل شريك يرى فورماسيون مختلفة مع إحصائيات صحيحة</p>
                </div>
            `;
        };
    </script>
</body>
</html>
