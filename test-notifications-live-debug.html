<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Debug Notifications - MATC</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 5px; margin: 10px 0; }
        button { padding: 12px 20px; margin: 10px 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.success { background: #28a745; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; font-size: 11px; overflow-x: auto; max-height: 300px; }
        .test-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .urgent { background: #ff6b6b; color: white; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Live Debug Notifications - MATC</h1>
        
        <div class="error">
            <h3>‚ùå Probl√®me persistant</h3>
            <p><strong>Status:</strong> Les notifications Admin Panel ne s'affichent toujours pas dans espace participant</p>
            <p><strong>Action:</strong> Debug en temps r√©el pour identifier la cause exacte</p>
        </div>

        <div class="test-grid">
            <div>
                <h3>üîß Tests Backend</h3>
                <button onclick="testBackendStatus()">Status Backend</button>
                <button onclick="testParticipantAPI()">API Participant</button>
                <button onclick="testNotificationsAPI()">API Notifications</button>
                <button onclick="testDirectMongoDB()">Test MongoDB Direct</button>
            </div>
            <div>
                <h3>üéØ Tests Frontend</h3>
                <button onclick="testEspaceParticipantAPI()">Espace Participant API</button>
                <button onclick="simulateNotificationLoad()">Simuler chargement</button>
                <button onclick="testComponentLogic()">Test Component Logic</button>
                <button onclick="checkConsoleErrors()">Check Console Errors</button>
            </div>
        </div>

        <div class="warning">
            <h4>üö® Actions urgentes √† v√©rifier:</h4>
            <ol>
                <li><strong>Red√©marrage Backend:</strong> Le serveur backend a-t-il √©t√© red√©marr√© apr√®s les modifications?</li>
                <li><strong>Cache Browser:</strong> Vider le cache du navigateur</li>
                <li><strong>MongoDB:</strong> Les donn√©es sont-elles r√©ellement sauvegard√©es?</li>
                <li><strong>API Endpoints:</strong> Les nouveaux endpoints fonctionnent-ils?</li>
            </ol>
        </div>

        <button onclick="runUrgentDiagnostic()" class="urgent">üö® DIAGNOSTIC URGENT</button>
        <button onclick="runCompleteDebug()" class="success">üîç Debug Complet</button>

        <div id="results"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            results.appendChild(div);
            console.log(message);
        }

        async function testBackendStatus() {
            log('üîÑ Test status Backend...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/api/participants');
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Backend accessible', 'success');
                    log(`üìä ${data.data?.length || 0} participants trouv√©s`, 'info');
                    
                    // Check if PART-550776 is in the list
                    const targetParticipant = data.data?.find(p => p.id === 'PART-550776' || p.partnerId === 'PART-550776');
                    if (targetParticipant) {
                        log('‚úÖ PART-550776 trouv√© dans la liste', 'success');
                        log(`üîî Notifications dans liste: ${targetParticipant.notifications?.length || 0}`, 
                            targetParticipant.notifications?.length > 0 ? 'success' : 'error');
                    } else {
                        log('‚ùå PART-550776 NON trouv√© dans la liste!', 'error');
                    }
                } else {
                    log(`‚ùå Backend erreur: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Backend inaccessible: ${error.message}`, 'error');
            }
        }

        async function testParticipantAPI() {
            log('üë§ Test API Participant direct...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/api/participants/PART-550776');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        log('‚úÖ Participant API accessible', 'success');
                        log(`üìä Participant: ${data.data.fullName}`, 'info');
                        
                        const notifications = data.data.notifications;
                        log(`üîî Notifications count: ${notifications?.length || 0}`, 
                            notifications?.length > 0 ? 'success' : 'error');
                        
                        if (notifications && notifications.length > 0) {
                            log(`<pre>Notifications trouv√©es:
${JSON.stringify(notifications, null, 2)}</pre>`, 'success');
                        } else {
                            log('‚ùå AUCUNE notification dans API participant!', 'error');
                            log('üí° Cela confirme que le probl√®me est dans le backend', 'warning');
                        }
                    } else {
                        log('‚ùå API participant response invalide', 'error');
                    }
                } else {
                    log(`‚ùå API participant erreur: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur API participant: ${error.message}`, 'error');
            }
        }

        async function testNotificationsAPI() {
            log('üîî Test API Notifications d√©di√©e...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/api/participants/PART-550776/notifications');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        log(`‚úÖ API Notifications: ${data.data.length} trouv√©es`, 
                            data.data.length > 0 ? 'success' : 'error');
                        
                        if (data.data.length > 0) {
                            log(`<pre>API Notifications:
${JSON.stringify(data.data, null, 2)}</pre>`, 'success');
                        } else {
                            log('‚ùå API notifications retourne tableau vide!', 'error');
                        }
                    } else {
                        log('‚ùå API notifications response non successful', 'error');
                    }
                } else {
                    log(`‚ùå API notifications erreur: ${response.status}`, 'error');
                    const errorText = await response.text();
                    log(`‚ùå D√©tails: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur API notifications: ${error.message}`, 'error');
            }
        }

        async function testDirectMongoDB() {
            log('üóÑÔ∏è Test MongoDB direct (via backend logs)...', 'info');
            
            log('üìã Instructions pour v√©rifier MongoDB:', 'warning');
            log('1. Ouvrez terminal backend et v√©rifiez les logs', 'info');
            log('2. Cherchez les messages de type "Found X notifications for PART-550776"', 'info');
            log('3. V√©rifiez si les notifications sont r√©ellement dans MongoDB', 'info');
            
            // Try to trigger backend logs by calling API
            await testParticipantAPI();
        }

        async function testEspaceParticipantAPI() {
            log('üñ•Ô∏è Test Espace Participant API calls...', 'info');
            
            log('üìã Simulation des appels API d\'Espace Participant:', 'info');
            
            // Simulate what Notifications component does
            log('1. Component Notifications appelle getNotifications()...', 'info');
            const apiNotifications = await fetch('http://localhost:3001/api/participants/PART-550776/notifications');
            
            if (apiNotifications.ok) {
                const apiData = await apiNotifications.json();
                log(`‚úÖ getNotifications() retourne: ${apiData.data?.length || 0} notifications`, 'info');
                
                if (apiData.data?.length > 0) {
                    log('2. Conversion des donn√©es API...', 'info');
                    const converted = apiData.data.map(n => ({
                        id: n._id,
                        title: n.title,
                        message: n.message,
                        type: n.type,
                        date: n.date,
                        isRead: n.isRead
                    }));
                    log(`‚úÖ ${converted.length} notifications converties pour affichage`, 'success');
                } else {
                    log('‚ùå Aucune notification √† convertir', 'error');
                }
            } else {
                log('‚ùå getNotifications() √©choue', 'error');
            }
            
            // Fallback test
            log('3. Test fallback vers participant data...', 'info');
            const participantData = await fetch('http://localhost:3001/api/participants/PART-550776');
            if (participantData.ok) {
                const pData = await participantData.json();
                const fallbackNotifications = pData.data?.notifications || [];
                log(`‚úÖ Fallback: ${fallbackNotifications.length} notifications`, 'info');
            }
        }

        async function simulateNotificationLoad() {
            log('üé≠ Simulation compl√®te du chargement notifications...', 'info');
            
            // Exact simulation of Notifications.tsx loadNotifications()
            log('üìã Simulation exacte de loadNotifications():', 'info');
            
            try {
                // Step 1: Try dedicated API
                log('√âtape 1: Appel API d√©di√©e...', 'info');
                const apiResponse = await fetch('http://localhost:3001/api/participants/PART-550776/notifications');
                
                if (apiResponse.ok) {
                    const apiData = await apiResponse.json();
                    if (apiData.success && apiData.data && apiData.data.length > 0) {
                        log(`‚úÖ API d√©di√©e: ${apiData.data.length} notifications`, 'success');
                        log('üéâ Component devrait afficher ces notifications!', 'success');
                        return;
                    }
                }
                
                // Step 2: Fallback to participant data
                log('√âtape 2: Fallback vers participant data...', 'info');
                const participantResponse = await fetch('http://localhost:3001/api/participants/PART-550776');
                
                if (participantResponse.ok) {
                    const participantData = await participantResponse.json();
                    if (participantData.success && participantData.data) {
                        const notifications = participantData.data.notifications;
                        if (notifications && notifications.length > 0) {
                            log(`‚úÖ Fallback: ${notifications.length} notifications`, 'success');
                            log('üéâ Component devrait afficher ces notifications!', 'success');
                        } else {
                            log('‚ùå Fallback: Aucune notification', 'error');
                            log('üîç Component affichera "Aucune notification"', 'warning');
                        }
                    }
                }
            } catch (error) {
                log(`‚ùå Erreur simulation: ${error.message}`, 'error');
            }
        }

        async function testComponentLogic() {
            log('üß© Test logique Component...', 'info');
            
            log('üìã Points √† v√©rifier dans Component Notifications:', 'warning');
            log('1. useEffect appelle loadNotifications() au mount', 'info');
            log('2. loadNotifications() appelle participantApiService.getNotifications()', 'info');
            log('3. Si pas de r√©sultats, fallback vers getParticipant()', 'info');
            log('4. Donn√©es converties et stock√©es dans state', 'info');
            log('5. Component affiche selon filteredNotifications', 'info');
            
            log('üîç V√©rifications console browser:', 'warning');
            log('- Ouvrez DevTools dans espace participant', 'info');
            log('- Cherchez logs "‚úÖ Loaded X notifications from API"', 'info');
            log('- Cherchez erreurs JavaScript', 'info');
        }

        async function checkConsoleErrors() {
            log('üîç Check Console Errors...', 'info');
            
            log('üìã Instructions pour v√©rifier les erreurs:', 'warning');
            log('1. Ouvrez espace participant dans un nouvel onglet', 'info');
            log('2. Ouvrez DevTools (F12)', 'info');
            log('3. Allez √† l\'onglet Console', 'info');
            log('4. Connectez-vous et allez aux notifications', 'info');
            log('5. Cherchez les erreurs en rouge', 'info');
            log('6. Cherchez les logs de chargement des notifications', 'info');
            
            log('üéØ Logs √† chercher:', 'info');
            log('- "‚úÖ Loaded X notifications from API"', 'info');
            log('- "‚úÖ Loaded X notifications from participant data"', 'info');
            log('- "‚ÑπÔ∏è No notifications found for participant"', 'info');
            log('- Erreurs de type "Failed to fetch" ou "Network error"', 'info');
        }

        async function runUrgentDiagnostic() {
            log('üö® DIAGNOSTIC URGENT EN COURS...', 'warning');
            
            // Quick tests to identify the main issue
            log('üîç Test 1: Backend accessible?', 'info');
            const backendTest = await testBackendStatus();
            
            log('üîç Test 2: API Participant fonctionne?', 'info');
            await testParticipantAPI();
            
            log('üîç Test 3: API Notifications fonctionne?', 'info');
            await testNotificationsAPI();
            
            setTimeout(() => {
                log('üö® R√âSUM√â URGENT:', 'error');
                log('üìã Actions imm√©diates √† faire:', 'warning');
                log('1. ‚ö° RED√âMARRER le serveur backend (npm run dev)', 'error');
                log('2. üîÑ VIDER le cache browser (Ctrl+Shift+R)', 'error');
                log('3. üîç V√âRIFIER les logs backend dans terminal', 'error');
                log('4. üìä TESTER avec les boutons ci-dessus', 'error');
            }, 3000);
        }

        async function runCompleteDebug() {
            log('üîç Debug complet en cours...', 'info');
            
            await testBackendStatus();
            await testParticipantAPI();
            await testNotificationsAPI();
            await testEspaceParticipantAPI();
            await simulateNotificationLoad();
            
            setTimeout(() => {
                log('üéØ Debug complet termin√©', 'success');
                log('üìã Consultez tous les r√©sultats ci-dessus', 'info');
                log('üîç Si toutes les APIs retournent 0 notifications, le probl√®me est dans le backend', 'warning');
                log('üîç Si les APIs retournent des notifications mais espace participant est vide, le probl√®me est dans le frontend', 'warning');
            }, 2000);
        }

        // Auto-run urgent diagnostic
        window.onload = function() {
            setTimeout(() => {
                log('üö® PROBL√àME PERSISTANT D√âTECT√â', 'error');
                log('üìã Lancement du diagnostic urgent...', 'warning');
                runUrgentDiagnostic();
            }, 1000);
        };
    </script>
</body>
</html>
